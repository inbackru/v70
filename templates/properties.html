{% extends "base.html" %}
{% set city_slug = current_city.slug if current_city else (session.city_slug if session.city_slug else 'krasnodar') %}

{% block title %}–ö—ç—à–±–µ–∫ –∑–∞ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏ –≤ {{ current_city.name_prepositional if current_city else '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–µ' }} –¥–æ 500 000 ‚ÇΩ | inback{% endblock %}
{% block description %}–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –∫—ç—à–±–µ–∫ 2,5-5% –∑–∞ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫—É? –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–∏—Å–∞ Inback. –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã –≤ {{ current_city.name_prepositional if current_city else '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–µ' }}{% endblock %}
{% block keywords %}–∫–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –∫—ç—à–±–µ–∫ –∑–∞ –∫–≤–∞—Ä—Ç–∏—Ä—É, –∫—ç—à–±–µ–∫ –∑–∞ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫—É, –≤–æ–∑–≤—Ä–∞—Ç –¥–µ–Ω–µ–≥ –∑–∞ –∫–≤–∞—Ä—Ç–∏—Ä—É, —Å–∏—Å—Ç–µ–º–∞ –∫—ç—à–±–µ–∫–∞ inback, –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∫—ç—à–±–µ–∫–∞, —ç—Ç–∞–ø—ã –ø–æ–ª—É—á–µ–Ω–∏—è –∫—ç—à–±–µ–∫–∞{% endblock %}

{% block extra_head %}
<!-- Robots meta -->
<meta name="robots" content="index, follow">
<!-- City ID for JavaScript filters -->
<meta name="city-id" content="{{ current_city.id if current_city else 1 }}">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:url" content="{{ url_for('properties', _external=True) }}">
<meta property="og:title" content="–ö—ç—à–±–µ–∫ –∑–∞ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏ –≤ {{ current_city.name_prepositional if current_city else '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–µ' }} –¥–æ 500 000 ‚ÇΩ | InBack">
<meta property="og:description" content="–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –∫—ç—à–±–µ–∫ 2,5-5% –∑–∞ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫—É? –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–∏—Å–∞ InBack. –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã –≤ {{ current_city.name_prepositional if current_city else '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–µ' }}">
<meta property="og:image" content="{{ url_for('static', filename='images/properties-og.jpg', _external=True) }}">
<meta property="og:site_name" content="InBack">
<meta property="og:locale" content="ru_RU">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:url" content="{{ url_for('properties', _external=True) }}">
<meta name="twitter:title" content="–ö—ç—à–±–µ–∫ –∑–∞ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏ –≤ {{ current_city.name_prepositional if current_city else '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–µ' }} –¥–æ 500 000 ‚ÇΩ | InBack">
<meta name="twitter:description" content="–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç –¥–µ–Ω–µ–≥ –∑–∞ –ø–æ–∫—É–ø–∫—É –∫–≤–∞—Ä—Ç–∏—Ä—ã –≤ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–µ {{ current_city.name_genitive if current_city else '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–∞' }}. –ö—ç—à–±–µ–∫ 2,5-5% –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∂–∏–ª—å—è.">
<meta name="twitter:image" content="{{ url_for('static', filename='images/properties-og.jpg', _external=True) }}">
<!-- ‚ö° –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –∫—ç—à–∞ HTML -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<!-- Canonical URL handled by base.html -->

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "–ì–ª–∞–≤–Ω–∞—è",
      "item": "https://inback.ru"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "–ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏",
      "item": "https://inback.ru/properties"
    }
  ]
}
</script>
<script src="https://api-maps.yandex.ru/2.1/?apikey={{ yandex_maps_api_key }}&lang=ru_RU" type="text/javascript"></script>
<style>
    /* Hide scrollbar for map room filters */
    .overflow-x-auto::-webkit-scrollbar {
        display: none;
    }
    
    /* Mobile-specific styles */
    @media (max-width: 640px) {
        /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª - —Ç–æ–ª—å–∫–æ –¥–ª—è properties page */
        body.properties-page {
            overflow-x: hidden !important;
        }
        
        #properties-container,
        #properties-container * {
            max-width: 100% !important;
        }
        
        /* MOBILE: Sticky search bar (Avito-style) with SuperSearch */
        #mobile-search-bar {
            backdrop-filter: blur(10px);
            background-color: rgba(255, 255, 255, 0.98);
        }
        
        /* Mobile search input (now property-search on mobile) */
        #mobile-search-bar #property-search {
            font-size: 0.875rem !important;
        }
        
        #mobile-search-bar #property-search::placeholder {
            color: #9ca3af !important;
        }
    
        /* MOBILE: –°–∫—Ä—ã—Ç—å —Ç–æ–ª—å–∫–æ hero –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞ –º–æ–±–∞–π–ª–µ */
        #properties-hero {
            display: none !important;
        }
        
        /* MOBILE: –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è search —Å–µ–∫—Ü–∏—è */
        section.py-8.bg-gray-50 {
            padding-top: 0.5rem !important;
            padding-bottom: 0.5rem !important;
        }
        
        /* –ü–æ–∏—Å–∫–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ - –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è (—Ç–æ–ª—å–∫–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ /properties) */
        section.py-8.bg-gray-50 .bg-white.rounded-lg.shadow-md {
            padding: 0.5rem !important;
            margin-bottom: 0.5rem !important;
        }
        
        /* Desktop search input */
        section.py-8.bg-gray-50 #property-search-desktop {
            padding: 0.625rem 0.75rem !important;
            font-size: 0.875rem !important;
        }
        
        /* –°–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç "–ü–æ–∏—Å–∫ —Å –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏" */
        section.py-8.bg-gray-50 .flex .text-sm.text-gray-500 {
            display: none !important;
        }

    
        
        /* MOBILE: –§–∏–ª—å—Ç—Ä—ã –≤ —Å—Ç–∏–ª–µ Avito - –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ —Å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–º —Å–∫—Ä–æ–ª–ª–æ–º */
        section.py-8.bg-gray-50 .filters-container {
            padding: 0.75rem 0 !important;
            border: none !important;
            box-shadow: none !important;
            background: transparent !important;
        }
        
        /* –°–ö–†–´–í–ê–ï–ú –Ω–∞–¥–ø–∏—Å—å "–ë—ã—Å—Ç—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã" –Ω–∞ –º–æ–±–∞–π–ª–µ */
        section.py-8.bg-gray-50 .filters-container > div > .text-gray-600.whitespace-nowrap.font-medium {
            display: none !important;
        }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ñ–∏–ª—å—Ç—Ä–æ–≤ - –ë–ï–ó —Å–∫—Ä–æ–ª–ª–∞, flex-wrap –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ */
        section.py-8.bg-gray-50 .filters-container > div {
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 0.5rem !important;
            padding: 0 1rem !important;
            width: 100% !important;
            max-width: 100vw !important;
            box-sizing: border-box !important;
        }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –∫–Ω–æ–ø–∫–∞–º–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
        section.py-8.bg-gray-50 .filters-container > div > div {
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 0.5rem !important;
            width: 100% !important;
        }
        
        /* –°–∫—Ä—ã–≤–∞–µ–º –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫ –∏ —Å–¥–∞—á—É –Ω–∞ –º–æ–±–∞–π–ª–µ - –æ–Ω–∏ –±—É–¥—É—Ç –≤ "–ï—â—ë" */
        section.py-8.bg-gray-50 .dropdown[data-filter="developers"],
        section.py-8.bg-gray-50 .dropdown[data-filter="completion"] {
            display: none !important;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ "–ï—â—ë" - —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */
        section.py-8.bg-gray-50 #advancedFiltersToggle {
            flex: 0 0 auto !important;
        }
        
        /* –ö–Ω–æ–ø–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ - —Å—Ç–∏–ª—å Avito */
        section.py-8.bg-gray-50 .dropdown-btn {
            font-size: 0.875rem !important;
            padding: 0.75rem 1rem !important;
            border-radius: 0 !important;
            border: none !important;
            background: white !important;
            white-space: nowrap !important;
            font-weight: 400 !important;
            transition: all 0.2s !important;
            color: #374151 !important;
        }
        
        section.py-8.bg-gray-50 .dropdown-btn:active {
            background: #F3F4F6 !important;
            transform: scale(0.98) !important;
        }
        
        /* –ê–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã - –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –¥–∏–∑–∞–π–Ω –Ω–∞ –º–æ–±–∞–π–ª–µ */
        section.py-8.bg-gray-50 #active-filters-container {
            padding: 0.5rem !important;
            margin-top: 0.75rem !important;
            border-radius: 0.5rem !important;
        }
        
        section.py-8.bg-gray-50 #active-filters-container .text-sm {
            font-size: 0.75rem !important;
        }
        
        section.py-8.bg-gray-50 #active-filters-container #active-filters-list {
            gap: 0.375rem !important;
        }
        
        /* –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–∫–∞–∑ –ø—É—Å—Ç—ã—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ –Ω–∞ –º–æ–±–∞–π–ª–µ */
        section.py-8.bg-gray-50 #active-filters-container.hidden {
            display: none !important;
        }
        
        /* –ö–†–ò–¢–ò–ß–ù–û: –°–∫—Ä—ã–≤–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –∫–æ–≥–¥–∞ –æ–Ω–∏ –∑–∞–∫—Ä—ã—Ç—ã */
        section.py-8.bg-gray-50 #advancedFiltersPanel.hidden {
            display: none !important;
        }
        
        /* –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã - –∫–æ–Ω—Ç–µ–Ω—Ç –≤–Ω—É—Ç—Ä–∏ –ø–∞–Ω–µ–ª–∏ */
        section.py-8.bg-gray-50 #advancedFiltersPanel:not(.hidden) .grid {
            grid-template-columns: 1fr !important;
            gap: 1rem !important;
        }
        
        section.py-8.bg-gray-50 #advancedFiltersPanel:not(.hidden) .p-6 {
            padding: 1rem !important;
        }
        
        section.py-8.bg-gray-50 #advancedFiltersPanel:not(.hidden) h4 {
            font-size: 0.875rem !important;
        }
        
        section.py-8.bg-gray-50 #advancedFiltersPanel:not(.hidden) label {
            font-size: 0.8125rem !important;
        }
        
        section.py-8.bg-gray-50 #advancedFiltersPanel:not(.hidden) input,
        section.py-8.bg-gray-50 #advancedFiltersPanel:not(.hidden) select {
            font-size: 0.875rem !important;
            padding: 0.5rem !important;
        }
        
        /* –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã - –í–°–ï–ì–î–ê –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º –Ω–∞ –º–æ–±–∞–π–ª–µ */
        section.py-8.bg-gray-50 #advancedFiltersPanel:not(.hidden) {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            z-index: 10000 !important;
            margin: 0 !important;
            border-radius: 0 !important;
            max-height: 100vh !important;
            display: flex !important;
            flex-direction: column !important;
            background: white !important;
        }
        
        /* –£–±–∏—Ä–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è –Ω–∞ –º–æ–±–∞–π–ª–µ */
        section.py-8.bg-gray-50 #closeAdvancedFilters {
            display: none !important;
        }
        
        /* Dropdown –º–µ–Ω—é –Ω–∞ –º–æ–±–∞–π–ª–µ - –≤—ã—Å–æ–∫–∏–π z-index */
        section.py-8.bg-gray-50 .dropdown-menu {
            max-height: 300px;
            overflow-y: auto;
            font-size: 0.75rem !important;
            z-index: 9999 !important;
            position: absolute !important;
        }
        
        /* –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —á—Ç–æ –∫–Ω–æ–ø–∫–∏ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã */
        section.py-8.bg-gray-50 .dropdown {
            position: relative !important;
            z-index: 10 !important;
        }
        
        section.py-8.bg-gray-50 .dropdown-btn {
            pointer-events: auto !important;
            cursor: pointer !important;
            position: relative !important;
            z-index: 10 !important;
        }
        
        section.py-8.bg-gray-50 .dropdown-item {
            padding: 0.5rem !important;
            font-size: 0.75rem !important;
        }
        
        /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ –ø–æ–ª—è —Ü–µ–Ω—ã */
        section.py-8.bg-gray-50 #priceFrom,
        section.py-8.bg-gray-50 #priceTo {
            font-size: 0.75rem !important;
            padding: 0.375rem !important;
        }

        
        
        /* MOBILE: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã - —É–±–∏—Ä–∞–µ–º –Ω–∞–µ–∑–∂–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
        #propertiesMapContainer {
            position: relative !important;
            z-index: 1 !important;
            width: 100% !important;
            margin: 0.5rem 0 !important;
        }
        
        #propertiesMap {
            height: 350px !important;
            width: 100% !important;
            position: relative !important;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞—Ä—Ç—ã */
        #mapToggleBtn {
            width: 100% !important;
            justify-content: center !important;
            text-align: center !important;
        }
        
        /* –£–±–∏—Ä–∞–µ–º overflow –ø—Ä–æ–±–ª–µ–º—ã */
        #properties-container,
        .properties-list-container {
            overflow-x: hidden !important;
            width: 100% !important;
        }

        
        /* –ö–†–ò–¢–ò–ß–ù–û: –ö–∞—Ä—Ç–æ—á–∫–∏ –æ–±—ä–µ–∫—Ç–æ–≤ - –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π layout –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        .property-card {
            margin-bottom: 12px;
            flex-direction: column !important;
        }
        
        .property-card > div:first-child {
            width: 100% !important;
            height: 200px !important;
        }
        
        .property-card .carousel-container {
            height: 200px !important;
        }
        
        .property-card .carousel {
            height: 200px;
        }
        
        .property-card .carousel-item img {
            height: 200px;
            object-fit: cover;
            background: #f8f9fa;
        }
        
        .property-card .carousel-controls {
            display: none;
        }
        
        /* –ö–æ–Ω—Ç–µ–Ω—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ */
        .property-card > div:last-child {
            padding: 1rem !important;
        }
        
        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ä—Ç–æ—á–∫–∏ */
        .property-card h2 {
            font-size: 1.125rem !important;
            margin-bottom: 0.5rem !important;
        }
        
        /* –¢–µ–≥–∏ */
        .property-card .flex.gap-2 {
            flex-wrap: wrap;
        }
        
        /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
        .property-card .flex.gap-2 button,
        .property-card .flex.gap-2 a {
            width: 36px !important;
            height: 36px !important;
        }
        
        /* –ë–ª–æ–∫ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ - –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        .manager-block {
            padding: 0.75rem !important;
        }
        
        .manager-block .flex {
            flex-direction: column;
            gap: 0.75rem !important;
        }
        
        .manager-block img {
            width: 48px !important;
            height: 48px !important;
        }
        
        .manager-block h3 {
            font-size: 1rem !important;
        }
        
        .manager-block p {
            font-size: 0.75rem !important;
            margin-bottom: 0.5rem !important;
        }
        
        .manager-block .flex.items-center.gap-4 {
            flex-direction: column;
            align-items: flex-start !important;
            gap: 0.5rem !important;
        }
        
        .manager-block .flex.items-center.gap-1 {
            font-size: 0.75rem !important;
        }
        
        /* –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü–∞–≥–∏–Ω–∞—Ü–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö - —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Å–∫–æ–ø–∏–Ω–≥–æ–º */
        .pagination-bar {
            flex-direction: column !important;
            gap: 1rem !important;
            align-items: flex-start !important;
        }
        
        .pagination-bar .text-sm,
        .pagination-bar > div {
            font-size: 0.75rem !important;
        }
        
        .pagination-bar .flex {
            width: 100% !important;
            flex-wrap: wrap !important;
            gap: 0.5rem !important;
        }
        
        .pagination-bar a,
        .pagination-bar span {
            font-size: 0.75rem !important;
            padding: 0.375rem 0.75rem !important;
        }
        
        .pagination-bar button {
            font-size: 0.75rem !important;
            padding: 0.375rem 0.75rem !important;
        }
        
        /* MOBILE: Pagination –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è */
        #properties-container .pagination-bar {
            flex-direction: column !important;
            gap: 1rem !important;
        }
        
        /* –ò–°–ü–†–ê–í–õ–ï–ù–û: Toolbar (–±–ª–æ–∫ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∏ –∫–Ω–æ–ø–∫–∞–º–∏) - —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Å–∫–æ–ø–∏–Ω–≥–æ–º */
        #properties-toolbar .flex.justify-between.items-center {
            flex-direction: column !important;
            gap: 0.75rem !important;
            align-items: flex-start !important;
        }
        
        #properties-toolbar h3 {
            font-size: 1rem !important;
        }
        
        #properties-toolbar .flex.gap-2 {
            width: 100%;
            flex-wrap: wrap;
            gap: 0.5rem !important;
        }
        
        #properties-toolbar button,
        #properties-toolbar select {
            font-size: 0.75rem !important;
            padding: 0.375rem 0.75rem !important;
        }
        
        /* –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ "–°–≤—è–∑–∞—Ç—å—Å—è" –∏ "–ù–∞ –∫–∞—Ä—Ç–µ" –Ω–∞ –º–æ–±–∞–π–ª–µ */
        #properties-toolbar .flex.gap-2 > button[onclick*="openApplicationModal"],
        #properties-toolbar .relative.rounded-2xl {
            display: none !important;
        }
        
        #properties-toolbar .relative.rounded-2xl svg {
            width: 1rem !important;
            height: 1rem !important;
        }
        
        /* –ò–°–ü–†–ê–í–õ–ï–ù–û: View toggle buttons - —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Å–∫–æ–ø–∏–Ω–≥–æ–º */
        #properties-toolbar .flex.items-center.bg-gray-100 button {
            padding: 0.375rem 0.5rem !important;
            font-size: 0.75rem !important;
        }
        
        #properties-toolbar .flex.items-center.bg-gray-100 svg {
            width: 0.875rem !important;
            height: 0.875rem !important;
        }

        
        /* MOBILE: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ z-index –¥–ª—è –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏ –º–µ–Ω—é */
        header,
        nav,
        .mobile-menu-toggle,
        #mobile-menu,
        button[aria-label="Toggle menu"] {
            z-index: 9999 !important;
            position: relative !important;
        }
        
        /* –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –∫–∞—Ä—Ç–∞ –∏ –¥—Ä—É–≥–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—Ç header */
        #propertiesMap,
        #propertiesMapContainer,
        .ymaps-2-1-79-map {
            z-index: 1 !important;
        }
        
        /* Filters z-index - —Ç–æ–ª—å–∫–æ –¥–ª—è properties */
        section.py-8.bg-gray-50 .filters-container,
        section.py-8.bg-gray-50 .dropdown-menu {
            z-index: 50 !important;
        }
        
        /* –ü–æ–∏—Å–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∏–∂–µ header */
        #property-search,
        #property-search-desktop,
        .bg-white.rounded-lg.shadow-md {
            z-index: 10 !important;
        }
        
        /* MOBILE: Bottom Sheet Styles */
        #bottomSheetBackdrop.active {
            opacity: 1 !important;
        }
        
        #propertyBottomSheet.active {
            transform: translateY(0) !important;
        }
        
        /* Property cards in bottom sheet */
        .property-sheet-card {
            min-width: 280px;
            max-width: 280px;
            flex-shrink: 0;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            scroll-snap-align: start;
            transition: transform 0.2s;
        }
        
        .property-sheet-card:active {
            transform: scale(0.98);
        }
        
        /* Smooth scrolling for bottom sheet */
        #bottomSheetPropertiesContainer::-webkit-scrollbar {
            display: none;
        }
        
        #bottomSheetPropertiesContainer {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Vertical property cards in bottom sheet */
        .bottom-sheet-property-card {
            width: 100%;
            margin-bottom: 0.75rem;
        }

        }

    /* ‚úÖ –§–ò–ù–ê–õ–¨–ù–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ */
    
    /* –£–º–µ–Ω—å—à–∞–µ–º Hero section –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞ */
    #properties-hero {
        padding-top: 0.5rem !important;
        padding-bottom: 0.5rem !important;
    }
    
    #properties-hero h2 {
        margin-bottom: 0.5rem !important;
        font-size: 1.5rem !important;
    }
    
    #properties-hero p {
        margin-bottom: 0.5rem !important;
        font-size: 1rem !important;
    }
    
    /* –ö–∞—Ä—Ç–æ—á–∫–∏ –î–û–õ–ñ–ù–´ –±—ã—Ç—å flex –¥–ª—è horizontal layout */
    .property-card {
        display: flex !important;
        flex-direction: row !important;
        visibility: visible !important;
    }

    /* Compact dropdown menu */
    .dropdown {
        position: relative;
        display: inline-block;
    }
    
    .dropdown-btn {
        background: white;
        border: none;
        color: #374151;
        font-weight: 400;
        padding: 0.75rem 1rem;
        border-radius: 0;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
        white-space: nowrap;
    }
    
    .dropdown-btn:hover {
        background: rgba(0, 136, 204, 0.1);
    }
    
    .dropdown-btn svg {
        width: 16px;
        height: 16px;
        transition: transform 0.2s;
    }
    
    .dropdown-btn.open svg {
        transform: rotate(180deg);
    }
    
    .dropdown-menu {
        position: absolute;
        top: calc(100% + 8px);
        left: 0;
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        padding: 0.5rem 0;
        min-width: 200px;
        z-index: 50;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.2s ease;
    }
    
    .dropdown-menu.open {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }
    
    .dropdown-menu .dropdown-section {
        padding: 0.5rem 1rem;
        border-bottom: 1px solid #f1f5f9;
    }
    
    .dropdown-menu .dropdown-section:last-child {
        border-bottom: none;
    }
    
    .dropdown-menu .dropdown-section h4 {
        font-size: 0.875rem;
        font-weight: 600;
        color: #64748b;
        margin-bottom: 0.5rem;
    }
    
    .dropdown-menu .filter-option {
        display: flex;
        align-items: center;
        padding: 0.375rem 0;
        font-size: 0.875rem;
        color: #374151;
        cursor: pointer;
        transition: color 0.2s;
    }
    
    .dropdown-menu .filter-option:hover {
        color: #0088CC;
    }
    
    .dropdown-menu .filter-option input[type="checkbox"] {
        margin-right: 0.5rem;
        width: 16px;
        height: 16px;
        accent-color: #0088CC;
    }
    
    .dropdown-menu .price-inputs {
        display: flex;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
    }
    
    .dropdown-menu .price-inputs input {
        flex: 1;
        padding: 0.5rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        outline: none;
    }
    
    .dropdown-menu .price-inputs input:focus {
        border-color: #0088CC;
        box-shadow: 0 0 0 2px rgba(0, 136, 204, 0.1);
    }
    
    .dropdown-menu .apply-price-btn {
        background: #0088CC;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        cursor: pointer;
        margin: 0.5rem 1rem 0;
        transition: opacity 0.2s;
    }
    
    .dropdown-menu .apply-price-btn:hover {
        opacity: 0.9;
    }
    
    /* Active filter chips */
    .active-filter-chip {
        display: inline-flex;
        align-items: center;
        background: #0088CC;
        color: white;
        padding: 0.375rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        gap: 0.5rem;
        margin: 0.25rem;
    }
    
    .active-filter-chip .remove-btn {
        width: 18px;
        height: 18px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        line-height: 1;
        transition: background 0.2s;
    }
    
    .active-filter-chip .remove-btn:hover {
        background: rgba(255, 255, 255, 0.3);
    }
    
    /* Beautiful Filter Button Styles */
    .filter-option-btn {
        transition: all 0.2s ease;
        border: 1px solid #e5e7eb;
        background: #f9fafb;
        position: relative;
    }

    .filter-option-btn:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .filter-option-btn:active {
        transform: translateY(0);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .filter-option-btn.active {
        background: #eff6ff;
        border-color: #3b82f6;
        color: #1d4ed8;
    }

    .filter-option-btn.active svg {
        color: #3b82f6;
    }

    /* Quick Filter Dropdown Styles */
    .dropdown {
        position: relative;
        display: inline-block;
    }

    .dropdown-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        min-width: 200px;
        padding: 0.5rem;
        margin-top: 0.25rem;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.2s ease;
    }
    
    .dropdown-menu.open {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .dropdown-menu.open {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .dropdown-item {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        border-radius: 0.25rem;
        cursor: pointer;
        transition: background-color 0.15s;
        font-size: 0.875rem;
    }

    .dropdown-item:hover {
        background-color: #f3f4f6;
    }

    /* Filter counter badge */
    .filter-counter {
        background: #ef4444;
        color: white;
        font-size: 0.75rem;
        font-weight: 600;
        min-width: 18px;
        height: 18px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-left: 0.5rem;
    }
    
    /* Toggle switches */
    .toggle-checkbox:checked {
        right: 0;
        border-color: #0088CC;
        background-color: #0088CC;
    }
    
    .toggle-checkbox:checked + .toggle-label {
        background-color: #0088CC;
    }
    
    .toggle-label {
        transition: background-color 0.2s;
    }
    
    /* Hide unsupported advanced filters based on user feedback */
    .filter-dropdown[data-filter="property_class"],
    .filter-dropdown[data-filter="wall_material"],
    .filter-dropdown[data-filter="floors_total"],
    .filter-dropdown[data-filter="window_view"],
    .filter-dropdown[data-filter="cardinal_direction"],
    .filter-dropdown[data-filter="apartment_category"],
    .filter-dropdown[data-filter="entrance_access"],
    .filter-dropdown[data-filter="panoramic"],
    .filter-dropdown[data-filter="developer_pv"],
    .filter-dropdown[data-filter="mortgage_types"],
    .filter-dropdown[data-filter="escrow"],
    .filter-dropdown[data-filter="property_rights_cost"],
    .filter-dropdown[data-filter="direction"],
    .filter-dropdown[data-filter="registration"],
    .filter-dropdown[data-filter="nearby_places"] {
        display: none !important;
    }
    
    /* Hide sections if they become empty */
    .space-y-3:has(.filter-dropdown:not([style*="display: none"]):only-child) {
        min-height: 100px;
    }
    
    /* Hide specific quick filter buttons by unique selectors */
    button[data-filter="distance"]:not(:only-child) {
        /* Keep "–î–æ —Ü–µ–Ω—Ç—Ä–∞" - it's supported */
    }
    
    /* More specific approach: manually hide unsupported buttons by finding parent containers */
    /* This will be handled by JavaScript after page load for better compatibility */
    
    /* Manager Favorites Styles */
    .manager-favorite-heart {
        transition: all 0.3s ease;
        background: rgba(0, 136, 204, 0.9) !important;
    }
    
    .manager-favorite-heart:hover {
        background: #0088CC !important;
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0, 136, 204, 0.3);
    }
    
    .manager-favorite-heart i {
        color: white !important;
        font-size: 14px;
    }
    
    .manager-favorite-heart.manager-favorited {
        background: #0088CC !important;
        box-shadow: 0 0 0 2px white, 0 0 0 4px #0088CC;
    }
    
    /* Mobile Filter Modal Panels - Fullscreen */
    @media (max-width: 767px) {
        #advancedFiltersPanel,
        #roomsFilterPanel,
        #priceFilterPanel,
        #developerFilterPanel,
        #saveSearchModal {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            max-height: 100vh !important;
            margin: 0 !important;
            border-radius: 0 !important;
            z-index: 9999 !important;
            overflow: hidden;
        }
        
        #advancedFiltersPanel.hidden,
        #roomsFilterPanel.hidden,
        #priceFilterPanel.hidden,
        #developerFilterPanel.hidden,
        #saveSearchModal.hidden {
            display: none !important;
        }
    }
    
    .manager-favorite-heart.manager-favorited i {
        color: #FFD700 !important;
        animation: heartbeat 1.5s ease-in-out infinite;
    }
    
    .manager-favorite-heart.pulse-blue {
        animation: pulse-blue 1.5s ease-in-out infinite;
    }
    
    .manager-favorite-heart.animate-click {
        transform: scale(0.85);
        transition: transform 0.15s ease-out;
    }
    
    /* Blue pulse animation for manager hearts */
    @keyframes pulse-blue {
        0% {
            box-shadow: 0 0 0 0 rgba(0, 136, 204, 0.4);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(0, 136, 204, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(0, 136, 204, 0);
        }
    }
    
    /* Heartbeat animation for favorited manager stars */
    @keyframes heartbeat {
        0%, 50%, 100% {
            transform: scale(1);
        }
        25%, 75% {
            transform: scale(1.2);
        }
    }
    
    /* Floating stars animation for manager favorites */
    .floating-star {
        position: fixed;
        pointer-events: none;
        z-index: 9999;
        animation: float-up-star 2s ease-out forwards;
        font-size: 14px;
        color: #0088CC;
        text-shadow: 0 0 6px rgba(0, 136, 204, 0.8);
    }
    
    @keyframes float-up-star {
        0% {
            opacity: 1;
            transform: translateY(0) scale(0.8);
        }
        50% {
            opacity: 1;
            transform: translateY(-30px) scale(1.2);
        }
        100% {
            opacity: 0;
            transform: translateY(-60px) scale(0.6);
        }
    }
    
    /* Ensure proper spacing between favorite buttons */
    .favorite-heart {
        transition: all 0.3s ease;
    }
    
    .favorite-heart:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    
    .favorite-heart.favorited {
        box-shadow: 0 0 0 2px white, 0 0 0 4px #ef4444;
    }
    
    .favorite-heart.animate-click {
        transform: scale(0.85);
        transition: transform 0.15s ease-out;
    }
    
    /* Improve button container layout */
    .absolute.top-3.right-3.flex.gap-2 {
        right: 12px !important;
    }
    
    /* Manager AND User Comparison Styles - Using BRAND BLUE (same as favorites) */
    .compare-btn {
        transition: all 0.3s ease;
    }
    
    /* Both manager and user comparison highlighting use BLUE color */
    .compare-btn.manager-comparison-active,
    .compare-btn.user-comparison-active {
        background: linear-gradient(135deg, #0088CC 0%, #0066AA 100%) !important;
        border-color: #0088CC !important;
        box-shadow: 0 0 0 2px white, 0 0 0 4px #0088CC !important;
    }
    
    .compare-btn.manager-comparison-active i,
    .compare-btn.user-comparison-active i {
        color: white !important;
        animation: scalebeat 1.5s ease-in-out infinite;
    }
    
    .compare-btn.pulse-blue {
        animation: pulse-blue 1.5s ease-in-out infinite;
    }
    
    .compare-btn.animate-click {
        transform: scale(0.85);
        transition: transform 0.15s ease-out;
    }
    
    /* Scale beat animation for comparison icons */
    @keyframes scalebeat {
        0%, 50%, 100% {
            transform: scale(1);
        }
        25%, 75% {
            transform: scale(1.2);
        }
    }
</style>

<script>
// City slug for URL generation
const citySlug = '{{ city_slug }}';

// ‚ö° –†–ê–ù–ù–ò–ï –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø –§–£–ù–ö–¶–ò–ô - –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –î–û –ø–∞—Ä—Å–∏–Ω–≥–∞ HTML –ø–∞–Ω–µ–ª–µ–π
// –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã inline onclick –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –≤ –º–æ–±–∏–ª—å–Ω—ã—Ö –ø–∞–Ω–µ–ª—è—Ö

console.log('‚ö° Early filter functions initializing...');

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –≤—Å–µ—Ö –ø–∞–Ω–µ–ª–µ–π
window.closeAllFilterPanels = function() {
    ['roomsFilterPanel', 'priceFilterPanel', 'developerFilterPanel', 'advancedFiltersPanel'].forEach(id => {
        const panel = document.getElementById(id);
        if (panel) {
            panel.classList.add('hidden');
            panel.classList.remove('mobile-fullscreen');
        }
    });
    document.body.style.overflow = '';
};

// –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞ –∫–æ–º–Ω–∞—Ç
window.applyRoomsFilter = function() {
    console.log('‚ö° applyRoomsFilter (early version) called');
    const panel = document.getElementById('roomsFilterPanel');
    if (panel) {
        panel.classList.add('hidden');
        panel.classList.remove('mobile-fullscreen');
        document.body.style.overflow = '';
    }
    // –í—ã–∑—ã–≤–∞–µ–º applyFilters –µ—Å–ª–∏ –æ–Ω–∞ —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞
    if (typeof window.applyFilters === 'function') {
        console.log('‚úÖ Calling window.applyFilters()');
        window.applyFilters();
    } else {
        console.warn('‚ö†Ô∏è window.applyFilters not yet defined, filters not applied');
    }
};

// –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞ —Ü–µ–Ω—ã
window.applyPriceFilterModal = function() {
    console.log('‚ö° applyPriceFilterModal (early version) called');
    const panel = document.getElementById('priceFilterPanel');
    if (panel) {
        panel.classList.add('hidden');
        panel.classList.remove('mobile-fullscreen');
        document.body.style.overflow = '';
    }
    if (typeof window.applyFilters === 'function') {
        console.log('‚úÖ Calling window.applyFilters()');
        window.applyFilters();
    } else {
        console.warn('‚ö†Ô∏è window.applyFilters not yet defined, filters not applied');
    }
};

// –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞ –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–æ–≤
window.applyDeveloperFilter = function() {
    console.log('‚ö° applyDeveloperFilter (early version) called');
    const panel = document.getElementById('developerFilterPanel');
    if (panel) {
        panel.classList.add('hidden');
        panel.classList.remove('mobile-fullscreen');
        document.body.style.overflow = '';
    }
    if (typeof window.applyFilters === 'function') {
        console.log('‚úÖ Calling window.applyFilters()');
        window.applyFilters();
    } else {
        console.warn('‚ö†Ô∏è window.applyFilters not yet defined, filters not applied');
    }
};

// –§—É–Ω–∫—Ü–∏–∏ Save Search Modal - —Ä–∞–Ω–Ω—è—è –≤–µ—Ä—Å–∏—è –¥–ª—è inline onclick
window.openSaveSearchModal = function() {
    console.log('üíó Opening save search modal (early)');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    const isAuthenticated = window.user_authenticated || window.manager_authenticated;
    
    if (!isAuthenticated) {
        console.log('‚ö†Ô∏è User not authenticated, showing registration prompt');
        alert('–ß—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ø–æ–∏—Å–∫–∏, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è');
        
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏–ª–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏–º
        setTimeout(function() {
            if (typeof openApplicationModal === 'function') {
                openApplicationModal();
            } else {
                window.location.href = '/register';
            }
        }, 100);
        return;
    }
    
    const panel = document.getElementById('saveSearchModal');
    if (panel) {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –ø–∞–Ω–µ–ª–∏
        if (typeof window.closeAllFilterPanels === 'function') {
            window.closeAllFilterPanels();
        }
        
        panel.classList.remove('hidden');
        
        // –ù–∞ –º–æ–±–∞–π–ª–µ –¥–µ–ª–∞–µ–º fullscreen
        const isMobile = window.innerWidth < 640;
        if (isMobile) {
            panel.classList.add('mobile-fullscreen');
            document.body.style.overflow = 'hidden';
        }
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è —Ñ—É–Ω–∫—Ü–∏–π, –≤—ã–∑—ã–≤–∞–µ–º –∏—Ö
        if (typeof generateSearchNameForModal === 'function') {
            const searchName = generateSearchNameForModal();
            const nameInput = document.getElementById('searchNameInputModal');
            if (nameInput) nameInput.value = searchName;
        }
        
        if (typeof updateFiltersPreview === 'function') {
            updateFiltersPreview();
        }
        
        console.log('‚úÖ Save search modal opened');
    }
};

window.closeSaveSearchModal = function() {
    const panel = document.getElementById('saveSearchModal');
    if (panel) {
        panel.classList.add('hidden');
        panel.classList.remove('mobile-fullscreen');
        document.body.style.overflow = '';
    }
};

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è Save Search Modal - —Ä–∞–Ω–Ω–∏–µ –≤–µ—Ä—Å–∏–∏
window.generateSearchNameForModal = function() {
    // –ü—Ä–æ—Å—Ç–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
    const rooms = Array.from(document.querySelectorAll('input[data-filter-type="rooms"]:checked')).map(el => el.value);
    const districts = Array.from(document.querySelectorAll('input[data-filter-type="district"]:checked')).map(el => el.getAttribute('data-district-name') || el.value);
    
    let name = '–ü–æ–∏—Å–∫';
    if (rooms.length > 0) {
        const roomText = rooms.map(r => {
            if (r === '0') return '–°—Ç—É–¥–∏—è';
            return `${r}`;
        }).join(', ');
        name = roomText + ' –∫–æ–º–Ω';
    }
    if (districts.length > 0) {
        name += ' –≤ ' + districts.slice(0, 2).join(', ');
    }
    
    return name.trim() || '–ü–æ–∏—Å–∫ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏';
};

window.updateFiltersPreview = function() {
    console.log('üîç updateFiltersPreview() called');
    const preview = document.getElementById('currentFiltersPreview');
    if (!preview) {
        console.warn('‚ö†Ô∏è currentFiltersPreview element not found');
        return;
    }
    
    const filters = [];
    
    // –ö–æ–º–Ω–∞—Ç—ã
    const roomCheckboxes = document.querySelectorAll('input[data-filter-type="rooms"]:checked');
    const rooms = Array.from(roomCheckboxes).map(el => el.value);
    if (rooms.length > 0) {
        const roomText = rooms.map(r => {
            if (r === '0') return '–°—Ç—É–¥–∏—è';
            return `${r}-–∫–æ–º–Ω–∞—Ç–Ω–∞—è`;
        }).join(', ');
        filters.push(`<div class="text-gray-700"><i class="fas fa-door-open text-blue-500 mr-2"></i><strong>–ö–æ–º–Ω–∞—Ç—ã:</strong> ${roomText}</div>`);
    }
    
    // –ö–ª–∞—Å—Å –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
    const objectClassCheckboxes = document.querySelectorAll('input[data-filter-type="object_class"]:checked');
    const objectClasses = Array.from(objectClassCheckboxes).map(el => {
        const label = el.closest('label')?.textContent.trim() || el.value;
        return label;
    });
    if (objectClasses.length > 0) {
        filters.push(`<div class="text-gray-700"><i class="fas fa-building text-[#0088CC] mr-2"></i><strong>–ö–ª–∞—Å—Å:</strong> ${objectClasses.join(', ')}</div>`);
    }
    
    // –†–∞–π–æ–Ω—ã
    const districtCheckboxes = document.querySelectorAll('input[data-filter-type="district"]:checked');
    const districts = Array.from(districtCheckboxes).map(el => el.getAttribute('data-district-name') || el.value);
    if (districts.length > 0) {
        filters.push(`<div class="text-gray-700"><i class="fas fa-map-marker-alt text-red-500 mr-2"></i><strong>–†–∞–π–æ–Ω—ã:</strong> ${districts.join(', ')}</div>`);
    }
    
    // –ó–∞—Å—Ç—Ä–æ–π—â–∏–∫–∏
    const developerCheckboxes = document.querySelectorAll('input[data-filter-type="developer"]:checked');
    const developers = Array.from(developerCheckboxes).map(el => {
        const label = el.closest('label')?.textContent.trim() || el.value;
        return label;
    });
    if (developers.length > 0) {
        filters.push(`<div class="text-gray-700"><i class="fas fa-industry text-orange-500 mr-2"></i><strong>–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫–∏:</strong> ${developers.join(', ')}</div>`);
    }
    
    // –°—Ä–æ–∫ —Å–¥–∞—á–∏
    const completionCheckboxes = document.querySelectorAll('input[data-filter-type="completion"]:checked');
    const completion = Array.from(completionCheckboxes).map(el => {
        const label = el.closest('label')?.textContent.trim() || el.value;
        return label;
    });
    if (completion.length > 0) {
        filters.push(`<div class="text-gray-700"><i class="fas fa-calendar-check text-teal-500 mr-2"></i><strong>–°—Ä–æ–∫ —Å–¥–∞—á–∏:</strong> ${completion.join(', ')}</div>`);
    }
    
    // –û—Ç–¥–µ–ª–∫–∞
    const renovationCheckboxes = document.querySelectorAll('input[data-filter-type="renovation"]:checked');
    const renovation = Array.from(renovationCheckboxes).map(el => {
        const label = el.closest('label')?.textContent.trim() || el.value;
        return label;
    });
    if (renovation.length > 0) {
        filters.push(`<div class="text-gray-700"><i class="fas fa-paint-roller text-[#0088CC] mr-2"></i><strong>–û—Ç–¥–µ–ª–∫–∞:</strong> ${renovation.join(', ')}</div>`);
    }
    
    // –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
    const featuresCheckboxes = document.querySelectorAll('input[data-filter-type="features"]:checked');
    const features = Array.from(featuresCheckboxes).map(el => {
        const label = el.closest('label')?.textContent.trim() || el.value;
        return label;
    });
    if (features.length > 0) {
        filters.push(`<div class="text-gray-700"><i class="fas fa-star text-yellow-500 mr-2"></i><strong>–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:</strong> ${features.join(', ')}</div>`);
    }
    
    // –¶–µ–Ω–∞
    const priceFrom = document.getElementById('priceFrom')?.value;
    const priceTo = document.getElementById('priceTo')?.value;
    if (priceFrom || priceTo) {
        filters.push(`<div class="text-gray-700"><i class="fas fa-ruble-sign text-green-500 mr-2"></i><strong>–¶–µ–Ω–∞:</strong> ${priceFrom || '0'} - ${priceTo || '‚àû'} –º–ª–Ω ‚ÇΩ</div>`);
    }
    
    // –ü–ª–æ—â–∞–¥—å
    const areaFrom = document.getElementById('areaFrom')?.value;
    const areaTo = document.getElementById('areaTo')?.value;
    if (areaFrom || areaTo) {
        filters.push(`<div class="text-gray-700"><i class="fas fa-ruler-combined text-[#0088CC] mr-2"></i><strong>–ü–ª–æ—â–∞–¥—å:</strong> ${areaFrom || '0'} - ${areaTo || '‚àû'} –º¬≤</div>`);
    }
    
    console.log(`‚úÖ Total filters found: ${filters.length}`);
    
    if (filters.length === 0) {
        preview.innerHTML = '<div class="text-gray-400 italic">–§–∏–ª—å—Ç—Ä—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</div>';
    } else {
        preview.innerHTML = filters.join('');
    }
};

// ========== SEARCH MODAL FUNCTIONS (EARLY) ==========
// ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
let modalSearchDebounceTimer = null;
let modalSearchDropdown = null;

function initModalSearchSuggestions() {
    const input = document.getElementById('modal-search-input');
    if (!input || input.dataset.suggestionsInitialized) return;
    
    console.log('üîç Initializing suggestions for modal-search-input');
    input.dataset.suggestionsInitialized = 'true';
    
    // –°–æ–∑–¥–∞—ë–º dropdown –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫
    if (!modalSearchDropdown) {
        modalSearchDropdown = document.createElement('div');
        modalSearchDropdown.className = 'mt-3 bg-white border border-gray-200 rounded-lg shadow-xl max-h-80 overflow-y-auto hidden';
        input.closest('.p-4').appendChild(modalSearchDropdown);
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞
    input.addEventListener('input', (e) => {
        const query = e.target.value.trim();
        
        clearTimeout(modalSearchDebounceTimer);
        
        if (query.length === 0) {
            modalSearchDropdown.classList.add('hidden');
            return;
        }
        
        modalSearchDebounceTimer = setTimeout(async () => {
            try {
                const response = await fetch(`/api/search/suggestions?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data.success && data.suggestions && data.suggestions.length > 0) {
                    showModalSuggestions(data.suggestions);
                } else {
                    modalSearchDropdown.classList.add('hidden');
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥—Å–∫–∞–∑–æ–∫:', error);
                modalSearchDropdown.classList.add('hidden');
            }
        }, 200);
    });
}

function showModalSuggestions(suggestions) {
    if (!modalSearchDropdown) return;
    
    const html = suggestions.map(sug => `
        <div class="suggestion-item px-4 py-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0 transition-colors"
             onclick="window.location.href='${sug.url}'">
            <div class="flex items-center gap-3">
                <div class="text-gray-600 text-sm">${sug.icon || 'üîç'}</div>
                <div class="flex-1">
                    <div class="font-medium text-gray-900">${sug.text || sug.title}</div>
                    ${sug.count ? `<div class="text-xs text-gray-500">${sug.count} –æ–±—ä–µ–∫—Ç–æ–≤</div>` : ''}
                </div>
            </div>
        </div>
    `).join('');
    
    modalSearchDropdown.innerHTML = html;
    modalSearchDropdown.classList.remove('hidden');
}

window.openSearchModal = function() {
    const panel = document.getElementById('searchModalPanel');
    if (!panel) return;
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –ø–∞–Ω–µ–ª–∏
    if (typeof window.closeAllFilterPanels === 'function') {
        window.closeAllFilterPanels();
    }
    
    panel.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
    initModalSearchSuggestions();
    
    // –§–æ–∫—É—Å –Ω–∞ input
    setTimeout(() => {
        const input = document.getElementById('modal-search-input');
        if (input) input.focus();
    }, 100);
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ–∏—Å–∫–∞ –∏ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
    loadSearchHistory();
    loadPopularSearches();
};

window.closeSearchModal = function() {
    const panel = document.getElementById('searchModalPanel');
    if (panel) {
        panel.classList.add('hidden');
        document.body.style.overflow = '';
    }
};

window.clearModalSearch = function() {
    const input = document.getElementById('modal-search-input');
    if (input) {
        input.value = '';
        input.focus();
    }
};

window.selectPopularSearch = function(query) {
    const input = document.getElementById('modal-search-input');
    if (input) {
        input.value = query;
        // –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫ (–∏—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤)
        performSearchFromModal(query);
    }
};

// ‚úÖ performSearchFromModal() –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ /static/js/mobile-search-redirect.js

window.loadSearchHistory = async function() {
    try {
        const container = document.getElementById('searchHistoryList');
        if (!container) return;
        
        // Show loading state
        container.innerHTML = '<div class="text-sm text-gray-400 italic">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        
        // Call API to get search history
        const response = await fetch('/api/search/history/list', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        // Handle unauthenticated users gracefully
        if (response.status === 401) {
            container.innerHTML = '<div class="text-sm text-gray-400 italic">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –∏—Å—Ç–æ—Ä–∏—é</div>';
            return;
        }
        
        if (!response.ok) {
            container.innerHTML = '<div class="text-sm text-gray-400 italic">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
            return;
        }
        
        const data = await response.json();
        const history = data.history || [];
        
        if (history.length === 0) {
            container.innerHTML = '<div class="text-sm text-gray-400 italic">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
            return;
        }
        
        // Show last 20 searches from database (already sorted by API)
        container.innerHTML = history.map(item => `
            <button onclick="selectPopularSearch('${(item.query || '').replace(/'/g, "\\'")}')" 
                    class="w-full text-left px-3 py-2 bg-gray-50 hover:bg-blue-50 text-gray-700 rounded-lg text-sm transition-colors border border-gray-200 flex items-center gap-2">
                <i class="fas fa-history text-gray-400"></i>
                ${item.query || ''}
                ${item.result_count ? `<span class="ml-auto text-xs text-gray-400">${item.result_count}</span>` : ''}
            </button>
        `).join('');
    } catch (error) {
        console.error('Error loading search history:', error);
        const container = document.getElementById('searchHistoryList');
        if (container) {
            container.innerHTML = '<div class="text-sm text-gray-400 italic">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
        }
    }
};

window.saveToSearchHistory = async function(query, resultCount = 0) {
    if (!query || query.trim() === '') return;
    
    try {
        // Get CSRF token
        const csrfToken = window.csrf_token || document.querySelector('meta[name="csrf-token"]')?.content;
        
        if (!csrfToken) {
            console.warn('CSRF token not found, skipping search history save');
            return;
        }
        
        // Call API to save search history
        const response = await fetch('/api/search/history/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                query: query.trim(),
                result_count: resultCount
            })
        });
        
        // Handle 401 silently (not authenticated - this is OK for guests)
        if (response.status === 401) {
            console.log('Search history not saved (user not authenticated)');
            return;
        }
        
        if (!response.ok) {
            console.warn('Failed to save search history:', response.status);
            return;
        }
        
        const data = await response.json();
        if (data.success) {
            console.log('Search history saved successfully');
        }
    } catch (error) {
        // Fail silently - don't show errors to users
        console.error('Error saving search history:', error);
    }
};

window.loadPopularSearches = async function() {
    try {
        const container = document.getElementById('popularSearchesList');
        if (!container) return;
        
        // Show loading state
        container.innerHTML = '<div class="text-sm text-gray-400 italic">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        
        // Call API to get popular searches
        const response = await fetch('/api/search/popular?limit=10', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            // Fallback to default popular searches with direct URLs
            container.innerHTML = `
                <button onclick="window.location.href='/' + citySlug + '/properties?rooms=1';" class="px-3 py-2 bg-gray-100 hover:bg-blue-50 text-gray-700 rounded-lg text-sm transition-colors border border-gray-200">
                    1 –∫–æ–º–Ω
                </button>
                <button onclick="window.location.href='/' + citySlug + '/properties?rooms=2';" class="px-3 py-2 bg-gray-100 hover:bg-blue-50 text-gray-700 rounded-lg text-sm transition-colors border border-gray-200">
                    2 –∫–æ–º–Ω
                </button>
                <button onclick="window.location.href='/' + citySlug + '/properties?rooms=0';" class="px-3 py-2 bg-gray-100 hover:bg-blue-50 text-gray-700 rounded-lg text-sm transition-colors border border-gray-200">
                    –°—Ç—É–¥–∏—è
                </button>
            `;
            return;
        }
        
        const data = await response.json();
        const popular = data.suggestions || [];
        
        if (popular.length === 0) {
            // Fallback to default popular searches with direct URLs
            container.innerHTML = `
                <button onclick="window.location.href='/' + citySlug + '/properties?rooms=1';" class="px-3 py-2 bg-gray-100 hover:bg-blue-50 text-gray-700 rounded-lg text-sm transition-colors border border-gray-200">
                    1 –∫–æ–º–Ω
                </button>
                <button onclick="window.location.href='/' + citySlug + '/properties?rooms=2';" class="px-3 py-2 bg-gray-100 hover:bg-blue-50 text-gray-700 rounded-lg text-sm transition-colors border border-gray-200">
                    2 –∫–æ–º–Ω
                </button>
                <button onclick="window.location.href='/' + citySlug + '/properties?rooms=0';" class="px-3 py-2 bg-gray-100 hover:bg-blue-50 text-gray-700 rounded-lg text-sm transition-colors border border-gray-200">
                    –°—Ç—É–¥–∏—è
                </button>
            `;
            return;
        }
        
        // Render popular searches from API
        container.innerHTML = popular.map(item => `
            <button onclick="selectPopularSearch('${(item.text || item.query || '').replace(/'/g, "\\'")}')" 
                    class="px-3 py-2 bg-gray-100 hover:bg-blue-50 text-gray-700 rounded-lg text-sm transition-colors border border-gray-200">
                ${item.text || item.query || ''}
            </button>
        `).join('');
    } catch (error) {
        console.error('Error loading popular searches:', error);
        // Fallback to default popular searches with direct URLs
        const container = document.getElementById('popularSearchesList');
        if (container) {
            container.innerHTML = `
                <button onclick="window.location.href='/' + citySlug + '/properties?rooms=1';" class="px-3 py-2 bg-gray-100 hover:bg-blue-50 text-gray-700 rounded-lg text-sm transition-colors border border-gray-200">
                    1 –∫–æ–º–Ω
                </button>
                <button onclick="window.location.href='/' + citySlug + '/properties?rooms=2';" class="px-3 py-2 bg-gray-100 hover:bg-blue-50 text-gray-700 rounded-lg text-sm transition-colors border border-gray-200">
                    2 –∫–æ–º–Ω
                </button>
                <button onclick="window.location.href='/' + citySlug + '/properties?rooms=0';" class="px-3 py-2 bg-gray-100 hover:bg-blue-50 text-gray-700 rounded-lg text-sm transition-colors border border-gray-200">
                    –°—Ç—É–¥–∏—è
                </button>
            `;
        }
    }
};

window.saveSearchFromModal = async function() {
    console.log('üíæ Saving search from modal (early)...');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    const isAuthenticated = window.user_authenticated || window.manager_authenticated;
    if (!isAuthenticated) {
        alert('–î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è');
        window.closeSaveSearchModal();
        if (typeof openApplicationModal === 'function') {
            openApplicationModal();
        }
        return;
    }
    
    const searchName = document.getElementById('searchNameInputModal')?.value;
    
    if (!searchName || !searchName.trim()) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∏—Å–∫–∞');
        return;
    }
    
    try {
        // –°–æ–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏–∑ DOM
        const params = {
            rooms: Array.from(document.querySelectorAll('input[data-filter-type="rooms"]:checked')).map(cb => cb.value),
            districts: Array.from(document.querySelectorAll('input[data-filter-type="district"]:checked')).map(cb => cb.value),
            developers: Array.from(document.querySelectorAll('input[data-filter-type="developer"]:checked')).map(cb => cb.value),
            completion: Array.from(document.querySelectorAll('input[data-filter-type="completion"]:checked')).map(cb => cb.value),
            object_classes: Array.from(document.querySelectorAll('input[data-filter-type="object_class"]:checked')).map(cb => cb.value),
            renovation: Array.from(document.querySelectorAll('input[data-filter-type="renovation"]:checked')).map(cb => cb.value),
            features: Array.from(document.querySelectorAll('input[data-filter-type="features"]:checked')).map(cb => cb.value),
            building_released: Array.from(document.querySelectorAll('input[data-filter-type="building_released"]:checked')).map(cb => cb.value),
            regions: Array.from(document.querySelectorAll('input[data-filter-type="region"]:checked')).map(cb => cb.value),
            cities: Array.from(document.querySelectorAll('input[data-filter-type="city"]:checked')).map(cb => cb.value),
            price_min: document.getElementById('priceFrom')?.value || '',
            price_max: document.getElementById('priceTo')?.value || '',
            area_min: document.getElementById('areaFrom')?.value || '',
            area_max: document.getElementById('areaTo')?.value || '',
            floor_min: document.getElementById('floorFrom')?.value || '',
            floor_max: document.getElementById('floorTo')?.value || '',
            building_floors_min: document.getElementById('maxFloorFrom')?.value || '',
            building_floors_max: document.getElementById('maxFloorTo')?.value || ''
        };
        
        const isManager = Boolean(window.manager_authenticated);
        
        let endpoint, requestData;
        
        if (isManager) {
            endpoint = '/api/manager/saved-searches';
            requestData = {
                name: searchName,
                filters: params
            };
        } else {
            endpoint = '/api/user/saved-searches';
            requestData = {
                name: searchName,
                description: '',
                notify_new_matches: true,
                search_type: 'properties',
                ...params
            };
        }
        
        console.log('üíæ –°–æ—Ö—Ä–∞–Ω—è—é –ø–æ–∏—Å–∫:', { endpoint, requestData });
        
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin',
            body: JSON.stringify(requestData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('‚úÖ –ü–æ–∏—Å–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
            window.closeSaveSearchModal();
            if (window.savedSearchesManager && typeof window.savedSearchesManager.loadSavedSearches === 'function') {
                window.savedSearchesManager.loadSavedSearches();
            }
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–∏—Å–∫'));
        }
    } catch (error) {
        console.error('Save search error:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ–∏—Å–∫–∞');
    }
};

console.log('‚úÖ Early filter functions defined and ready');
</script>
{% endblock %}

{% block breadcrumbs %}
<!-- Breadcrumbs -->
<div class="hidden md:block container mx-auto px-4 py-3 text-sm">
    <nav class="flex" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a href="{{ url_for('index') }}" class="text-[#0088CC] hover:underline inline-flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
                    –ì–ª–∞–≤–Ω–∞—è
                </a>
            </li>
            <li aria-current="page">
                <div class="flex items-center">
                    <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                    <span class="text-gray-500 ml-1 md:ml-2">–ü–æ–∏—Å–∫ –æ–±—ä–µ–∫—Ç–æ–≤</span>
                </div>
            </li>
        </ol>
    </nav>
</div>
{% endblock %}

{% block content %}
<!-- Hidden CSRF token for AJAX requests -->
<form style="display: none;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
</form>

<!-- Advanced Search Form -->
<section id="properties-hero" class="py-4 bg-white">
    <div class="container mx-auto px-4">
        <h2 class="text-3xl md:text-4xl font-bold text-center mb-6">–ù–∞–π–¥–∏—Ç–µ –∏–¥–µ–∞–ª—å–Ω—É—é –∫–≤–∞—Ä—Ç–∏—Ä—É –≤ {{ current_city.name_prepositional if current_city else '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–µ' }}</h2>
        <p class="text-xl text-gray-600 text-center mb-12">–ù–∞–π–¥–∏—Ç–µ –∏–¥–µ–∞–ª—å–Ω—É—é –∫–≤–∞—Ä—Ç–∏—Ä—É –≤ {{ current_city.name_prepositional if current_city else '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–µ' }} –ø–æ –≤–∞—à–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º</p>
    </div>
</section>

<!-- Mobile-only Sticky Search Bar (Avito style) with SMART SEARCH -->
<section id="mobile-search-bar" class="md:hidden sticky top-0 z-30 bg-white border-b border-gray-200 shadow-sm">
    <div class="container mx-auto px-4 py-3">
        <div class="flex items-center gap-2">
            <!-- Smart Search Input (SuperSearch works here) -->
            <div class="flex-1 relative">
                <input type="text" 
                       id="property-search"
                       placeholder="–£–º–Ω—ã–π –ø–æ–∏—Å–∫: —Ä–∞–π–æ–Ω, –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫, –ñ–ö..." 
                       class="w-full pl-4 pr-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-blue-500 outline-none transition-all text-sm text-gray-700 bg-gray-50"
                       onclick="if(window.innerWidth < 768) { event.preventDefault(); openSearchModal(); this.blur(); }"
                       readonly>
            </div>
            
            <!-- Save Search Icon -->
            <button onclick="openSaveSearchModal();" 
                    class="flex-shrink-0 w-10 h-10 bg-white border border-gray-300 rounded-lg flex items-center justify-center text-gray-600 hover:text-red-500 hover:border-red-500 transition-all" 
                    title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–∏—Å–∫">
                <i class="fas fa-heart text-lg"></i>
            </button>
            
            <!-- Filter Icon with Badge -->
            <button onclick="openMobileFilters();" 
                    class="flex-shrink-0 w-10 h-10 bg-[#0088CC] rounded-lg flex items-center justify-center text-white hover:bg-[#006699] transition-all relative" 
                    title="–§–∏–ª—å—Ç—Ä—ã">
                <div id="advancedFiltersCounterMobile" class="hidden absolute -top-1 -right-1 bg-gradient-to-r from-red-500 to-red-600 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center shadow-lg">0</div>
                <i class="fas fa-sliders-h text-lg"></i>
            </button>
        </div>
    </div>
</section>

<!-- Search Block (Desktop only - mobile uses sticky bar) -->
<section id="search-section" class="py-8 bg-gray-50 md:relative md:top-0">
    <div class="container mx-auto px-4">
        <!-- Unified Search + Filters Row (DESKTOP ONLY - mobile uses separate sticky bar) -->
        <div class="bg-white rounded-xl shadow-md p-2 mb-6 md:mb-8 hidden md:block search-wrapper">
            <div class="flex items-center gap-2">
                <!-- Property Type Filter (–ö–≤–∞—Ä—Ç–∏—Ä—ã/–î–æ–º–∞/–¢–∞—É–Ω—Ö–∞—É—Å—ã) -->
                <div class="dropdown relative search-filter-btn" data-filter="property_type">
                    <button class="dropdown-btn px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2 border-r border-gray-200" onclick="toggleDropdown(event, this.parentElement.querySelector('.dropdown-menu'))">
                        <span id="property-type-label">–í—Å–µ —Ç–∏–ø—ã</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    <div class="dropdown-menu">
                        <label class="dropdown-item">
                            <input type="radio" name="property_type" value="all" data-filter-type="property_type" class="mr-2" onchange="handlePropertyTypeChange()" checked> –í—Å–µ —Ç–∏–ø—ã
                        </label>
                        <label class="dropdown-item">
                            <input type="radio" name="property_type" value="apartments" data-filter-type="property_type" class="mr-2" onchange="handlePropertyTypeChange()"> –ö–≤–∞—Ä—Ç–∏—Ä—ã
                        </label>
                        <label class="dropdown-item">
                            <input type="radio" name="property_type" value="houses" data-filter-type="property_type" class="mr-2" onchange="handlePropertyTypeChange()"> –î–æ–º–∞
                        </label>
                        <label class="dropdown-item">
                            <input type="radio" name="property_type" value="townhouses" data-filter-type="property_type" class="mr-2" onchange="handlePropertyTypeChange()"> –¢–∞—É–Ω—Ö–∞—É—Å—ã
                        </label>
                        <label class="dropdown-item">
                            <input type="radio" name="property_type" value="penthouses" data-filter-type="property_type" class="mr-2" onchange="handlePropertyTypeChange()"> –ü–µ–Ω—Ç—Ö–∞—É—Å—ã
                        </label>
                        <label class="dropdown-item">
                            <input type="radio" name="property_type" value="apartments_commercial" data-filter-type="property_type" class="mr-2" onchange="handlePropertyTypeChange()"> –ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã
                        </label>
                    </div>
                </div>
                
                <!-- Room Type Filter -->
                <div class="dropdown relative search-filter-btn" data-filter="rooms">
                    <button class="dropdown-btn px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2 border-r border-gray-200" onclick="toggleRoomsPanel(event); toggleDropdown(event, this.parentElement.querySelector('.dropdown-menu'))">
                        <span id="roomsFilterText">–ö–æ–º–Ω–∞—Ç</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                        <div class="dropdown-menu">
                            <label class="dropdown-item">
                                <input type="checkbox" value="0" data-filter-type="rooms" class="mr-2" onchange="handleRoomFilterChange()" {% if '0' in filters.rooms %}checked{% endif %}> –°—Ç—É–¥–∏—è
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="1" data-filter-type="rooms" class="mr-2" onchange="handleRoomFilterChange()" {% if '1' in filters.rooms %}checked{% endif %}> 1-–∫–æ–º–Ω–∞—Ç–Ω–∞—è
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="2" data-filter-type="rooms" class="mr-2" onchange="handleRoomFilterChange()" {% if '2' in filters.rooms %}checked{% endif %}> 2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="3" data-filter-type="rooms" class="mr-2" onchange="handleRoomFilterChange()" {% if '3' in filters.rooms %}checked{% endif %}> 3-–∫–æ–º–Ω–∞—Ç–Ω–∞—è
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="4" data-filter-type="rooms" class="mr-2" onchange="handleRoomFilterChange()" {% if '4' in filters.rooms %}checked{% endif %}> 4-–∫–æ–º–Ω–∞—Ç–Ω–∞—è
                            </label>
                        </div>
                    </div>
                    
                    <!-- District Filter -->
                    <div class="dropdown relative search-filter-btn" data-filter="districts">
                        <button class="dropdown-btn px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2 border-r border-gray-200" onclick="toggleDropdown(event, this.parentElement.querySelector('.dropdown-menu'))">
                            <span id="districtFilterText">–†–∞–π–æ–Ω</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div class="dropdown-menu" style="max-height: 300px; overflow-y: auto;">
                            <div class="p-2">
                                <div class="text-xs text-gray-500 px-2 py-1">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞–π–æ–Ω–æ–≤...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Price Filter -->
                    <div class="dropdown relative search-filter-btn" data-filter="price">
                        <button class="dropdown-btn px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2 border-r border-gray-200" onclick="togglePricePanel(event); toggleDropdown(event, this.parentElement.querySelector('.dropdown-menu'))">
                            <span id="priceFilterText">–¶–µ–Ω–∞</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div class="dropdown-menu" style="min-width: 280px;">
                            <div class="p-3">
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-xs text-gray-600 mb-1 block">–û—Ç, –º–ª–Ω ‚ÇΩ</label>
                                        <input type="number" id="priceFrom" placeholder="1" min="0" step="0.1" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-600 mb-1 block">–î–æ, –º–ª–Ω ‚ÇΩ</label>
                                        <input type="number" id="priceTo" placeholder="20" min="0" step="0.1" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                    </div>
                                </div>
                                <button onclick="applyPriceFilter()" class="w-full bg-[#0088CC] text-white py-2 rounded mt-3 text-sm hover:opacity-90">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                            </div>
                        </div>
                    </div>

                    <!-- Search Input (with SuperSearch suggestions) -->
                    <div id="search-input-container" class="relative flex-grow">
                        <input id="property-search-desktop" class="w-full pl-4 pr-10 py-3 border-0 focus:ring-0 outline-none text-sm text-gray-700 bg-transparent" placeholder="–ì–æ—Ä–æ–¥, –∞–¥—Ä–µ—Å, –º–µ—Ç—Ä–æ, —Ä–∞–π–æ–Ω, –∂/–¥, —à–æ—Å—Å–µ –∏–ª–∏ –ñ–ö" type="text"/>
                        <!-- Close button (hidden by default) -->
                        <button id="search-close-btn" class="hidden absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors" onclick="closeExpandedSearch()" title="–ó–∞–∫—Ä—ã—Ç—å">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                        <!-- Search Suggestions (SuperSearch) -->
                        <div id="property-searchSuggestions" class="hidden absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg mt-1 shadow-lg z-50 max-h-64 overflow-y-auto">
                            <!-- Suggestions will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- –ù–∞–π—Ç–∏ Button -->
                    <button id="search-btn-desktop" class="search-filter-btn bg-gradient-to-r from-[#006699] to-[#0088CC] text-white px-6 py-3 rounded-xl font-medium hover:opacity-90 transition flex-shrink-0" onclick="applyFilters()">
                        <span id="search-btn-text-desktop">–ù–∞–π—Ç–∏</span>
                    </button>
                    
                    <!-- –§–∏–ª—å—Ç—Ä—ã Button with Badge -->
                    <button class="search-filter-btn flex items-center text-gray-600 hover:text-[#0088CC] px-3 py-1 rounded-lg text-sm relative" onclick="openFiltersModal()">
                        <div id="advancedFiltersCounter" class="hidden absolute -top-1 -right-1 bg-gradient-to-r from-[#0088CC] to-[#006699] text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center shadow-lg">0</div>
                        <svg class="h-5 w-5 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 10-2 0v1.268a2 2 0 000 3.464V16a1 1 0 102 0V8.732a2 2 0 000-3.464V4zM16 3a1 1 0 011 1v7.268a2 2 0 010 3.464V16a1 1 0 11-2 0v-1.268a2 2 0 010-3.464V4a1 1 0 011-1z"></path>
                        </svg>
                        –§–∏–ª—å—Ç—Ä—ã
                    </button>
                    
                    <!-- Save Search Button (DESKTOP ONLY) -->
                    <button onclick="openSaveSearchModal();" class="search-filter-btn flex items-center text-gray-600 hover:text-red-500 px-3 py-1 rounded-lg text-sm transition-all" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–∏—Å–∫">
                        <i class="fas fa-heart mr-1 text-lg"></i>
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                    
                    <!-- Developer Filter (MOVED TO ADVANCED FILTERS - hidden on main panel) -->
                    <div class="dropdown hidden" data-filter="developers">
                        <button class="dropdown-btn border border-gray-300 px-3 py-1.5 rounded text-sm hover:bg-gray-50 flex items-center gap-1" onclick="toggleDropdown(event, this.parentElement.querySelector('.dropdown-menu'))">
                            <span id="developerFilterText">–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div class="dropdown-menu" id="developers-dropdown-menu">
                            <!-- Will be populated dynamically by loadDevelopers() -->
                        </div>
                    </div>
                    
                    <!-- Completion Date Filter (MOVED TO ADVANCED FILTERS - hidden on main panel) -->
                    <div class="dropdown hidden" data-filter="completion">
                        <button class="dropdown-btn border border-gray-300 px-3 py-1.5 rounded text-sm hover:bg-gray-50 flex items-center gap-1" onclick="toggleDropdown(event, this.parentElement.querySelector('.dropdown-menu'))">
                            <span id="completionFilterText">–°–¥–∞—á–∞</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div class="dropdown-menu">
                            <label class="dropdown-item">
                                <input type="checkbox" value="2024" data-filter-type="completion" class="mr-2" onchange="updateAdvancedFiltersCounter();"> 2024
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="2025" data-filter-type="completion" class="mr-2" onchange="updateAdvancedFiltersCounter();"> 2025
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="2026" data-filter-type="completion" class="mr-2" onchange="updateAdvancedFiltersCounter();"> 2026
                            </label>
                            <label class="dropdown-item">
                                <input type="checkbox" value="2028" data-filter-type="completion" class="mr-2" onchange="updateAdvancedFiltersCounter();"> 2028
                            </label>
                        </div>
                    </div>
                </div>
                

            </div>
            
            <!-- –ë–ª–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ - –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –¥–∏–∑–∞–π–Ω -->
            <div id="active-filters-container" class="hidden mt-4">
                <div class="flex flex-wrap items-center gap-2">
                    <div id="active-filters-list" class="flex flex-wrap gap-2">
                        <!-- Active filters will be inserted here by JavaScript -->
                    </div>
                    <button id="clearAllFilters" class="text-sm text-gray-500 hover:text-gray-700 transition-colors ml-auto font-medium" onclick="console.log('‚úÖ –û–ß–ò–°–¢–ò–¢–¨ –í–°–ï - –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ /properties'); window.location.href='/' + citySlug + '/properties'; return false;">
                        –°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë
                    </button>
                </div>
            </div>
            
            <!-- Advanced Filters Panel -->
            <div id="advancedFiltersPanel" class="hidden mt-6 bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden flex flex-col" style="max-height: 100vh;">
                <!-- Header - Sticky Top -->
                <div class="bg-white border-b border-gray-200 px-4 py-3 sticky top-0 z-10">
                    <div class="flex items-center justify-between w-full gap-3">
                        <h3 class="text-lg font-semibold text-gray-800 flex-shrink-0">–§–∏–ª—å—Ç—Ä—ã</h3>
                        <div class="flex items-center gap-3">
                            <button id="resetAdvancedFiltersTop" onclick="resetAdvancedFilters();" class="text-[#0088CC] hover:text-[#006699] font-medium text-sm transition-colors flex-shrink-0">
                                –°–±—Ä–æ—Å–∏—Ç—å
                            </button>
                            <!-- Close button for mobile -->
                            <button id="closeAdvancedFiltersBtn" onclick="document.getElementById('advancedFiltersPanel').classList.add('hidden');" class="md:hidden text-gray-500 hover:text-gray-700 transition-colors flex-shrink-0">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Scrollable Content -->
                <div class="p-6 overflow-y-auto flex-1">
                    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-4 gap-6">
                        
                        <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ -->
                        <div class="space-y-4 min-w-0">
                            <h4 class="font-semibold text-gray-800 flex items-center border-b border-gray-200 pb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-[#0088CC]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z" />
                                </svg>
                                –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
                            </h4>
                            
                            <!-- –ü–ª–æ—â–∞–¥—å -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">–ü–ª–æ—â–∞–¥—å, –º¬≤</label>
                                <div class="flex gap-2">
                                    <input type="number" id="areaFrom" placeholder="–æ—Ç" class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent transition-all">
                                    <input type="number" id="areaTo" placeholder="–¥–æ" class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent transition-all">
                                </div>
                            </div>
                            
                            <!-- –≠—Ç–∞–∂ -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">–≠—Ç–∞–∂</label>
                                <div class="flex gap-2">
                                    <input type="number" id="floorFrom" placeholder="–æ—Ç" class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent transition-all">
                                    <input type="number" id="floorTo" placeholder="–¥–æ" class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent transition-all">
                                </div>
                            </div>
                            
                            <!-- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —ç—Ç–∞–∂ -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">–≠—Ç–∞–∂–Ω–æ—Å—Ç—å –¥–æ–º–∞</label>
                                <div class="flex gap-2">
                                    <input type="number" id="maxFloorFrom" placeholder="–æ—Ç" class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent transition-all">
                                    <input type="number" id="maxFloorTo" placeholder="–¥–æ" class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent transition-all">
                                </div>
                            </div>
                        </div>
                        
                        <!-- –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ -->
                        <div class="space-y-4 min-w-0">
                            <h4 class="font-semibold text-gray-800 flex items-center border-b border-gray-200 pb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-[#0088CC]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
                            </h4>
                            
                            <!-- –ö–ª–∞—Å—Å –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">–ö–ª–∞—Å—Å –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</label>
                                <div class="space-y-2">
                                    <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" value="–ë–∏–∑–Ω–µ—Å" data-filter-type="object_class" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="updateAdvancedFiltersCounter();" {% if "–ë–∏–∑–Ω–µ—Å" in filters.get("object_classes", []) %}checked{% endif %}>
                                        <span class="ml-2 text-sm text-gray-700">–ë–∏–∑–Ω–µ—Å</span>
                                    </label>
                                    <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" value="–ö–æ–º—Ñ–æ—Ä—Ç" data-filter-type="object_class" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="updateAdvancedFiltersCounter();" {% if "–ö–æ–º—Ñ–æ—Ä—Ç" in filters.get("object_classes", []) %}checked{% endif %}>
                                        <span class="ml-2 text-sm text-gray-700">–ö–æ–º—Ñ–æ—Ä—Ç</span>
                                    </label>
                                    <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" value="–ü—Ä–µ–º–∏—É–º" data-filter-type="object_class" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="updateAdvancedFiltersCounter();" {% if "–ü—Ä–µ–º–∏—É–º" in filters.get("object_classes", []) %}checked{% endif %}>
                                        <span class="ml-2 text-sm text-gray-700">–ü—Ä–µ–º–∏—É–º</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- –û—Ç–¥–µ–ª–∫–∞ -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">–û—Ç–¥–µ–ª–∫–∞</label>
                                <div class="space-y-2">
                                    <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" value="no_renovation" data-filter-type="renovation" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="updateAdvancedFiltersCounter();" {% if 'no_renovation' in filters.renovation %}checked{% endif %}>
                                        <span class="ml-2 text-sm text-gray-700">–ë–µ–∑ –æ—Ç–¥–µ–ª–∫–∏</span>
                                    </label>
                                    <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" value="fine_finish" data-filter-type="renovation" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="updateAdvancedFiltersCounter();" {% if 'fine_finish' in filters.renovation %}checked{% endif %}>
                                        <span class="ml-2 text-sm text-gray-700">–ß–∏—Å—Ç–æ–≤–∞—è</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è -->
                        <div class="space-y-4 min-w-0">
                            <h4 class="font-semibold text-gray-800 flex items-center border-b border-gray-200 pb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-[#0088CC]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                                –£—Å–ª–æ–≤–∏—è
                            </h4>
                            
                            <!-- –ò–ø–æ—Ç–µ–∫–∞ –∏ —Ñ–∏–Ω–∞–Ω—Å—ã -->
                            <div class="space-y-2">
                                <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                    <input type="checkbox" value="accreditation" data-filter-type="features" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="updateAdvancedFiltersCounter();">
                                    <span class="ml-2 text-sm text-gray-700">–ê–∫–∫—Ä–µ–¥–∏—Ç–∞—Ü–∏—è –±–∞–Ω–∫–æ–≤</span>
                                </label>
                                <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                    <input type="checkbox" value="green_mortgage" data-filter-type="features" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="updateAdvancedFiltersCounter();">
                                    <span class="ml-2 text-sm text-gray-700">–õ—å–≥–æ—Ç–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- –ü—Ä–æ—á–µ–µ -->
                        <div class="space-y-4 min-w-0">
                            <h4 class="font-semibold text-gray-800 flex items-center border-b border-gray-200 pb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-[#0088CC]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                                </svg>
                                –ü—Ä–æ—á–µ–µ
                            </h4>
                            
                            <!-- –ó–∞—Å—Ç—Ä–æ–π—â–∏–∫ -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫</label>
                                <div class="space-y-2 max-h-40 overflow-y-auto" id="developers-advanced-filters">
                                    <!-- Will be populated dynamically by loadDevelopers() -->
                                </div>
                            </div>
                            
                            <!-- –°—Ä–æ–∫ —Å–¥–∞—á–∏ -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">–°—Ä–æ–∫ —Å–¥–∞—á–∏</label>
                                <div class="space-y-2">
                                    <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" value="2024" data-filter-type="completion" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="updateAdvancedFiltersCounter();">
                                        <span class="ml-2 text-sm text-gray-700">2024</span>
                                    </label>
                                    <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" value="2025" data-filter-type="completion" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="updateAdvancedFiltersCounter();">
                                        <span class="ml-2 text-sm text-gray-700">2025</span>
                                    </label>
                                    <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" value="2026" data-filter-type="completion" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="updateAdvancedFiltersCounter();">
                                        <span class="ml-2 text-sm text-gray-700">2026</span>
                                    </label>
                                    <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                        <input type="checkbox" value="2028" data-filter-type="completion" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="updateAdvancedFiltersCounter();">
                                        <span class="ml-2 text-sm text-gray-700">2028</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- –°—Ç–∞—Ç—É—Å —Å–¥–∞—á–∏ -->
                            <div class="space-y-2">
                                <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                    <input type="checkbox" value="true" data-filter-type="building_released" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="updateAdvancedFiltersCounter();" {% if "true" in filters.get("building_released", []) %}checked{% endif %}>
                                    <span class="ml-2 text-sm text-gray-700">–°–¥–∞–Ω–Ω—ã–π –¥–æ–º</span>
                                </label>
                                <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg transition-colors cursor-pointer">
                                    <input type="checkbox" value="false" data-filter-type="building_released" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded" onchange="updateAdvancedFiltersCounter();" {% if "false" in filters.get("building_released", []) %}checked{% endif %}>
                                    <span class="ml-2 text-sm text-gray-700">–í —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–µ</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                </div>
                
                <!-- Footer - Sticky Bottom (—Ç–æ–ª—å–∫–æ –Ω–∞ –º–æ–±–∞–π–ª–µ) -->
                <div class="bg-white border-t border-gray-200 p-4 sticky bottom-0 z-10">
                    <button id="applyAdvancedFilters" onclick="applyFilters();" class="w-full py-3 bg-gradient-to-r from-[#0088CC] to-[#006699] text-white rounded-lg hover:from-[#006699] hover:to-[#004477] transition-all duration-300 shadow-lg font-medium text-base">
                        –ü–æ–∫–∞–∑–∞—Ç—å <span id="filteredResultsCount">{{ total_properties or 0 }}</span> –æ–±—ä—è–≤–ª–µ–Ω–∏–π
                    </button>
                </div>
            </div>
            
            <!-- Rooms Filter Modal Panel (Mobile) -->
            <div id="roomsFilterPanel" class="hidden mt-6 bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden flex flex-col" style="max-height: 100vh;">
                <!-- Header - Sticky Top -->
                <div class="bg-white border-b border-gray-200 px-4 py-3 sticky top-0 z-10">
                    <div class="flex items-center justify-between w-full gap-3">
                        <h3 class="text-lg font-semibold text-gray-800 flex-shrink-0">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç</h3>
                        <div class="flex items-center gap-3">
                            <button onclick="resetRoomsFilter();" class="text-[#0088CC] hover:text-[#006699] font-medium text-sm transition-colors flex-shrink-0">
                                –°–±—Ä–æ—Å–∏—Ç—å
                            </button>
                            <button onclick="document.getElementById('roomsFilterPanel').classList.add('hidden'); document.getElementById('roomsFilterPanel').classList.remove('mobile-fullscreen'); document.body.style.overflow = '';" class="md:hidden text-gray-500 hover:text-gray-700 transition-colors flex-shrink-0">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Content -->
                <div class="p-6 overflow-y-auto flex-1">
                    <div class="space-y-3">
                        <label class="flex items-center hover:bg-gray-50 p-3 rounded-lg transition-colors cursor-pointer border border-gray-200">
                            <input type="checkbox" value="0" data-filter-type="rooms" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded w-5 h-5" onchange="if(typeof window.updateFilteredCount === 'function') window.updateFilteredCount();">
                            <span class="ml-3 text-base text-gray-700">–°—Ç—É–¥–∏—è</span>
                        </label>
                        <label class="flex items-center hover:bg-gray-50 p-3 rounded-lg transition-colors cursor-pointer border border-gray-200">
                            <input type="checkbox" value="1" data-filter-type="rooms" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded w-5 h-5" onchange="if(typeof window.updateFilteredCount === 'function') window.updateFilteredCount();">
                            <span class="ml-3 text-base text-gray-700">1-–∫–æ–º–Ω–∞—Ç–Ω–∞—è</span>
                        </label>
                        <label class="flex items-center hover:bg-gray-50 p-3 rounded-lg transition-colors cursor-pointer border border-gray-200">
                            <input type="checkbox" value="2" data-filter-type="rooms" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded w-5 h-5" onchange="if(typeof window.updateFilteredCount === 'function') window.updateFilteredCount();">
                            <span class="ml-3 text-base text-gray-700">2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è</span>
                        </label>
                        <label class="flex items-center hover:bg-gray-50 p-3 rounded-lg transition-colors cursor-pointer border border-gray-200">
                            <input type="checkbox" value="3" data-filter-type="rooms" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded w-5 h-5" onchange="if(typeof window.updateFilteredCount === 'function') window.updateFilteredCount();">
                            <span class="ml-3 text-base text-gray-700">3-–∫–æ–º–Ω–∞—Ç–Ω–∞—è</span>
                        </label>
                        <label class="flex items-center hover:bg-gray-50 p-3 rounded-lg transition-colors cursor-pointer border border-gray-200">
                            <input type="checkbox" value="4" data-filter-type="rooms" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded w-5 h-5" onchange="if(typeof window.updateFilteredCount === 'function') window.updateFilteredCount();">
                            <span class="ml-3 text-base text-gray-700">4-–∫–æ–º–Ω–∞—Ç–Ω–∞—è</span>
                        </label>
                    </div>
                </div>
                
                <!-- Footer - Sticky Bottom -->
                <div class="bg-white border-t border-gray-200 p-4 sticky bottom-0 z-10">
                    <button onclick="applyRoomsFilter();" class="w-full py-3 bg-gradient-to-r from-[#0088CC] to-[#006699] text-white rounded-lg hover:from-[#006699] hover:to-[#004477] transition-all duration-300 shadow-lg font-medium text-base">
                        –ü–æ–∫–∞–∑–∞—Ç—å <span id="roomsFilteredCount">{{ total_properties or 0 }}</span> –æ–±—ä—è–≤–ª–µ–Ω–∏–π
                    </button>
                </div>
            </div>
            
            <!-- Price Filter Modal Panel (Mobile) -->
            <div id="priceFilterPanel" class="hidden mt-6 bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden flex flex-col" style="max-height: 100vh;">
                <!-- Header - Sticky Top -->
                <div class="bg-white border-b border-gray-200 px-4 py-3 sticky top-0 z-10">
                    <div class="flex items-center justify-between w-full gap-3">
                        <h3 class="text-lg font-semibold text-gray-800 flex-shrink-0">–¶–µ–Ω–∞</h3>
                        <div class="flex items-center gap-3">
                            <button onclick="resetPriceFilter();" class="text-[#0088CC] hover:text-[#006699] font-medium text-sm transition-colors flex-shrink-0">
                                –°–±—Ä–æ—Å–∏—Ç—å
                            </button>
                            <button onclick="document.getElementById('priceFilterPanel').classList.add('hidden'); document.getElementById('priceFilterPanel').classList.remove('mobile-fullscreen'); document.body.style.overflow = '';" class="md:hidden text-gray-500 hover:text-gray-700 transition-colors flex-shrink-0">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Content -->
                <div class="p-6 overflow-y-auto flex-1">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">–¶–µ–Ω–∞, –º–ª–Ω ‚ÇΩ</label>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <input type="number" id="priceFromModal" placeholder="–û—Ç" min="0" step="0.1" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-[#0088CC] focus:border-transparent transition-all" oninput="if(typeof window.updateFilteredCount === 'function') window.updateFilteredCount();">
                                </div>
                                <div>
                                    <input type="number" id="priceToModal" placeholder="–î–æ" min="0" step="0.1" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-[#0088CC] focus:border-transparent transition-all" oninput="if(typeof window.updateFilteredCount === 'function') window.updateFilteredCount();">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Footer - Sticky Bottom -->
                <div class="bg-white border-t border-gray-200 p-4 sticky bottom-0 z-10">
                    <button onclick="applyPriceFilterModal();" class="w-full py-3 bg-gradient-to-r from-[#0088CC] to-[#006699] text-white rounded-lg hover:from-[#006699] hover:to-[#004477] transition-all duration-300 shadow-lg font-medium text-base">
                        –ü–æ–∫–∞–∑–∞—Ç—å <span id="priceFilteredCount">{{ total_properties or 0 }}</span> –æ–±—ä—è–≤–ª–µ–Ω–∏–π
                    </button>
                </div>
            </div>
            
            <!-- Developer Filter Modal Panel (Mobile) -->
            <div id="developerFilterPanel" class="hidden mt-6 bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden flex flex-col" style="max-height: 100vh;">
                <!-- Header - Sticky Top -->
                <div class="bg-white border-b border-gray-200 px-4 py-3 sticky top-0 z-10">
                    <div class="flex items-center justify-between w-full gap-3">
                        <h3 class="text-lg font-semibold text-gray-800 flex-shrink-0">–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫</h3>
                        <div class="flex items-center gap-3">
                            <button onclick="resetDeveloperFilter();" class="text-[#0088CC] hover:text-[#006699] font-medium text-sm transition-colors flex-shrink-0">
                                –°–±—Ä–æ—Å–∏—Ç—å
                            </button>
                            <button onclick="document.getElementById('developerFilterPanel').classList.add('hidden');" class="md:hidden text-gray-500 hover:text-gray-700 transition-colors flex-shrink-0">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Content -->
                <div class="p-6 overflow-y-auto flex-1">
                    <div class="space-y-3" id="developers-modal-panel">
                        <!-- Will be populated dynamically by loadDevelopers() -->
                    </div>
                </div>
                
                <!-- Footer - Sticky Bottom -->
                <div class="bg-white border-t border-gray-200 p-4 sticky bottom-0 z-10">
                    <button onclick="applyDeveloperFilter();" class="w-full py-3 bg-gradient-to-r from-[#0088CC] to-[#006699] text-white rounded-lg hover:from-[#006699] hover:to-[#004477] transition-all duration-300 shadow-lg font-medium text-base">
                        –ü–æ–∫–∞–∑–∞—Ç—å <span id="developerFilteredCount">{{ total_properties or 0 }}</span> –æ–±—ä—è–≤–ª–µ–Ω–∏–π
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Search Modal Panel (Fullscreen Overlay) -->
<div id="searchModalPanel" class="hidden fixed inset-0 z-[9999] bg-white overflow-hidden flex flex-col" onclick="if(event.target === this) closeSearchModal();">
    <!-- Header - Sticky Top -->
    <div class="bg-gradient-to-r from-[#0088CC] to-[#006699] px-4 py-4 sticky top-0 z-10" onclick="event.stopPropagation();">
        <div class="flex items-center justify-between w-full gap-3">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-search text-white text-lg"></i>
                </div>
                <h3 class="text-lg font-semibold text-white">–£–º–Ω—ã–π –ø–æ–∏—Å–∫</h3>
            </div>
            <button onclick="closeSearchModal();" class="text-white/90 hover:text-white transition-colors flex-shrink-0">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </div>
    
    <!-- Content -->
    <div class="p-4 overflow-y-auto flex-1 bg-white">
        <!-- Search Input -->
        <div class="mb-4">
            <div class="relative">
                <input type="text" 
                       id="modal-search-input"
                       placeholder="–†–∞–π–æ–Ω, –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫, –ñ–ö, —Ç–∏–ø –∫–≤–∞—Ä—Ç–∏—Ä—ã..." 
                       class="w-full pl-4 pr-10 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-[#0088CC] focus:border-blue-500 outline-none transition-all text-base text-gray-700 bg-gray-50"
                       autocomplete="off"
                       onkeypress="if(event.key === 'Enter') { event.preventDefault(); performSearchFromModal(this.value); }">
                <button onclick="clearModalSearch();" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
        </div>
        
        <!-- Search History -->
        <div id="searchHistory" class="mb-6">
            <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                <i class="fas fa-history text-gray-400"></i>
                –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∏—Å–∫–∞
            </h4>
            <div id="searchHistoryList" class="space-y-2">
                <!-- –ò—Å—Ç–æ—Ä–∏—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ —á–µ—Ä–µ–∑ JavaScript -->
            </div>
        </div>
        
        <!-- Popular Searches -->
        <div id="popularSearches" class="mb-6">
            <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                <i class="fas fa-fire text-orange-500"></i>
                –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
            </h4>
            <div id="popularSearchesList" class="flex flex-wrap gap-2">
                <!-- –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ API -->
                <div class="text-sm text-gray-400 italic">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
    </div>
</div>

<!-- Save Search Modal Panel (Responsive: Fullscreen on Mobile, Centered on Desktop) -->
<div id="saveSearchModal" class="hidden fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4 md:p-0">
    <!-- Modal Container -->
    <div class="bg-white w-full h-full md:h-auto md:max-w-lg md:rounded-2xl md:shadow-2xl overflow-hidden flex flex-col md:max-h-[90vh]">
                <!-- Header - Sticky Top -->
                <div class="bg-gradient-to-r from-[#0088CC] to-[#006699] px-4 py-4 md:rounded-t-2xl sticky top-0 z-10">
                    <div class="flex items-center justify-between w-full gap-3">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
                                <i class="fas fa-heart text-white text-lg"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-white">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–∏—Å–∫</h3>
                        </div>
                        <button onclick="closeSaveSearchModal();" class="text-white/90 hover:text-white transition-colors flex-shrink-0">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Content -->
                <div class="p-6 overflow-y-auto flex-1 bg-gray-50">
                    <div class="space-y-5">
                        <!-- Info Card -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0 w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mt-0.5">
                                    <i class="fas fa-info-circle text-blue-600 text-sm"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm text-blue-900 leading-relaxed">
                                        –ú—ã –±—É–¥–µ–º –ø—Ä–∏—Å—ã–ª–∞—Ç—å –≤–∞–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏—è—Ö, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –≤–∞—à–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Search Name Input -->
                        <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
                            <label class="block text-sm font-medium text-gray-700 mb-3">
                                <i class="fas fa-tag text-gray-400 mr-2"></i>–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∏—Å–∫–∞
                            </label>
                            <input type="text" 
                                   id="searchNameInputModal" 
                                   placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 2-–∫–æ–º–Ω –≤ –¶–µ–Ω—Ç—Ä–µ –¥–æ 6 –º–ª–Ω" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-[#0088CC] focus:border-[#0088CC] transition-all">
                            <p class="text-xs text-gray-500 mt-2">
                                <i class="fas fa-lightbulb text-yellow-500 mr-1"></i>
                                –ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–æ–Ω—è—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –≤–∞—à–∏—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
                            </p>
                        </div>
                        
                        {% if is_manager %}
                        <!-- Manager: Client Email Input -->
                        <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
                            <label class="block text-sm font-medium text-gray-700 mb-3">
                                <i class="fas fa-envelope text-gray-400 mr-2"></i>Email –∫–ª–∏–µ–Ω—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                            </label>
                            <input type="email" 
                                   id="clientEmailInputModal" 
                                   placeholder="client@example.com" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg text-base focus:ring-2 focus:ring-[#0088CC] focus:border-[#0088CC] transition-all">
                            <p class="text-xs text-gray-500 mt-2">
                                <i class="fas fa-user-tie text-gray-400 mr-1"></i>
                                –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω, –ø–æ–∏—Å–∫ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–ª–∏–µ–Ω—Ç—É
                            </p>
                        </div>
                        {% endif %}
                        
                        <!-- Current Filters Preview -->
                        <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
                            <label class="block text-sm font-medium text-gray-700 mb-3">
                                <i class="fas fa-filter text-gray-400 mr-2"></i>–í–∞—à–∏ —Ñ–∏–ª—å—Ç—Ä—ã
                            </label>
                            <div id="currentFiltersPreview" class="space-y-2 text-sm text-gray-600">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Footer - Sticky Bottom -->
                <div class="bg-white border-t border-gray-200 p-4 md:rounded-b-2xl sticky bottom-0 z-10">
                    <button onclick="saveSearchFromModal();" class="w-full py-3.5 bg-gradient-to-r from-[#0088CC] to-[#006699] text-white rounded-lg hover:from-[#006699] hover:to-[#004477] transition-all duration-300 shadow-lg font-semibold text-base flex items-center justify-center gap-2">
                        <i class="fas fa-heart"></i>
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–∏—Å–∫
                    </button>
                </div>
            </div>
        </div>
</div>

</section>

<!-- Main Content Section -->
<section class="container mx-auto px-4 py-6">
    <div class="w-full mx-auto">
        
        <!-- Mini Map Section (Avito-style) -->
        <div class="mb-6 bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <!-- Mini Map Preview -->
            <div id="miniPropertiesMap" class="w-full relative" style="height: 200px; cursor: pointer;" onclick="handleMapClick(event)">
                <div class="absolute inset-0 bg-gradient-to-br from-blue-50 to-blue-100 flex items-center justify-center">
                    <div class="text-center">
                        <svg class="w-16 h-16 mx-auto text-[#0088CC] opacity-50 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <p class="text-sm text-gray-600">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</p>
                    </div>
                </div>
            </div>
            
            <!-- Map Link Button -->
            <button onclick="openFullscreenMap()" class="w-full p-4 border-t border-gray-200 hover:bg-gray-50 transition-colors cursor-pointer">
                <div class="flex items-center justify-center gap-3">
                    <svg class="w-5 h-5 text-[#0088CC]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                    </svg>
                    <span class="font-semibold text-gray-900">–ü–æ–∫–∞–∑–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ</span>
                    <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">{{ total_properties or 0 }}</span>
                </div>
            </button>
        </div>

        <!-- Fullscreen Map Modal (Mobile) -->
        <div id="fullscreenMapModal" 
             class="fixed inset-0 bg-white z-50 hidden" 
             role="dialog" 
             aria-modal="true" 
             aria-labelledby="mapModalTitle">
            <!-- Modal Header -->
            <div class="bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between sticky top-0 z-10">
                <div class="flex items-center gap-3">
                    <button onclick="closeFullscreenMap()" 
                            class="p-2 hover:bg-gray-100 rounded-full transition-colors"
                            aria-label="–ó–∞–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É">
                        <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                    <h3 id="mapModalTitle" class="font-semibold text-gray-900">–û–±—ä–µ–∫—Ç—ã –Ω–∞ –∫–∞—Ä—Ç–µ</h3>
                </div>
                <div class="flex items-center gap-2">
                    <span id="mapObjectsCount" class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">0</span>
                    <button onclick="closeFullscreenMap()" 
                            class="px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg text-sm font-medium hover:from-blue-700 hover:to-blue-800 transition-all shadow-md flex items-center gap-2"
                            aria-label="–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                        </svg>
                        –°–ø–∏—Å–æ–∫
                    </button>
                </div>
            </div>
            
            <!-- Filter Toolbar for Map -->
            <div id="mapFilterToolbar" class="bg-white border-b border-gray-200 px-3 py-2 sticky top-[60px] z-[9]">
                <div class="flex items-center gap-2 overflow-x-auto" style="-webkit-overflow-scrolling: touch; scrollbar-width: none; -ms-overflow-style: none;">
                    <!-- Filter Button - ICON ONLY with Badge -->
                    <button id="mapQuickFiltersBtn" onclick="openMapQuickFilters()" 
                            class="relative flex-shrink-0 p-2.5 rounded-full border-2 border-blue-600 text-blue-600 hover:bg-blue-50 transition-all shadow-sm"
                            aria-label="–û—Ç–∫—Ä—ã—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0-4v2m0-6V4"></path>
                        </svg>
                        <!-- Filter Badge (–Ω–∞ –∫–∞—Ä—Ç–µ) -->
                        <span id="advancedFiltersCounterMap" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">0</span>
                    </button>
                    
                    <!-- Quick Room Filters -->
                    <button data-toolbar-room="0" onclick="toggleToolbarRoomFilter(0)" 
                            class="toolbar-room-chip flex-shrink-0 px-3 py-1.5 rounded-full border border-gray-300 text-xs font-medium whitespace-nowrap transition-all hover:border-blue-500">
                        –°—Ç—É–¥–∏—è
                    </button>
                    <button data-toolbar-room="1" onclick="toggleToolbarRoomFilter(1)" 
                            class="toolbar-room-chip flex-shrink-0 px-3 py-1.5 rounded-full border border-gray-300 text-xs font-medium whitespace-nowrap transition-all hover:border-blue-500">
                        1–∫
                    </button>
                    <button data-toolbar-room="2" onclick="toggleToolbarRoomFilter(2)" 
                            class="toolbar-room-chip flex-shrink-0 px-3 py-1.5 rounded-full border border-gray-300 text-xs font-medium whitespace-nowrap transition-all hover:border-blue-500">
                        2–∫
                    </button>
                    <button data-toolbar-room="3" onclick="toggleToolbarRoomFilter(3)" 
                            class="toolbar-room-chip flex-shrink-0 px-3 py-1.5 rounded-full border border-gray-300 text-xs font-medium whitespace-nowrap transition-all hover:border-blue-500">
                        3–∫
                    </button>
                    <button data-toolbar-room="4" onclick="toggleToolbarRoomFilter(4)" 
                            class="toolbar-room-chip flex-shrink-0 px-3 py-1.5 rounded-full border border-gray-300 text-xs font-medium whitespace-nowrap transition-all hover:border-blue-500">
                        4+–∫
                    </button>
                    
                    <!-- Quick Price Filter -->
                    <button id="mapToolbarPriceBtn" onclick="openMapQuickFilters()" 
                            class="flex-shrink-0 px-3 py-1.5 rounded-full border border-gray-300 text-xs font-medium whitespace-nowrap transition-all hover:border-blue-500">
                        –¶–µ–Ω–∞
                    </button>
                </div>
                
                <!-- Loading Indicator -->
                <div id="mapFilterLoading" class="hidden mt-2 flex items-center gap-2 text-sm text-gray-600">
                    <svg class="animate-spin h-4 w-4 text-blue-600" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã...</span>
                </div>
            </div>
            
            <!-- Quick Filters Bottom Sheet -->
            <div id="mapQuickFiltersBackdrop" 
                 class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden transition-opacity duration-300"
                 style="opacity: 0;"
                 onclick="closeMapQuickFilters()">
            </div>
            
            <div id="mapQuickFiltersSheet" 
                 class="fixed bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-2xl z-[70] hidden w-full max-w-full"
                 style="transform: translateY(100%); transition: transform 0.3s ease-out; max-height: 85vh;">
                <!-- Sheet Header -->
                <div class="sticky top-0 bg-white rounded-t-3xl px-4 py-3 border-b border-gray-200 z-10 w-full">
                    <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-3"></div>
                    <div class="flex items-center justify-between w-full">
                        <h3 class="text-lg font-bold text-gray-900">–§–∏–ª—å—Ç—Ä—ã</h3>
                        <div class="flex items-center gap-2">
                            <button onclick="resetQuickFilters()" 
                                    class="text-blue-600 hover:text-blue-700 font-medium text-sm">
                                –°–±—Ä–æ—Å–∏—Ç—å
                            </button>
                            <button onclick="closeMapQuickFilters()" 
                                    class="p-2 hover:bg-gray-100 rounded-full transition-colors"
                                    aria-label="–ó–∞–∫—Ä—ã—Ç—å">
                                <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Sheet Content - Scrollable -->
                <div class="overflow-y-auto px-4 py-4 space-y-6 w-full" style="max-height: calc(85vh - 140px); scroll-behavior: smooth; -webkit-overflow-scrolling: touch;">
                    <!-- Rooms Filter -->
                    <div class="w-full">
                        <label class="block text-sm font-semibold text-gray-800 mb-3">–ö–æ–º–Ω–∞—Ç–Ω–æ—Å—Ç—å</label>
                        <div class="flex flex-wrap gap-2">
                            <button data-quick-room="0" onclick="toggleQuickRoomFilter(0)" 
                                    class="quick-room-chip px-4 py-2 rounded-full border-2 border-gray-300 text-sm font-medium transition-all hover:border-blue-500">
                                –°—Ç—É–¥–∏—è
                            </button>
                            <button data-quick-room="1" onclick="toggleQuickRoomFilter(1)" 
                                    class="quick-room-chip px-4 py-2 rounded-full border-2 border-gray-300 text-sm font-medium transition-all hover:border-blue-500">
                                1-–∫–æ–º–Ω
                            </button>
                            <button data-quick-room="2" onclick="toggleQuickRoomFilter(2)" 
                                    class="quick-room-chip px-4 py-2 rounded-full border-2 border-gray-300 text-sm font-medium transition-all hover:border-blue-500">
                                2-–∫–æ–º–Ω
                            </button>
                            <button data-quick-room="3" onclick="toggleQuickRoomFilter(3)" 
                                    class="quick-room-chip px-4 py-2 rounded-full border-2 border-gray-300 text-sm font-medium transition-all hover:border-blue-500">
                                3-–∫–æ–º–Ω
                            </button>
                            <button data-quick-room="4" onclick="toggleQuickRoomFilter(4)" 
                                    class="quick-room-chip px-4 py-2 rounded-full border-2 border-gray-300 text-sm font-medium transition-all hover:border-blue-500">
                                4+–∫–æ–º–Ω
                            </button>
                        </div>
                    </div>
                    
                    <!-- Price Range -->
                    <div class="w-full">
                        <label class="block text-sm font-semibold text-gray-800 mb-3">–¶–µ–Ω–∞, –º–ª–Ω ‚ÇΩ</label>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="number" id="quickPriceFrom" placeholder="–æ—Ç" 
                                   class="px-4 py-3 border-2 border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-full">
                            <input type="number" id="quickPriceTo" placeholder="–¥–æ" 
                                   class="px-4 py-3 border-2 border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-full">
                        </div>
                    </div>
                    
                    <!-- Area Range -->
                    <div class="w-full">
                        <label class="block text-sm font-semibold text-gray-800 mb-3">–ü–ª–æ—â–∞–¥—å, –º¬≤</label>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="number" id="quickAreaFrom" placeholder="–æ—Ç" 
                                   class="px-4 py-3 border-2 border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-full">
                            <input type="number" id="quickAreaTo" placeholder="–¥–æ" 
                                   class="px-4 py-3 border-2 border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-full">
                        </div>
                    </div>
                    
                    <!-- More Filters Link -->
                    <button onclick="openMapAdvancedFiltersFromQuick()" 
                            class="w-full py-3 px-4 border-2 border-gray-300 text-gray-700 rounded-xl font-medium hover:border-blue-500 hover:text-blue-600 transition-all flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        –ë–æ–ª—å—à–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
                    </button>
                </div>
                
                <!-- Sheet Footer -->
                <div class="bg-white border-t border-gray-200 p-4 sticky bottom-0 w-full">
                    <button onclick="applyQuickFilters()" 
                            class="w-full py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl font-semibold hover:from-blue-700 hover:to-blue-800 transition-all shadow-lg">
                        –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                    </button>
                </div>
            </div>
            
            <!-- Advanced Filters Modal for Map -->
            <div id="mapAdvancedFiltersModal" class="hidden fixed inset-0 bg-white z-[60] w-full">
                <!-- Header -->
                <div class="bg-white border-b border-gray-200 px-4 py-3 sticky top-0 z-10 flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-800">–§–∏–ª—å—Ç—Ä—ã</h3>
                    <div class="flex items-center gap-3">
                        <button onclick="resetMapAdvancedFilters()" class="text-blue-600 hover:text-blue-700 font-medium text-sm">
                            –°–±—Ä–æ—Å–∏—Ç—å
                        </button>
                        <button onclick="closeMapAdvancedFilters()" 
                                class="p-2 hover:bg-gray-100 rounded-full transition-colors"
                                aria-label="–ó–∞–∫—Ä—ã—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã">
                            <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Scrollable Content -->
                <div class="overflow-y-auto p-4 space-y-6 w-full" style="height: calc(100vh - 120px);">
                    <!-- Price Range -->
                    <div class="w-full">
                        <label class="block text-sm font-medium text-gray-700 mb-2">–¶–µ–Ω–∞, –º–ª–Ω ‚ÇΩ</label>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="number" id="mapPriceFrom" placeholder="–æ—Ç" 
                                   class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 w-full">
                            <input type="number" id="mapPriceTo" placeholder="–¥–æ" 
                                   class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 w-full">
                        </div>
                    </div>
                    
                    <!-- Area -->
                    <div class="w-full">
                        <label class="block text-sm font-medium text-gray-700 mb-2">–ü–ª–æ—â–∞–¥—å, –º¬≤</label>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="number" id="mapAreaFrom" placeholder="–æ—Ç" 
                                   class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 w-full">
                            <input type="number" id="mapAreaTo" placeholder="–¥–æ" 
                                   class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 w-full">
                        </div>
                    </div>
                    
                    <!-- Floor -->
                    <div class="w-full">
                        <label class="block text-sm font-medium text-gray-700 mb-2">–≠—Ç–∞–∂</label>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="number" id="mapFloorFrom" placeholder="–æ—Ç" 
                                   class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 w-full">
                            <input type="number" id="mapFloorTo" placeholder="–¥–æ" 
                                   class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 w-full">
                        </div>
                    </div>
                    
                    <!-- Developers -->
                    <div>
                        <button onclick="toggleMapDevelopersList()" 
                                class="w-full flex items-center justify-between text-sm font-medium text-gray-700 mb-2 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                            <span>–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫</span>
                            <svg id="mapDevelopersChevron" class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div id="mapDevelopersList" class="hidden space-y-2 max-h-60 overflow-y-auto">
                            <!-- Will be populated dynamically by loadDevelopers() -->
                        </div>
                    </div>
                    
                    <!-- Completion Date -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–°—Ä–æ–∫ —Å–¥–∞—á–∏</label>
                        <div class="space-y-2">
                            <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg cursor-pointer">
                                <input type="checkbox" value="2024" data-map-filter="completion" 
                                       class="text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <span class="ml-2 text-sm text-gray-700">2024</span>
                            </label>
                            <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg cursor-pointer">
                                <input type="checkbox" value="2025" data-map-filter="completion" 
                                       class="text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <span class="ml-2 text-sm text-gray-700">2025</span>
                            </label>
                            <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg cursor-pointer">
                                <input type="checkbox" value="2026" data-map-filter="completion" 
                                       class="text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <span class="ml-2 text-sm text-gray-700">2026</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Object Class -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">–ö–ª–∞—Å—Å –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</label>
                        <div class="space-y-2">
                            <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg cursor-pointer">
                                <input type="checkbox" value="–ö–æ–º—Ñ–æ—Ä—Ç" data-map-filter="object_class" 
                                       class="text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <span class="ml-2 text-sm text-gray-700">–ö–æ–º—Ñ–æ—Ä—Ç</span>
                            </label>
                            <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg cursor-pointer">
                                <input type="checkbox" value="–ë–∏–∑–Ω–µ—Å" data-map-filter="object_class" 
                                       class="text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <span class="ml-2 text-sm text-gray-700">–ë–∏–∑–Ω–µ—Å</span>
                            </label>
                            <label class="flex items-center hover:bg-gray-50 p-2 rounded-lg cursor-pointer">
                                <input type="checkbox" value="–ü—Ä–µ–º–∏—É–º" data-map-filter="object_class" 
                                       class="text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <span class="ml-2 text-sm text-gray-700">–ü—Ä–µ–º–∏—É–º</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Footer -->
                <div class="bg-white border-t border-gray-200 p-4 sticky bottom-0">
                    <button onclick="applyMapAdvancedFilters()" 
                            class="w-full py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg font-medium hover:from-blue-700 hover:to-blue-800 transition-all shadow-lg">
                        –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                    </button>
                </div>
            </div>
            
            <!-- Map Container -->
            <div id="fullscreenMapContainer" class="w-full h-full relative" style="height: calc(100vh - 140px);" aria-label="–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ —Å –æ–±—ä–µ–∫—Ç–∞–º–∏ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏">
                <!-- Return to List Button - Bottom Left -->
                <button onclick="closeFullscreenMap()" 
                        class="absolute bottom-6 left-4 z-[10] px-5 py-3 bg-white text-gray-900 rounded-xl shadow-lg text-sm font-semibold hover:bg-gray-50 transition-all flex items-center gap-2 border border-gray-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                    </svg>
                    –°–ø–∏—Å–æ–∫
                </button>
            </div>
        </div>

        <!-- Mobile Bottom Sheet for Property Cards -->
        <div id="bottomSheetBackdrop" 
             class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden transition-opacity duration-300"
             style="opacity: 0;"
             onclick="closePropertyBottomSheet()">
        </div>
        
        <div id="propertyBottomSheet" 
             class="fixed bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-2xl z-[70] hidden"
             style="transform: translateY(100%); transition: transform 0.3s ease-out; max-height: 70vh;">
            <!-- Bottom Sheet Header -->
            <div class="sticky top-0 bg-white rounded-t-3xl px-4 py-3 border-b border-gray-200 z-10">
                <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-3"></div>
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-bold text-gray-900">–ö–≤–∞—Ä—Ç–∏—Ä—ã –≤ —ç—Ç–æ–π —Ç–æ—á–∫–µ</h3>
                    <button onclick="closePropertyBottomSheet()" 
                            class="p-2 hover:bg-gray-100 rounded-full transition-colors"
                            aria-label="–ó–∞–∫—Ä—ã—Ç—å">
                        <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Bottom Sheet Content - Vertical Scroll -->
            <div id="bottomSheetPropertiesContainer" 
                 class="overflow-y-auto px-4 py-2 space-y-3"
                 style="max-height: 60vh; scroll-behavior: smooth; -webkit-overflow-scrolling: touch;">
                <!-- Property cards will be inserted here dynamically -->
            </div>
        </div>

        <!-- Results Header -->
        <div id="properties-toolbar" class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-900">
                    {% if results_text %}
                        {{ results_text }}
                    {% else %}
                        –ù–∞–π–¥–µ–Ω–æ <span id="results-count">{{ total_properties or 0 }}</span> 
                        {% set count = total_properties or 0 %}
                        {% if count % 100 in [11, 12, 13, 14] %}–æ–±—ä–µ–∫—Ç–æ–≤
                        {% elif count % 10 == 1 %}–æ–±—ä–µ–∫—Ç
                        {% elif count % 10 in [2, 3, 4] %}–æ–±—ä–µ–∫—Ç–∞
                        {% else %}–æ–±—ä–µ–∫—Ç–æ–≤{% endif %}
                    {% endif %}
                </h3>
                <div class="flex gap-2">
                    <button onclick="openApplicationModal()" class="hidden md:flex px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors items-center gap-2 text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                        </svg>
                        –°–≤—è–∑–∞—Ç—å—Å—è
                    </button>
                    <!-- Sort dropdown - —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –Ω–∞ desktop, –∏ –Ω–∞ mobile -->
                    <select id="sort-select" class="border border-gray-300 rounded-lg px-3 py-2 text-sm w-full md:w-auto">
                        <option value="">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
                        <option value="price-asc">–ü–æ —Ü–µ–Ω–µ ‚Üë</option>
                        <option value="price-desc">–ü–æ —Ü–µ–Ω–µ ‚Üì</option>
                        <option value="area-asc">–ü–æ –ø–ª–æ—â–∞–¥–∏ ‚Üë</option>
                        <option value="area-desc">–ü–æ –ø–ª–æ—â–∞–¥–∏ ‚Üì</option>
                        <option value="date-desc">–ü–æ –¥–∞—Ç–µ ‚Üì</option>
                    </select>
                    
                    <!-- View Toggle -->
                    <div class="hidden md:flex items-center bg-gray-100 rounded-lg p-1">
                        <button id="list-view-btn" onclick="switchToListView()" class="flex items-center gap-1 px-3 py-2 rounded-md text-sm font-medium transition-colors bg-white text-gray-900 shadow-sm">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 16a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"/>
                            </svg>
                            –°–ø–∏—Å–æ–∫
                        </button>
                        <button id="grid-view-btn" onclick="switchToGridView()" class="flex items-center gap-1 px-3 py-2 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-900">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
                            </svg>
                            –°–µ—Ç–∫–∞
                        </button>
                    </div>
                    
                    <!-- Map CTA with Enhanced Background -->
                    <div class="hidden md:block relative rounded-2xl overflow-hidden p-3" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 50%, #90caf9 100%); min-width: 160px;">
                        <!-- Enhanced SVG Map Pattern Background -->
                        <svg class="absolute inset-0 w-full h-full" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <pattern id="map-grid" x="0" y="0" width="30" height="30" patternUnits="userSpaceOnUse">
                                    <path d="M0 15 L30 15 M15 0 L15 30" stroke="#1976d2" stroke-width="0.5" fill="none" opacity="0.2"/>
                                </pattern>
                            </defs>
                            <rect width="100%" height="100%" fill="url(#map-grid)"/>
                            <!-- Map roads/streets -->
                            <path d="M5,10 Q25,8 45,15 T85,18 L95,20" stroke="#1976d2" stroke-width="2" fill="none" opacity="0.25"/>
                            <path d="M10,25 Q30,23 50,30 T90,33 L100,35" stroke="#1976d2" stroke-width="2" fill="none" opacity="0.25"/>
                            <path d="M8,40 Q28,38 48,45 T88,48" stroke="#1976d2" stroke-width="1.5" fill="none" opacity="0.2"/>
                            <!-- Map markers -->
                            <circle cx="30" cy="12" r="2" fill="#e91e63" opacity="0.4"/>
                            <circle cx="60" cy="28" r="2" fill="#e91e63" opacity="0.4"/>
                            <circle cx="45" cy="42" r="2" fill="#e91e63" opacity="0.4"/>
                        </svg>
                        
                        <!-- Prominent Map Button -->
                        <a href="{{ url_for('map_view') }}" class="relative z-10 flex items-center justify-center gap-2 bg-white hover:bg-gray-50 text-gray-900 font-semibold px-5 py-2.5 rounded-xl shadow-md hover:shadow-lg transition-all duration-200">
                            <svg class="w-5 h-5 text-[#1976d2]" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                            </svg>
                            <span class="text-sm">–ù–∞ –∫–∞—Ä—Ç–µ</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Properties Cards Section -->
<section class="py-8 bg-white">
    <div class="container mx-auto px-4">
        <div class="bg-gray-50 rounded-xl shadow-md border border-gray-200 p-6">

                <!-- Property Cards -->
                <div id="properties-container" class="space-y-6">
                    {% if properties and properties|length > 0 %}
                    {% for property in properties[:20] %}
                    
                    {% if loop.index0 > 0 and loop.index0 % 6 == 0 %}
                    <!-- Manager Block between properties -->
                    <div class="manager-block bg-gray-100 rounded-lg p-4 border border-gray-200 shadow-sm relative" id="manager-block-server-{{ loop.index0 }}">
                        <button class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 transition-colors" onclick="this.parentElement.style.display='none';" title="√ó">
                            <i class="fas fa-times"></i>
                        </button>
                        <div class="flex items-center gap-4">
                            <div class="flex-shrink-0">
                                {% if manager and manager.photo %}
                                <img src="{{ manager.photo }}" alt="{{ manager.name }}" class="w-16 h-16 rounded object-cover">
                                {% elif manager %}
                                <div class="w-16 h-16 rounded bg-blue-600 flex items-center justify-center text-white text-sm font-bold">
                                    {{ manager.name.split()[0][0] }}{{ manager.name.split()[1][0] if manager.name.split()|length > 1 else '' }}
                                </div>
                                {% else %}
                                <div class="w-16 h-16 rounded bg-blue-600 flex items-center justify-center text-white text-xl">
                                    <i class="fas fa-building"></i>
                                </div>
                                {% endif %}
                                <div class="bg-blue-600 text-white text-xs px-2 py-1 rounded mt-1 text-center font-medium">{{ '–ú–µ–Ω–µ–¥–∂–µ—Ä' if manager else 'InBack' }}</div>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-900 mb-1">{{ manager.name if manager else 'InBack' }}</h3>
                                <p class="text-gray-600 text-sm mb-3">–ü–æ–ª—É—á–∏—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –ø–æ–º–æ—â—å {{ '–æ—Ç –≤–∞—à–µ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞' if manager else '–æ—Ç –Ω–∞—à–µ–π –∫–æ–º–∞–Ω–¥—ã' }} –ø–æ –ø–æ–∫—É–ø–∫–µ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏</p>
                                <div class="flex items-center gap-4 text-sm">
                                    <div class="flex items-center gap-1 text-blue-600">
                                        <i class="fas fa-phone text-xs"></i>
                                        <span>{{ manager.phone if manager else '8 (862) 266-62-16' }}</span>
                                    </div>
                                    <div class="flex items-center gap-1 text-blue-600">
                                        <i class="fas fa-envelope text-xs"></i>
                                        <span>{{ manager.email if manager else 'info@inback.ru' }}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex-shrink-0">
                                <button onclick="openApplicationModal()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-medium hover:bg-blue-700 transition">
                                    <i class="fas fa-comments mr-1"></i>
                                    –°–≤—è–∑–∞—Ç—å—Å—è
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    <!-- Property Card - Exact Screenshot Design -->
                    <div class="property-card bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden w-full cursor-pointer" 
                         onclick="handleCardClick(event, this.getAttribute('data-property-url'))"
                         data-property-url="/{{ city_slug }}/object/{{ property.id }}" 
                         data-type="{{ property.type }}" 
                         data-rooms="{{ property.rooms }}" 
                         data-price="{{ property.price }}" 
                         data-district="{{ property.district }}" 
                         data-developer="{{ property.developer }}"
                         data-complex="{{ property.residential_complex or '–ù–µ —É–∫–∞–∑–∞–Ω' }}"
                         data-property-type="{{ property.property_type or property.type }}"
                         data-completion="{{ property.completion_date or '2024' }}"
                         data-area="{{ property.area }}"
                         data-floor="{{ property.floor }}"
                         data-mortgage="{{ property.mortgage_available|default('true') }}"
                         data-installment="{{ property.installment_available|default('false') }}"
                         data-maternal-capital="{{ property.maternal_capital|default('false') }}"
                         data-trade-in="{{ property.trade_in|default('false') }}"
                         data-cashback="{{ property.cashback_available|default('true') }}">
                        
                        <!-- Image Section with Slider -->
                        <div class="relative w-80 h-60 flex-shrink-0 group">
                            <div class="carousel-container w-full h-60 relative overflow-hidden bg-gray-100 rounded-lg" data-property-id="{{ property.id }}">
                                <!-- Image slides -->
                                {% if property.gallery and property.gallery|length > 0 %}
                                    {% for image in property.gallery[:4] %}
                                    <div class="carousel-slide absolute inset-0 {% if loop.index0 > 0 %}opacity-0{% endif %} transition-opacity duration-300" data-slide="{{ loop.index0 }}">
                                        <img src="{{ image }}" 
                                             alt="{% if property.rooms == 0 %}–°—Ç—É–¥–∏—è{% else %}{{ property.rooms }}-–∫–æ–º–Ω{% endif %} {{ property.area }} –º¬≤ - —Ñ–æ—Ç–æ {{ loop.index }}" 
                                             class="w-full h-full object-cover" 
                                             loading="lazy">
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="carousel-slide absolute inset-0 transition-opacity duration-300" data-slide="0">
                                        <img src="{{ property.image or 'https://via.placeholder.com/320x280/f3f4f6/9ca3af?text=–§–æ—Ç–æ+–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ' }}" 
                                             alt="{% if property.rooms == 0 %}–°—Ç—É–¥–∏—è{% else %}{{ property.rooms }}-–∫–æ–º–Ω{% endif %} {{ property.area }} –º¬≤" 
                                             class="w-full h-full object-cover" 
                                             loading="lazy">
                                    </div>
                                {% endif %}
                                
                                <!-- Navigation arrows -->
                                {% if property.gallery and property.gallery|length > 1 %}
                                <button onclick="event.stopPropagation(); event.preventDefault(); prevImageSlide(this, event); return false;" class="absolute left-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-black/50 hover:bg-black/70 text-white rounded-full flex items-center justify-center transition-all opacity-0 group-hover:opacity-100 z-10 slider-prev-btn">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                                    </svg>
                                </button>
                                <button onclick="event.stopPropagation(); event.preventDefault(); nextImageSlide(this, event); return false;" class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-black/50 hover:bg-black/70 text-white rounded-full flex items-center justify-center transition-all opacity-0 group-hover:opacity-100 z-10 slider-next-btn">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </button>
                                
                                <!-- Dots indicator -->
                                <div class="absolute bottom-3 left-1/2 -translate-x-1/2 flex gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                                    {% set gallery_length = property.gallery|length if property.gallery else 1 %}
                                    {% set max_slides = [gallery_length, 4]|min %}
                                    {% for i in range(max_slides) %}
                                    <button onclick="event.stopPropagation(); event.preventDefault(); goToImageSlide(this, {{ i }}, event); return false;" class="slider-dot-btn w-2.5 h-2.5 rounded-full {% if i == 0 %}bg-white/80{% else %}bg-white/50{% endif %} hover:bg-white transition-colors" data-slide="{{ i }}"></button>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Blue Cashback Badge -->
                            <div class="absolute top-3 left-3 bg-blue-600 text-white text-xs font-medium px-2 py-1 rounded z-20">
                                –ö—ç—à–±–µ–∫ –¥–æ {{ "{:,.0f}".format(property.cashback or 0) }} ‚ÇΩ
                            </div>
                            
                            <!-- Favorite Icons Container -->
                            <div class="absolute top-3 right-3 flex gap-2 z-20">
                                <!-- Universal Heart Icon -->
                                <div class="w-8 h-8 bg-white/90 hover:bg-white rounded-full flex items-center justify-center shadow-sm cursor-pointer favorite-heart z-20" data-property-id="{{ property.id }}" title="–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ" onclick="if(window.favoritesManager) { window.favoritesManager.toggleFavorite('{{ property.id }}', this); event.stopPropagation(); }">
                                    <i class="fas fa-heart text-gray-400 hover:text-red-500 text-sm transition-colors"></i>
                                </div>
                                <!-- Comparison Button -->
                                <button class="compare-btn w-8 h-8 bg-white/90 hover:bg-white rounded-full flex items-center justify-center shadow-sm text-gray-600 hover:text-blue-600 transition-colors" 
                                        data-property-id="{{ property.id }}" title="–î–æ–±–∞–≤–∏—Ç—å –∫ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é" onclick="event.stopPropagation();">
                                    <i class="fas fa-balance-scale text-sm"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Content Section -->
                        <div class="flex-1 p-6 flex flex-col">
                            <!-- Title -->
                            <h2 class="text-xl font-semibold text-gray-900 mb-3">
                                {% if property.rooms == 0 %}–°—Ç—É–¥–∏—è{% else %}{{ property.rooms }}-–∫–æ–º–Ω{% endif %}, {{ property.area }} –º¬≤, {{ property.floor }}/{{ property.total_floors }} —ç—Ç.
                            </h2>
                            
                            <!-- Complex and Location -->
                            <div class="mb-2">
                                {% if property.residential_complex or property.complex_name %}
                                <a href="/residential-complex/{{ property.residential_complex or property.complex_name }}" 
                                   class="text-blue-600 hover:text-blue-700 hover:underline text-sm font-medium" onclick="event.stopPropagation();">
                                    {{ property.residential_complex or property.complex_name }}
                                </a>
                                {% else %}
                                <span class="text-gray-700 text-sm font-medium">
                                    –ñ–ö –Ω–µ —É–∫–∞–∑–∞–Ω
                                </span>
                                {% endif %}
                                <span class="text-blue-600 text-sm"> ‚Ä¢ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π</span>
                            </div>
                            
                            <!-- Address -->
                            <div class="text-gray-500 text-sm mb-2">
                                {{ property.address or '–†–æ—Å—Å–∏—è, –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π, –°–æ—á–∏, –ö—É–¥–µ–ø—Å—Ç–∞ –º-–Ω, –ò—Å–∫—Ä–∞, 88 –ª–∏—Ç7' }}
                            </div>
                            
                            <!-- Developer -->
                            <div class="text-gray-700 text-sm mb-4">
                                <span class="font-medium">–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫:</span> {{ property.developer or property.developer_name or '–ì–ö –ù–µ–æ–º–µ—Ç—Ä–∏—è' }}
                            </div>
                            
                            <!-- Tags -->
                            <div class="flex gap-2 mb-4">
                                <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">{{ property.floor }}-–π —ç—Ç–∞–∂</span>
                                <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">{{ property.renovation_display_name or '–ë–µ–∑ –æ—Ç–¥–µ–ª–∫–∏' }}</span>
                                <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">{{ property.complex_object_class_display_name or '–ö–æ–º—Ñ–æ—Ä—Ç' }}</span>
                            </div>
                            
                            <div class="flex-1"></div>
                            
                            
                            <!-- Action Buttons Row with Price and Mortgage Info -->
                            <div class="flex items-center justify-between">
                                <div class="flex flex-col gap-2">
                                    {% if property.price and property.price > 0 %}
                                    <div class="text-2xl font-bold text-gray-900">
                                        {{ "{:,.0f}".format(property.price) }} ‚ÇΩ
                                    </div>
                                    <div class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">
                                        –æ—Ç {{ "{:,.0f}".format((property.price * 0.05) // 12) }} ‚ÇΩ/–º–µ—Å –∏–ø–æ—Ç–µ–∫–∞
                                    </div>
                                    {% else %}
                                    <div class="text-2xl font-bold text-gray-900">
                                        –¶–µ–Ω–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="flex gap-2">
                                    <a href="{{ url_for('property_pdf', property_id=property.id) }}" target="_blank" 
                                       class="w-10 h-10 bg-white border border-gray-300 rounded flex items-center justify-center text-gray-600 hover:bg-blue-50 hover:border-blue-300 hover:text-blue-600 hover:scale-105 transition-all duration-200" 
                                       title="–°–∫–∞—á–∞—Ç—å PDF" onclick="event.stopPropagation();">
                                        <i class="fas fa-file-pdf"></i>
                                    </a>
                                    {% if is_manager %}
                                    <button class="presentation-btn w-10 h-10 bg-white border border-[#0088CC] rounded flex items-center justify-center text-[#0088CC] hover:bg-blue-50 hover:border-blue-600 hover:text-blue-700 hover:scale-105 transition-all duration-200" 
                                            data-property-id="{{ property.id }}" title="–î–æ–±–∞–≤–∏—Ç—å –≤ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é" onclick="window.openPresentationModal('{{ property.id }}'); event.stopPropagation();">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <!-- Empty State - No Properties Found -->
                    <div class="flex flex-col items-center justify-center py-16 px-4">
                        <div class="text-center max-w-md">
                            <!-- Icon -->
                            <div class="mb-6">
                                <svg class="w-24 h-24 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                </svg>
                            </div>
                            
                            <!-- Message -->
                            <h3 class="text-2xl font-bold text-gray-800 mb-3">–û–±—ä–µ–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                            <p class="text-gray-600 mb-6">–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∏–ª–∏ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã.</p>
                            
                            <!-- Actions -->
                            <div class="flex flex-col sm:flex-row gap-3 justify-center">
                                <button onclick="window.location.href='/' + citySlug + '/properties';" class="bg-[#0088CC] hover:bg-[#006699] text-white px-6 py-3 rounded-lg font-medium transition-all">
                                    <i class="fas fa-redo mr-2"></i>
                                    –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                                </button>
                                <button onclick="openApplicationModal()" class="bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 px-6 py-3 rounded-lg font-medium transition-all">
                                    <i class="fas fa-phone mr-2"></i>
                                    –°–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏
                                </button>
                            </div>
                            
                            <!-- Suggestions -->
                            <div class="mt-8 pt-8 border-t border-gray-200">
                                <p class="text-sm text-gray-500 mb-3">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:</p>
                                <div class="flex flex-wrap gap-2 justify-center">
                                    <a href="/properties?rooms=1" class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded-full transition-all">1-–∫–æ–º–Ω–∞—Ç–Ω—ã–µ</a>
                                    <a href="/properties?rooms=2" class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded-full transition-all">2-–∫–æ–º–Ω–∞—Ç–Ω—ã–µ</a>
                                    <a href="/properties?price_max=5" class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded-full transition-all">–î–æ 5 –º–ª–Ω ‚ÇΩ</a>
                                    <a href="/map-view" class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded-full transition-all">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- JavaScript Pagination Container -->
                <div id="pagination-container"></div>

                <!-- –°–µ—Ä–≤–µ—Ä–Ω–∞—è –ø–∞–≥–∏–Ω–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞ –¥–ª—è –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
                {% if pagination and pagination.total_pages > 1 %}
                <div class="pagination-bar flex justify-between items-center bg-white rounded-lg shadow-sm border border-gray-200 p-4 mt-6">
                    <div class="text-sm text-gray-600">
                        –ü–æ–∫–∞–∑–∞–Ω–æ <span class="font-semibold">{{ (pagination.page - 1) * pagination.per_page + 1 }}-{{ pagination.page * pagination.per_page if pagination.page * pagination.per_page <= pagination.total else pagination.total }}</span> 
                        –∏–∑ <span class="font-semibold">{{ pagination.total }}</span> –æ–±—ä–µ–∫—Ç–æ–≤
                    </div>
                    
                    <div class="flex space-x-2">
                        <!-- –ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
                        {% if pagination.has_prev %}
                            <a href="?page={{ pagination.prev_page }}{% for key, value in request.args.items() %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                               class="px-3 py-2 border rounded-lg hover:bg-gray-50 transition">
                                –ü—Ä–µ–¥—ã–¥—É—â–∞—è
                            </a>
                        {% else %}
                            <span class="px-3 py-2 border rounded-lg text-gray-400 cursor-not-allowed">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</span>
                        {% endif %}
                        
                        <!-- –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü -->
                        {% set start_page = [pagination.page - 2, 1]|max %}
                        {% set end_page = [pagination.page + 2, pagination.total_pages]|min %}
                        
                        {% if start_page > 1 %}
                            <a href="?page=1{% for key, value in request.args.items() %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                               class="px-3 py-2 border rounded-lg hover:bg-gray-50 transition">1</a>
                            {% if start_page > 2 %}
                                <span class="px-2">...</span>
                            {% endif %}
                        {% endif %}
                        
                        {% for page_num in range(start_page, end_page + 1) %}
                            {% if page_num == pagination.page %}
                                <span class="px-3 py-2 border rounded-lg bg-[#0088CC] text-white">{{ page_num }}</span>
                            {% else %}
                                <a href="?page={{ page_num }}{% for key, value in request.args.items() %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                                   class="px-3 py-2 border rounded-lg hover:bg-gray-50 transition">{{ page_num }}</a>
                            {% endif %}
                        {% endfor %}
                        
                        {% if end_page < pagination.total_pages %}
                            {% if end_page < pagination.total_pages - 1 %}
                                <span class="px-2">...</span>
                            {% endif %}
                            <a href="?page={{ pagination.total_pages }}{% for key, value in request.args.items() %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                               class="px-3 py-2 border rounded-lg hover:bg-gray-50 transition">{{ pagination.total_pages }}</a>
                        {% endif %}
                        
                        <!-- –°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -->
                        {% if pagination.has_next %}
                            <a href="?page={{ pagination.next_page }}{% for key, value in request.args.items() %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" 
                               class="px-3 py-2 border rounded-lg hover:bg-gray-50 transition">
                                –°–ª–µ–¥—É—é—â–∞—è
                            </a>
                        {% else %}
                            <span class="px-3 py-2 border rounded-lg text-gray-400 cursor-not-allowed">–°–ª–µ–¥—É—é—â–∞—è</span>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<!-- Call-to-Action Section -->
<section class="py-8 bg-white">
    <div class="container mx-auto px-4">
        <div class="bg-gray-50 rounded-xl shadow-md border border-gray-200 p-6">
            <div class="text-center mb-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-2">
                    –ü–æ–ª—É—á–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –ø–æ–¥–±–æ—Ä–∫—É –∫–≤–∞—Ä—Ç–∏—Ä
                </h2>
                <p class="text-sm text-gray-600">
                    –ù–∞—à–∏ —ç–∫—Å–ø–µ—Ä—Ç—ã –ø–æ–¥–±–µ—Ä—É—Ç –ª—É—á—à–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –∫—ç—à–±–µ–∫–æ–º
                </p>
            </div>
            
            <div class="bg-white rounded-lg border border-gray-200 p-4">
                <div class="flex flex-col sm:flex-row gap-3 mb-3">
                    <input type="text" placeholder="–í–∞—à–µ –∏–º—è" class="flex-1 px-3 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm">
                    <input type="tel" placeholder="+7 (900) 123-45-67" class="flex-1 px-3 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm">
                    <select class="flex-1 px-3 py-2 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm">
                        <option>–í—ã–±–µ—Ä–∏—Ç–µ –±—é–¥–∂–µ—Ç</option>
                        <option>–î–æ 3 –º–ª–Ω ‚ÇΩ</option>
                        <option>3-5 –º–ª–Ω ‚ÇΩ</option>
                        <option>5-8 –º–ª–Ω ‚ÇΩ</option>
                        <option>8-12 –º–ª–Ω ‚ÇΩ</option>
                        <option>–°–≤—ã—à–µ 12 –º–ª–Ω ‚ÇΩ</option>
                    </select>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-3 items-center">
                    <button onclick="openApplicationModal();" class="w-full sm:w-auto px-6 py-2 bg-blue-600 text-white font-medium rounded hover:bg-blue-700 transition-colors text-sm">
                        –ü–æ–ª—É—á–∏—Ç—å –ø–æ–¥–±–æ—Ä–∫—É
                    </button>
                    <p class="text-xs text-gray-500">
                        –ë–µ—Å–ø–ª–∞—Ç–Ω–æ ‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
                    </p>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
console.log('üö® –≠–ö–°–¢–†–ï–ù–ù–´–ô SCRIPT –ó–ê–ü–£–©–ï–ù!');

// ‚úÖ –≠–ö–°–¢–†–ï–ù–ù–ê–Ø –ö–ù–û–ü–ö–ê –°–ë–†–û–°–ê –§–ò–õ–¨–¢–†–û–í
window.TOTAL_RESET = function() {
    console.log('üî• TOTAL_RESET –ê–ö–¢–ò–í–ò–†–û–í–ê–ù - –°–ë–†–û–° –í–°–ï–ì–û!');
    
    // –£–±–∏—Ä–∞–µ–º –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏–∑ URL
    const newUrl = '/properties';
    console.log('üîÑ –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞:', newUrl);
    window.location.href = newUrl;
};

// ‚úÖ –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞ - —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–∞ –≤ –æ–±—ã—á–Ω—É—é –∫–Ω–æ–ø–∫—É
console.log('‚úÖ –§—É–Ω–∫—Ü–∏—è TOTAL_RESET –≥–æ—Ç–æ–≤–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è');

// ===== IMAGE SLIDER FUNCTIONS =====
function nextImageSlide(button, event) {
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    
    const carousel = button.closest('.carousel-container');
    const slides = carousel.querySelectorAll('.carousel-slide');
    const dots = carousel.parentElement.querySelectorAll('.absolute.bottom-3 button');
    
    let currentSlide = 0;
    slides.forEach((slide, index) => {
        if (!slide.classList.contains('opacity-0')) {
            currentSlide = index;
        }
    });
    
    const nextSlide = (currentSlide + 1) % slides.length;
    
    slides[currentSlide].classList.add('opacity-0');
    slides[nextSlide].classList.remove('opacity-0');
    
    if (dots.length > 0) {
        dots[currentSlide].classList.remove('bg-white/80');
        dots[currentSlide].classList.add('bg-white/50');
        dots[nextSlide].classList.remove('bg-white/50');
        dots[nextSlide].classList.add('bg-white/80');
    }
    return false;
}

function prevImageSlide(button, event) {
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    
    const carousel = button.closest('.carousel-container');
    const slides = carousel.querySelectorAll('.carousel-slide');
    const dots = carousel.parentElement.querySelectorAll('.absolute.bottom-3 button');
    
    let currentSlide = 0;
    slides.forEach((slide, index) => {
        if (!slide.classList.contains('opacity-0')) {
            currentSlide = index;
        }
    });
    
    const prevSlide = currentSlide === 0 ? slides.length - 1 : currentSlide - 1;
    
    slides[currentSlide].classList.add('opacity-0');
    slides[prevSlide].classList.remove('opacity-0');
    
    if (dots.length > 0) {
        dots[currentSlide].classList.remove('bg-white/80');
        dots[currentSlide].classList.add('bg-white/50');
        dots[prevSlide].classList.remove('bg-white/50');
        dots[prevSlide].classList.add('bg-white/80');
    }
    return false;
}

function goToImageSlide(button, slideIndex, event) {
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    
    const carousel = button.closest('.absolute').previousElementSibling;
    const slides = carousel.querySelectorAll('.carousel-slide');
    const dots = button.parentElement.querySelectorAll('button');
    
    slides.forEach((slide, index) => {
        if (index === slideIndex) {
            slide.classList.remove('opacity-0');
        } else {
            slide.classList.add('opacity-0');
        }
    });
    
    dots.forEach((dot, index) => {
        if (index === slideIndex) {
            dot.classList.remove('bg-white/50');
            dot.classList.add('bg-white/80');
        } else {
            dot.classList.remove('bg-white/80');
            dot.classList.add('bg-white/50');
        }
    });
    return false;
}

// Make slider functions globally available for inline handlers
window.nextImageSlide = nextImageSlide;
window.prevImageSlide = prevImageSlide;
window.goToImageSlide = goToImageSlide;

// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ carousel event listeners
// –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ò –ø–æ—Å–ª–µ AJAX –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞
window.initializeImageCarousels = function() {
    console.log('üé† Initializing image carousels...');
    
    // Remove old listeners to avoid duplicates
    const prevBtns = document.querySelectorAll('.slider-prev-btn');
    const nextBtns = document.querySelectorAll('.slider-next-btn');
    const dotBtns = document.querySelectorAll('.slider-dot-btn');
    
    console.log('üé† Found carousel controls:', {
        prevBtns: prevBtns.length,
        nextBtns: nextBtns.length,
        dotBtns: dotBtns.length
    });
    
    // Previous slide buttons
    prevBtns.forEach(btn => {
        // Clone and replace to remove old listeners
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        newBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            e.preventDefault();
            prevImageSlide(this, e);
        });
    });
    
    // Next slide buttons
    nextBtns.forEach(btn => {
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        newBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            e.preventDefault();
            nextImageSlide(this, e);
        });
    });
    
    // Dot buttons
    dotBtns.forEach(btn => {
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        newBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            e.preventDefault();
            const slideIndex = parseInt(this.dataset.slide);
            goToImageSlide(this, slideIndex, e);
        });
    });
    
    console.log('‚úÖ Image carousels initialized');
};

console.log('‚úÖ Carousel functions loaded and available globally');



// Set authentication status immediately at the start
window.user_authenticated = {{ user_authenticated|tojson|safe }};
window.manager_authenticated = {{ manager_authenticated|tojson|safe }};
window.isManager = {{ manager_authenticated|tojson|safe }};
{% if current_manager %}
window.current_manager = {{ current_manager.to_dict()|tojson|safe }};
{% else %}
window.current_manager = null;
{% endif %}

// User's assigned manager data for properties page
{% if manager %}
window.userManager = {{ manager|tojson|safe }};
{% else %}
window.userManager = null;
{% endif %}

// ‚ö° VERSION MARKER: v1761503218
console.log('üî•üî•üî• PROPERTIES.HTML VERSION: v1761503218 - LOADED! üî•üî•üî•');

// Debug authentication status
console.log('Authentication status:', {
    user_authenticated: window.user_authenticated,
    manager_authenticated: window.manager_authenticated,
    current_manager: window.current_manager || null
});

let map;
let markers = [];

// Properties already filtered and paginated by server
let allProperties = {{ properties|tojson|safe }};
let filteredProperties = allProperties; // Don't re-filter on client
// Note: window.serverSidePagination, totalProperties, totalPages set in extra_head block

let selectedRooms = new Set();
let currentSortBy = 'price-desc';
let currentPage = {{ page }};
window.itemsPerPage = 20;
let residentialComplexes = [];

// Completely remove old favorites system - now handled by FavoritesManager
// Clear localStorage to avoid conflicts
if (localStorage.getItem('favorites')) {
    localStorage.removeItem('favorites');
    console.log('Cleared old localStorage favorites');
}

// Favorites counter is now handled by FavoritesManager class
// function updateFavoritesCounter() - DEPRECATED

// Advanced Filters Object
let advancedFilters = {
    districts: [],
    developers: [],
    propertyTypes: [],
    priceMin: 0,
    priceMax: 0,
    roomTypes: [],
    distances: [],
    areas: [],
    directions: [],
    payments: [],
    areaFrom: 0,
    areaTo: 0
};

// Add galleries to properties for testing
allProperties.forEach((property, index) => {
    if (!property.gallery) {
        property.gallery = [
            property.image,
            `https://via.placeholder.com/400x300/FF5722/FFFFFF?text=–ö—É—Ö–Ω—è`,
            `https://via.placeholder.com/400x300/4CAF50/FFFFFF?text=–°–ø–∞–ª—å–Ω—è`,
            `https://via.placeholder.com/400x300/9C27B0/FFFFFF?text=–í–∏–¥`
        ];
    }
});

// ‚úÖ sortProperties —Ç–µ–ø–µ—Ä—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ —Ñ–∞–π–ª–∞ /static/js/properties-sorting.js

// Initialize smart autocomplete search for properties catalog
function initializePropertiesSmartSearch() {
    const searchInput = document.getElementById('property-search');
    if (!searchInput) return;
    
    // Make the input container relative
    searchInput.parentElement.style.position = 'relative';
    
    // Initialize smart autocomplete
    const autocomplete = new SmartAutocomplete(searchInput, {
        placeholder: '–ü–æ–∏—Å–∫ –ø–æ –∞–¥—Ä–µ—Å—É, –ñ–ö, –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫—É...',
        onSelect: function(suggestion) {
            console.log('üéØ SmartAutocomplete onSelect called:', suggestion);
            handlePropertiesSearchSelection(suggestion);
        },
        onSearch: function(query, suggestion) {
            console.log('üîç SmartAutocomplete onSearch called:', query, suggestion);
            performPropertiesSmartSearch(query, suggestion);
        }
    });
    
    // Store reference globally
    window.propertiesAutocomplete = autocomplete;
}

// ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û: –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è SuperSearch
window.handlePropertySuggestionSelect = function(suggestion) {
    console.log('üéØ Properties selected suggestion:', suggestion);
    handlePropertiesSearchSelection(suggestion);
};

// Handle search suggestion selection for properties
function handlePropertiesSearchSelection(suggestion) {
    console.log('üè∑Ô∏è Handling suggestion:', suggestion);
    
    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ï—Å–ª–∏ –µ—Å—Ç—å URL, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –ø–æ –Ω–µ–º—É
    if (suggestion.url) {
        console.log('üîó Navigating to URL:', suggestion.url);
        window.location.href = suggestion.url;
        return;
    }
    
    // Fallback - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
    switch(suggestion.type) {
        case 'address':
            document.getElementById('property-search').value = suggestion.text;
            applyFilters();
            break;
        case 'complex':
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ –ñ–ö
            console.log('üèóÔ∏è Setting complex filter:', suggestion.text);
            activeFilters.residential_complex = suggestion.text;
            if (window.activeFilters) {
                window.activeFilters.residential_complex = suggestion.text;
            }
            // –û—á–∏—â–∞–µ–º –ø–æ–∏—Å–∫–æ–≤—É—é —Å—Ç—Ä–æ–∫—É, —Ç.–∫. —Ñ–∏–ª—å—Ç—Ä —Ç–µ–ø–µ—Ä—å –≤ activeFilters.residential_complex
            document.getElementById('property-search').value = '';
            applyFilters();
            console.log('‚úÖ Complex filter applied:', activeFilters.residential_complex);
            break;
        case 'developer':
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫—É
            console.log('üè¢ Setting developer filter:', suggestion.text);
            const developerSelect = document.getElementById('developer-filter');
            if (developerSelect) {
                const option = Array.from(developerSelect.options).find(opt => 
                    opt.textContent.toLowerCase().includes(suggestion.text.toLowerCase())
                );
                if (option) {
                    developerSelect.value = option.value;
                    console.log('‚úÖ Developer filter set to:', option.value);
                } else {
                    console.warn('‚ö†Ô∏è Developer not found in select:', suggestion.text);
                }
            }
            document.getElementById('property-search').value = '';
            applyFilters();
            break;
        case 'district':
            const districtSelect = document.getElementById('district-filter');
            if (districtSelect) {
                const option = Array.from(districtSelect.options).find(opt => 
                    opt.textContent.toLowerCase().includes(suggestion.text.toLowerCase())
                );
                if (option) {
                    districtSelect.value = option.value;
                }
            }
            applyFilters();
            break;
        case 'rooms':
            // Handle room type suggestions
            if (suggestion.text.includes('–°—Ç—É–¥–∏')) {
                document.querySelector('input[value="0"]')?.click();
            } else if (suggestion.text.includes('1-–∫–æ–º–Ω–∞—Ç')) {
                document.querySelector('input[value="1"]')?.click();
            } else if (suggestion.text.includes('2-–∫–æ–º–Ω–∞—Ç')) {
                document.querySelector('input[value="2"]')?.click();
            } else if (suggestion.text.includes('3-–∫–æ–º–Ω–∞—Ç')) {
                document.querySelector('input[value="3"]')?.click();
            }
            break;
        default:
            document.getElementById('property-search').value = suggestion.text;
            applyFilters();
    }
}

// Smart search for properties catalog
function performPropertiesSmartSearch(query, suggestion) {
    console.log('Performing properties smart search:', query, suggestion);
    document.getElementById('property-search').value = query;
    applyFilters();
}

// Enhanced search functionality with comprehensive suggestions for ALL parameters
function initializeSearch() {
    // Legacy function - replaced with smart search
    initializePropertiesSmartSearch();
    
    const searchInput = document.getElementById('property-search');
    const suggestionsContainer = document.getElementById('property-searchSuggestions');
    
    // Create comprehensive search suggestions covering ALL filter types with REAL database data
    const suggestions = {
        districts: ['–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π'],
        rooms: ['–°—Ç—É–¥–∏—è', '1-–∫–æ–º–Ω–∞—Ç–Ω–∞—è', '2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è', '3-–∫–æ–º–Ω–∞—Ç–Ω–∞—è', '4-–∫–æ–º–Ω–∞—Ç–Ω–∞—è'],
        propertyClass: ['–≠–∫–æ–Ω–æ–º', '–ö–æ–º—Ñ–æ—Ä—Ç', '–ë–∏–∑–Ω–µ—Å', '–ü—Ä–µ–º–∏—É–º'],
        wallMaterial: ['–ö–∏—Ä–ø–∏—á', '–ú–æ–Ω–æ–ª–∏—Ç', '–ü–∞–Ω–µ–ª—å', '–ì–∞–∑–æ–±–µ—Ç–æ–Ω'],
        floorsTotal: ['–¥–æ 5 —ç—Ç–∞–∂–µ–π', '6-10 —ç—Ç–∞–∂–µ–π', '11-20 —ç—Ç–∞–∂–µ–π', '–±–æ–ª–µ–µ 20 —ç—Ç–∞–∂–µ–π'],
        completion: ['2024', '2025', '2026', '2028'],
        developers: ['–ì–ö –ù–µ–æ–º–µ—Ç—Ä–∏—è', 'AVA', '–¶–ï–ù–¢–†–ê–õ–¨–ù–ê–Ø –ò–ù–í–ï–°–¢–ò–¶–ò–û–ù–ù–ê–Ø –ö–û–ú–ü–ê–ù–ò–Ø', '–°–ó –ö–ê–°–ö–ê–î', '–¢–û–ß–ù–û', '–°–ü–ï–¶–ò–ê–õ–ò–ó–ò–†–û–í–ê–ù–ù–´–ô –ó–ê–°–¢–†–û–ô–©–ò–ö –ö–û–†–û–ù–ê'],
        complexes: ['–ñ–ö –ì–æ—Å—Ç–∏–Ω–∏—á–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å "–ù–µ—Å–∫—É—á–Ω—ã–π —Å–∞–¥"', '–ñ–ö –õ–µ—Å—Ç–æ—Ä–∏—è', '–ñ–ö –§–õ–û–†–ê', '–ñ–ö "–ö–∏—Å–ª–æ—Ä–æ–¥"', '–ñ–ö "–ß–∞–π–Ω—ã–µ —Ö–æ–ª–º—ã"', '–ñ–ö –ì–æ—Å—Ç–∏–Ω–∏—á–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Å "–ì—Ä–∞–Ω–¥ –ö–∞—Å–∫–∞–¥"'],
        properties: [],
        streets: []
    };
    
    // Add property and complex data
    allProperties.forEach(property => {
        const propertyTitle = property.rooms == 0 ? '–°—Ç—É–¥–∏—è' : property.rooms + '-–∫–æ–º–Ω';
        suggestions.properties.push(propertyTitle + ' ' + property.area + ' –º¬≤');
        suggestions.complexes.push(property.residential_complex);
        suggestions.developers.push(property.developer);
        suggestions.streets.push(property.location);
    });
    
    // Add –ñ–ö suggestions
    residentialComplexes.forEach(complex => {
        suggestions.complexes.push(complex.name);
        suggestions.developers.push(complex.developer);
        suggestions.streets.push(complex.location);
    });
    
    // Remove duplicates from each category
    Object.keys(suggestions).forEach(key => {
        suggestions[key] = [...new Set(suggestions[key])].filter(Boolean);
    });
    
    const allSuggestions = Object.values(suggestions).flat();
    
    searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        
        if (query.length < 2) {
            if (suggestionsContainer) {
                suggestionsContainer.classList.add('hidden');
            }
            return;
        }
        
        // Filter both property and –ñ–ö suggestions
        const propertySuggestions = uniqueSuggestions
            .filter(suggestion => suggestion.toLowerCase().includes(query))
            .slice(0, 5);
            
        const complexSuggestions = residentialComplexes
            .filter(complex => 
                complex.name.toLowerCase().includes(query) ||
                complex.developer.toLowerCase().includes(query) ||
                complex.location.toLowerCase().includes(query)
            )
            .slice(0, 3);
        
        let suggestionHTML = '';
        
        if (propertySuggestions.length > 0) {
            suggestionHTML += propertySuggestions
                .map(suggestion => `<div class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm" onclick="selectSuggestion('${suggestion.replace(/'/g, "\\'")}')">
                    <i class="fas fa-search mr-2 text-gray-400"></i>${suggestion}
                </div>`)
                .join('');
        }
        
        if (complexSuggestions.length > 0) {
            if (propertySuggestions.length > 0) {
                suggestionHTML += '<div class="border-t border-gray-200 my-1"></div>';
            }
            suggestionHTML += complexSuggestions
                .map(complex => `<div class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm" onclick="selectComplexSuggestion('${complex.name.replace(/'/g, "\\'")}')">
                    <i class="fas fa-building mr-2 text-[#0088CC]"></i><strong>${complex.name}</strong><br>
                    <small class="text-gray-500 ml-6">${complex.developer} ‚Ä¢ ${complex.apartments_count} –∫–≤–∞—Ä—Ç–∏—Ä</small>
                </div>`)
                .join('');
        }
        
        if (suggestionHTML && suggestionsContainer) {
            suggestionsContainer.innerHTML = suggestionHTML;
            suggestionsContainer.classList.remove('hidden');
        } else if (suggestionsContainer) {
            suggestionsContainer.classList.add('hidden');
        }
    });
    
    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
            if (suggestionsContainer) {
                suggestionsContainer.classList.add('hidden');
            }
        }
    });
}

// New smart search function
function performSmartSearch() {
    const searchValue = document.getElementById('property-search').value.trim();
    if (!searchValue) {
        alert('–í–≤–µ–¥–∏—Ç–µ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å');
        return;
    }
    
    // Clear all current filters first
    clearAllFilters();
    
    // Try to detect and apply filters based on search
    const searchLower = searchValue.toLowerCase();
    
    // Check districts
    const districts = ['—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π', '–∑–∞–ø–∞–¥–Ω—ã–π', '–∫–∞—Ä–∞—Å—É–Ω—Å–∫–∏–π', '–ø—Ä–∏–∫—É–±–∞–Ω—Å–∫–∏–π', '—Ñ–µ—Å—Ç–∏–≤–∞–ª—å–Ω—ã–π'];
    districts.forEach(district => {
        if (searchLower.includes(district)) {
            const checkbox = document.querySelector(`input[data-filter-type="district"][value*="${district}"]`);
            if (checkbox) checkbox.checked = true;
        }
    });
    
    // Check property class
    const propertyClasses = ['—ç–∫–æ–Ω–æ–º', '–∫–æ–º—Ñ–æ—Ä—Ç', '–±–∏–∑–Ω–µ—Å', '–ø—Ä–µ–º–∏—É–º'];
    propertyClasses.forEach(cls => {
        if (searchLower.includes(cls)) {
            const checkbox = document.querySelector(`input[data-filter="property_class"][value*="${cls}"]`);
            if (checkbox) checkbox.checked = true;
        }
    });
    
    // Check wall materials
    const materials = ['–∫–∏—Ä–ø–∏—á', '–º–æ–Ω–æ–ª–∏—Ç', '–ø–∞–Ω–µ–ª—å', '–≥–∞–∑–æ–±–µ—Ç–æ–Ω'];
    materials.forEach(material => {
        if (searchLower.includes(material)) {
            const checkbox = document.querySelector(`input[data-filter="wall_material"][value*="${material}"]`);
            if (checkbox) checkbox.checked = true;
        }
    });
    
    // Apply filters and search
    applyFilters();
}

function selectSuggestion(suggestion, category) {
    document.getElementById('property-search').value = suggestion;
    document.getElementById('property-searchSuggestions').classList.add('hidden');
    
    // Auto-apply the selected filter
    if (category === 'district') {
        const checkbox = document.querySelector(`input[data-filter-type="district"][value="${suggestion}"]`);
        if (checkbox) {
            checkbox.checked = true;
            applyFilters();
        }
    } else if (category === 'developer') {
        const checkbox = document.querySelector(`input[data-filter-type="developer"][value="${suggestion}"]`) ||
                        document.querySelector(`input[data-filter="developer"][value="${suggestion}"]`);
        if (checkbox) {
            checkbox.checked = true;
            applyFilters();
        }
    } else if (category === 'propertyClass') {
        const checkbox = document.querySelector(`input[data-filter="property_class"][value="${suggestion}"]`);
        if (checkbox) {
            checkbox.checked = true;
            updateAdvancedFilters();
        }
    } else if (category === 'wallMaterial') {
        const checkbox = document.querySelector(`input[data-filter="wall_material"][value="${suggestion}"]`);
        if (checkbox) {
            checkbox.checked = true;
            updateAdvancedFilters();
        }
    } else if (category === 'floorsTotal') {
        const checkbox = document.querySelector(`input[data-filter="floors_total"][value="${suggestion}"]`);
        if (checkbox) {
            checkbox.checked = true;
            updateAdvancedFilters();
        }
    }
    
    console.log('Selected suggestion:', suggestion, 'Category:', category);
    
    // Apply search filter
    applyFilters();
}

function selectComplexSuggestion(complexName) {
    document.getElementById('property-search').value = complexName;
    document.getElementById('property-searchSuggestions').classList.add('hidden');
    applyFilters();
}

// Room filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const roomButtons = document.querySelectorAll('.room-btn');
    
    roomButtons.forEach(button => {
        button.addEventListener('click', function() {
            const rooms = this.dataset.rooms;
            
            if (selectedRooms.has(rooms)) {
                selectedRooms.delete(rooms);
                this.classList.remove('bg-[#0088CC]', 'text-white', 'border-[#0088CC]');
                this.classList.add('border-gray-300', 'text-gray-700');
            } else {
                selectedRooms.add(rooms);
                this.classList.add('bg-[#0088CC]', 'text-white', 'border-[#0088CC]');
                this.classList.remove('border-gray-300', 'text-gray-700');
            }
            
            applyFilters();
        });
    });
    
    // Advanced filters panel handlers
    const advancedToggle = document.getElementById('advancedFiltersToggle');
    const advancedPanel = document.getElementById('advancedFiltersPanel');
    const applyAdvancedBtn = document.getElementById('applyAdvancedFilters');
    const applyAdvancedBtnBottom = document.getElementById('applyAdvancedFiltersBottom');
    
    if (advancedToggle && advancedPanel) {
        advancedToggle.addEventListener('click', function() {
            const isVisible = !advancedPanel.classList.contains('hidden');
            advancedPanel.classList.toggle('hidden');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
            if (!isVisible) {
                updateFilteredResultsCount();
                console.log('‚úÖ Advanced filters panel opened, count updated');
            }
        });
    }
    
    // Update results count when applying filters from top button
    if (applyAdvancedBtn) {
        applyAdvancedBtn.addEventListener('click', function() {
            console.log('üîò Apply button (top) clicked');
            applyFilters();
        });
    }
    
    // Update results count when applying filters from bottom button
    if (applyAdvancedBtnBottom) {
        applyAdvancedBtnBottom.addEventListener('click', function() {
            console.log('üîò Apply button (bottom) clicked');
            applyFilters();
        });
    }
});

// Update filtered results count - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π total –∏–∑ —Å–∏—Å—Ç–µ–º—ã
function updateFilteredResultsCount() {
    const resultsCountEl = document.getElementById('filteredResultsCount');
    
    if (!resultsCountEl) {
        console.log('‚ö†Ô∏è filteredResultsCount element not found');
        return;
    }
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑ pagination (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º AJAX –∑–∞–ø—Ä–æ—Å–µ)
    const currentTotal = window.totalProperties || 311;
    resultsCountEl.textContent = currentTotal.toString();
    console.log('üìä –û–±–Ω–æ–≤–ª–µ–Ω —Å—á–µ—Ç—á–∏–∫ –≤ –º–æ–¥–∞–ª—å–Ω–æ–π –ø–∞–Ω–µ–ª–∏:', currentTotal);
}

// Apply filters function - called from buttons
async function applyFilters() {
    console.log('‚úÖ applyFilters() called');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
    const searchInput = document.getElementById('property-search-desktop');
    const searchQuery = searchInput ? searchInput.value.trim() : '';
    
    if (searchQuery) {
        // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å - –ø—Ä–æ–≤–µ—Ä—è–µ–º –≥–æ—Ä–æ–¥ —á–µ—Ä–µ–∑ Smart Search API
        console.log('üîç –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –æ–±–Ω–∞—Ä—É–∂–µ–Ω:', searchQuery);
        
        try {
            const response = await fetch(`/api/smart-search?q=${encodeURIComponent(searchQuery)}`);
            const data = await response.json();
            
            console.log('üåç Smart Search —Ä–µ–∑—É–ª—å—Ç–∞—Ç:', data);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–∞—Ä—É–∂–µ–Ω –ª–∏ –≥–æ—Ä–æ–¥ –æ—Ç–ª–∏—á–Ω—ã–π –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ
            if (data.detected_city && data.detected_city.city_slug) {
                const detectedCitySlug = data.detected_city.city_slug;
                const currentCitySlug = '{{ current_city.slug if current_city else "krasnodar" }}';
                const currentCityId = {{ current_city.id if current_city else 1 }};
                window.currentCityId = currentCityId;
                
                if (detectedCitySlug !== currentCitySlug) {
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞
                    console.log(`üöÄ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞: ${currentCitySlug} ‚Üí ${detectedCitySlug}`);
                    window.location.href = `/${detectedCitySlug}/properties?search=${encodeURIComponent(searchQuery)}`;
                    return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –±—É–¥–µ—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç
                }
            }
        } catch (error) {
            console.error('‚ö†Ô∏è –û—à–∏–±–∫–∞ Smart Search API:', error);
            // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—ã—á–Ω—É—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø—Ä–∏ –æ—à–∏–±–∫–µ
        }
    }
    
    // Apply the filters
    filterProperties();
    
    // Close the advanced filters panel
    const advancedPanel = document.getElementById('advancedFiltersPanel');
    if (advancedPanel) {
        advancedPanel.classList.add('hidden');
        console.log('‚úÖ Advanced filters panel closed after applying filters');
    }
}

// Reset advanced filters function
function resetAdvancedFilters() {
    console.log('üîÑ –°–±—Ä–æ—Å –≤—Å–µ—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤ –ø–∞–Ω–µ–ª–∏...');
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è
    document.getElementById('areaFrom').value = '';
    document.getElementById('areaTo').value = '';
    document.getElementById('floorFrom').value = '';
    document.getElementById('floorTo').value = '';
    document.getElementById('maxFloorFrom').value = '';
    document.getElementById('maxFloorTo').value = '';
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —á–µ–∫–±–æ–∫—Å—ã
    document.querySelectorAll('#advancedFiltersPanel input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
    updateFilteredResultsCount();
    
    console.log('‚úÖ –í—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã —Å–±—Ä–æ—à–µ–Ω—ã');
}

// ========== –ú–û–î–ê–õ–¨–ù–´–ï –ü–ê–ù–ï–õ–ò –§–ò–õ–¨–¢–†–û–í (Rooms, Price, Developer) ==========

// Rooms Filter Modal
function openRoomsFilterPanel() {
    const panel = document.getElementById('roomsFilterPanel');
    if (panel) {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –ø–∞–Ω–µ–ª–∏
        closeAllFilterPanels();
        
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
        panel.classList.remove('hidden');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
        if (typeof window.updateFilteredCount === 'function') {
            window.updateFilteredCount();
        } else {
            document.getElementById('roomsFilteredCount').textContent = window.totalProperties || 311;
        }
        console.log('‚úÖ Rooms filter panel opened');
    }
}

function resetRoomsFilter() {
    document.querySelectorAll('#roomsFilterPanel input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
    if (typeof window.updateFilteredCount === 'function') {
        window.updateFilteredCount();
    } else {
        document.getElementById('roomsFilteredCount').textContent = window.totalProperties || 311;
    }
    console.log('üîÑ Rooms filter reset');
}

function applyRoomsFilter() {
    console.log('üîµ applyRoomsFilter called');
    const panel = document.getElementById('roomsFilterPanel');
    if (!panel) {
        console.error('‚ùå roomsFilterPanel not found!');
        return;
    }
    
    console.log('üîµ Closing panel...');
    panel.classList.add('hidden');
    panel.classList.remove('mobile-fullscreen');
    document.body.style.overflow = '';
    
    console.log('üîµ Panel closed, applying filters...');
    applyFilters();
    console.log('‚úÖ Rooms filter applied and panel closed');
}
window.applyRoomsFilter = applyRoomsFilter;
window.openRoomsFilterPanel = openRoomsFilterPanel;
window.resetRoomsFilter = resetRoomsFilter;

// Price Filter Modal
function openPriceFilterPanel() {
    const panel = document.getElementById('priceFilterPanel');
    if (panel) {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –ø–∞–Ω–µ–ª–∏
        closeAllFilterPanels();
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ desktop dropdown
        const priceFrom = document.getElementById('priceFrom');
        const priceTo = document.getElementById('priceTo');
        const priceFromModal = document.getElementById('priceFromModal');
        const priceToModal = document.getElementById('priceToModal');
        
        if (priceFrom && priceFromModal) priceFromModal.value = priceFrom.value;
        if (priceTo && priceToModal) priceToModal.value = priceTo.value;
        
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
        panel.classList.remove('hidden');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
        if (typeof window.updateFilteredCount === 'function') {
            window.updateFilteredCount();
        } else {
            document.getElementById('priceFilteredCount').textContent = window.totalProperties || 311;
        }
        console.log('‚úÖ Price filter panel opened');
    }
}

function resetPriceFilter() {
    document.getElementById('priceFromModal').value = '';
    document.getElementById('priceToModal').value = '';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
    if (typeof window.updateFilteredCount === 'function') {
        window.updateFilteredCount();
    } else {
        document.getElementById('priceFilteredCount').textContent = window.totalProperties || 311;
    }
    console.log('üîÑ Price filter reset');
}

function applyPriceFilterModal() {
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ –≤ desktop dropdown
    const priceFromModal = document.getElementById('priceFromModal');
    const priceToModal = document.getElementById('priceToModal');
    const priceFrom = document.getElementById('priceFrom');
    const priceTo = document.getElementById('priceTo');
    
    if (priceFromModal && priceFrom) priceFrom.value = priceFromModal.value;
    if (priceToModal && priceTo) priceTo.value = priceToModal.value;
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä
    if (typeof applyPriceFilter === 'function') {
        applyPriceFilter();
    } else {
        applyFilters();
    }
    
    const panel = document.getElementById('priceFilterPanel');
    panel.classList.add('hidden');
    panel.classList.remove('mobile-fullscreen');
    document.body.style.overflow = '';
    console.log('‚úÖ Price filter applied and panel closed');
}
window.applyPriceFilterModal = applyPriceFilterModal;
window.openPriceFilterPanel = openPriceFilterPanel;
window.resetPriceFilter = resetPriceFilter;

// Developer Filter Modal
function openDeveloperFilterPanel() {
    const panel = document.getElementById('developerFilterPanel');
    if (panel) {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –ø–∞–Ω–µ–ª–∏
        closeAllFilterPanels();
        
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
        panel.classList.remove('hidden');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
        if (typeof window.updateFilteredCount === 'function') {
            window.updateFilteredCount();
        } else {
            document.getElementById('developerFilteredCount').textContent = window.totalProperties || 311;
        }
        console.log('‚úÖ Developer filter panel opened');
    }
}

function resetDeveloperFilter() {
    document.querySelectorAll('#developerFilterPanel input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
    if (typeof window.updateFilteredCount === 'function') {
        window.updateFilteredCount();
    } else {
        document.getElementById('developerFilteredCount').textContent = window.totalProperties || 311;
    }
    console.log('üîÑ Developer filter reset');
}

function applyDeveloperFilter() {
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —á–µ–∫–±–æ–∫—Å—ã —Å desktop dropdown
    const modalCheckboxes = document.querySelectorAll('#developerFilterPanel input[type="checkbox"]:checked');
    const desktopCheckboxes = document.querySelectorAll('.dropdown[data-filter="developers"] input[type="checkbox"]');
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º desktop —á–µ–∫–±–æ–∫—Å—ã
    desktopCheckboxes.forEach(cb => cb.checked = false);
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
    modalCheckboxes.forEach(modalCb => {
        const value = modalCb.value;
        const desktopCb = document.querySelector(`.dropdown[data-filter="developers"] input[value="${value}"]`);
        if (desktopCb) desktopCb.checked = true;
    });
    
    applyFilters();
    document.getElementById('developerFilterPanel').classList.add('hidden');
    console.log('‚úÖ Developer filter applied and panel closed');
}
window.applyDeveloperFilter = applyDeveloperFilter;
window.openDeveloperFilterPanel = openDeveloperFilterPanel;
window.resetDeveloperFilter = resetDeveloperFilter;

// Save Search Modal
function openSaveSearchModal() {
    console.log('üíó Opening save search modal');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    const isAuthenticated = window.user_authenticated || window.manager_authenticated;
    
    if (!isAuthenticated) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        if (confirm('–ß—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ø–æ–∏—Å–∫–∏, –Ω—É–∂–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å–µ–π—á–∞—Å?')) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞
            if (typeof openApplicationModal === 'function') {
                openApplicationModal();
            } else {
                // –ò–ª–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                window.location.href = '/register';
            }
        }
        return;
    }
    
    const panel = document.getElementById('saveSearchModal');
    if (panel) {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –ø–∞–Ω–µ–ª–∏
        closeAllFilterPanels();
        
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
        panel.classList.remove('hidden');
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∏—Å–∫–∞
        const searchName = generateSearchNameForModal();
        const nameInput = document.getElementById('searchNameInputModal');
        if (nameInput) {
            nameInput.value = searchName;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º preview —Ñ–∏–ª—å—Ç—Ä–æ–≤
        updateFiltersPreview();
        
        console.log('‚úÖ Save search modal opened');
    }
}

function closeSaveSearchModal() {
    const panel = document.getElementById('saveSearchModal');
    if (panel) {
        panel.classList.add('hidden');
        panel.classList.remove('mobile-fullscreen');
        document.body.style.overflow = '';
    }
}

async function saveSearchFromModal() {
    console.log('üíæ Saving search from modal...');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    const isAuthenticated = window.user_authenticated || window.manager_authenticated;
    if (!isAuthenticated) {
        alert('–î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è');
        closeSaveSearchModal();
        if (typeof openApplicationModal === 'function') {
            openApplicationModal();
        }
        return;
    }
    
    const searchName = document.getElementById('searchNameInputModal')?.value;
    
    if (!searchName || !searchName.trim()) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∏—Å–∫–∞');
        return;
    }
    
    try {
        // –°–æ–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏–∑ DOM
        const params = {
            rooms: Array.from(document.querySelectorAll('input[data-filter-type="rooms"]:checked')).map(cb => cb.value),
            districts: Array.from(document.querySelectorAll('input[data-filter-type="district"]:checked')).map(cb => cb.value),
            developers: Array.from(document.querySelectorAll('input[data-filter-type="developer"]:checked')).map(cb => cb.value),
            completion: Array.from(document.querySelectorAll('input[data-filter-type="completion"]:checked')).map(cb => cb.value),
            object_classes: Array.from(document.querySelectorAll('input[data-filter-type="object_class"]:checked')).map(cb => cb.value),
            renovation: Array.from(document.querySelectorAll('input[data-filter-type="renovation"]:checked')).map(cb => cb.value),
            features: Array.from(document.querySelectorAll('input[data-filter-type="features"]:checked')).map(cb => cb.value),
            building_released: Array.from(document.querySelectorAll('input[data-filter-type="building_released"]:checked')).map(cb => cb.value),
            regions: Array.from(document.querySelectorAll('input[data-filter-type="region"]:checked')).map(cb => cb.value),
            cities: Array.from(document.querySelectorAll('input[data-filter-type="city"]:checked')).map(cb => cb.value),
            price_min: document.getElementById('priceFrom')?.value || '',
            price_max: document.getElementById('priceTo')?.value || '',
            area_min: document.getElementById('areaFrom')?.value || '',
            area_max: document.getElementById('areaTo')?.value || '',
            floor_min: document.getElementById('floorFrom')?.value || '',
            floor_max: document.getElementById('floorTo')?.value || '',
            building_floors_min: document.getElementById('maxFloorFrom')?.value || '',
            building_floors_max: document.getElementById('maxFloorTo')?.value || ''
        };
        
        // Determine if user is a manager
        const isManager = Boolean(window.manager_authenticated);
        
        // Choose appropriate endpoint
        let endpoint, requestData;
        
        if (isManager) {
            endpoint = '/api/manager/saved-searches';
            requestData = {
                name: searchName,
                filters: params
            };
        } else {
            endpoint = '/api/user/saved-searches';
            requestData = {
                name: searchName,
                description: '',
                notify_new_matches: true,
                search_type: 'properties',
                ...params
            };
        }
        
        console.log('üíæ –°–æ—Ö—Ä–∞–Ω—è—é –ø–æ–∏—Å–∫:', { endpoint, requestData });
        
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin',
            body: JSON.stringify(requestData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('‚úÖ –ü–æ–∏—Å–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
            closeSaveSearchModal();
            // Reload saved searches if available
            if (window.savedSearchesManager && typeof window.savedSearchesManager.loadSavedSearches === 'function') {
                window.savedSearchesManager.loadSavedSearches();
            }
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–∏—Å–∫'));
        }
    } catch (error) {
        console.error('Save search error:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ–∏—Å–∫–∞');
    }
}

// generateSearchNameForModal –∏ updateFiltersPreview –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ —Ä–∞–Ω–Ω–µ–º –±–ª–æ–∫–µ (—Å—Ç—Ä–æ–∫–∞ ~1133-1201)

// –ó–∞–∫—Ä—ã—Ç—å –≤—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –ø–∞–Ω–µ–ª–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
function closeAllFilterPanels() {
    ['advancedFiltersPanel', 'roomsFilterPanel', 'priceFilterPanel', 'developerFilterPanel', 'saveSearchModal', 'searchModalPanel'].forEach(panelId => {
        const panel = document.getElementById(panelId);
        if (panel) {
            panel.classList.add('hidden');
            panel.classList.remove('mobile-fullscreen');
        }
    });
    document.body.style.overflow = '';
}

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ inline onclick
window.applyRoomsFilter = applyRoomsFilter;
window.applyPriceFilterModal = applyPriceFilterModal;
window.applyDeveloperFilter = applyDeveloperFilter;
window.resetRoomsFilter = resetRoomsFilter;
window.resetPriceFilter = resetPriceFilter;
window.resetDeveloperFilter = resetDeveloperFilter;
window.openRoomsFilterPanel = openRoomsFilterPanel;
window.openPriceFilterPanel = openPriceFilterPanel;
window.openDeveloperFilterPanel = openDeveloperFilterPanel;
window.closeAllFilterPanels = closeAllFilterPanels;

console.log('‚úÖ Filter panel functions exported to window');

// ========== –ü–ï–†–ï–•–í–ê–¢ –ö–õ–ò–ö–û–í –ù–ê DROPDOWN –ö–ù–û–ü–ö–ê–• –î–õ–Ø –ú–û–ë–ê–ô–õ–ê ==========
document.addEventListener('DOMContentLoaded', function() {
    // Rooms filter - –Ω–∞ –º–æ–±–∞–π–ª–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
    const roomsDropdownBtn = document.querySelector('.dropdown[data-filter="rooms"] .dropdown-btn');
    if (roomsDropdownBtn) {
        roomsDropdownBtn.addEventListener('click', function(e) {
            if (window.innerWidth < 768) {
                e.stopPropagation();
                e.preventDefault();
                openRoomsFilterPanel();
            }
        });
    }
    
    // Price filter - –Ω–∞ –º–æ–±–∞–π–ª–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
    const priceDropdownBtn = document.querySelector('.dropdown[data-filter="price"] .dropdown-btn');
    if (priceDropdownBtn) {
        priceDropdownBtn.addEventListener('click', function(e) {
            if (window.innerWidth < 768) {
                e.stopPropagation();
                e.preventDefault();
                openPriceFilterPanel();
            }
        });
    }
    
    // Developer filter - –Ω–∞ –º–æ–±–∞–π–ª–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
    const developerDropdownBtn = document.querySelector('.dropdown[data-filter="developers"] .dropdown-btn');
    if (developerDropdownBtn) {
        developerDropdownBtn.addEventListener('click', function(e) {
            if (window.innerWidth < 768) {
                e.stopPropagation();
                e.preventDefault();
                openDeveloperFilterPanel();
            }
        });
    }
    
    console.log('‚úÖ Mobile filter panel listeners initialized');
});

// Apply all filters
function resetAllFilters() {
    // Reset all form elements
    document.getElementById('property-search').value = '';
    document.getElementById('district-filter').value = '';
    document.getElementById('developer-filter').value = '';
    document.getElementById('price-from').value = '';
    document.getElementById('price-to').value = '';
    document.getElementById('area-from').value = '';
    document.getElementById('area-to').value = '';
    document.getElementById('property-type-filter').value = '';
    document.getElementById('completion-date-filter').value = '';
    document.getElementById('mortgage-filter').value = '';
    document.getElementById('sort-select').value = 'price-asc';
    
    // Reset room buttons
    selectedRooms.clear();
    document.querySelectorAll('.room-btn').forEach(button => {
        button.classList.remove('bg-[#0088CC]', 'text-white', 'border-[#0088CC]');
        button.classList.add('border-gray-300', 'text-gray-700');
    });
    
    // Reset advanced filters
    if (typeof resetAdvancedFilters === 'function') {
        resetAdvancedFilters();
    }
    
    // Hide reset button
    document.getElementById('resetFiltersBtn').style.display = 'none';
    
    // Clear URL parameters and redirect to clean properties page
    window.location.href = '/' + citySlug + '/properties';
}


// Update properties list display with pagination
function updatePropertiesList(properties) {
    const listContainer = document.getElementById('properties-container');
    
    if (!listContainer) {
        console.warn('Properties container not found - display mode may not be available');
        return;
    }
    
    if (properties.length === 0) {
        listContainer.innerHTML = `
            <div class="text-center py-12">
                <div class="text-gray-400 text-6xl mb-4">üîç</div>
                <h3 class="text-xl font-semibold text-gray-600 mb-2">–ö–≤–∞—Ä—Ç–∏—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                <p class="text-gray-500">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</p>
            </div>
        `;
        // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é –µ—Å–ª–∏ –Ω–µ—Ç –æ–±—ä–µ–∫—Ç–æ–≤
        const paginationContainer = document.getElementById('pagination-container');
        if (paginationContainer) paginationContainer.innerHTML = '';
        return;
    }
    
    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ù–ï –î–ï–õ–ê–ï–ú –ø–∞–≥–∏–Ω–∞—Ü–∏—é –∑–¥–µ—Å—å - properties —É–∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω—ã –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    console.log(`üìä –†–µ–Ω–¥–µ—Ä–∏–º ${properties.length} –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã ${currentPage}`);
    const paginatedProperties = properties; // –ü—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    
    // Get current view mode from data attribute
    const isGridView = listContainer.getAttribute('data-view-mode') === 'grid';
    
    if (isGridView) {
        listContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
    } else {
        listContainer.className = 'space-y-6';
    }
    
    console.log(`üîÑ –†–µ–Ω–¥–µ—Ä–∏–Ω–≥: —Ä–µ–∂–∏–º ${isGridView ? '—Å–µ—Ç–∫–∞' : '—Å–ø–∏—Å–æ–∫'}, —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage}, –æ–±—ä–µ–∫—Ç–æ–≤: ${properties.length}`);
    
    // Create manager block (will be inserted between properties) - uses user's manager or company data
    const manager = window.userManager;
    const managerName = manager ? manager.name : 'InBack';
    const managerPhone = manager ? manager.phone : '8 (862) 266-62-16';
    const managerEmail = manager ? manager.email : 'info@inback.ru';
    const managerPhoto = manager && manager.photo ? manager.photo : null;
    const managerInitials = manager ? (manager.name.split(' ')[0][0] + (manager.name.split(' ')[1] ? manager.name.split(' ')[1][0] : '')) : 'IB';
    const managerLabel = manager ? '–ú–µ–Ω–µ–¥–∂–µ—Ä' : 'InBack';
    const helpText = manager ? '–æ—Ç –≤–∞—à–µ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞' : '–æ—Ç –Ω–∞—à–µ–π –∫–æ–º–∞–Ω–¥—ã';
    
    const managerBlock = `
        <div class="manager-block bg-gray-100 rounded-lg p-4 border border-gray-200 shadow-sm relative ${isGridView ? 'md:col-span-2 lg:col-span-3' : ''}" id="manager-block-${currentPage}">
            <button class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 transition-colors" onclick="this.parentElement.style.display='none';" title="√ó">
                <i class="fas fa-times"></i>
            </button>
            <div class="flex items-center gap-4">
                <div class="flex-shrink-0">
                    ${managerPhoto 
                        ? `<img src="${managerPhoto}" alt="${managerName}" class="w-16 h-16 rounded object-cover">` 
                        : manager 
                            ? `<div class="w-16 h-16 rounded bg-blue-600 flex items-center justify-center text-white text-sm font-bold">${managerInitials}</div>`
                            : `<div class="w-16 h-16 rounded bg-blue-600 flex items-center justify-center text-white text-xl"><i class="fas fa-building"></i></div>`
                    }
                    <div class="bg-blue-600 text-white text-xs px-2 py-1 rounded mt-1 text-center font-medium">${managerLabel}</div>
                </div>
                <div class="flex-1">
                    <h3 class="text-lg font-semibold text-gray-900 mb-1">${managerName}</h3>
                    <p class="text-gray-600 text-sm mb-3">–ü–æ–ª—É—á–∏—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –ø–æ–º–æ—â—å ${helpText} –ø–æ –ø–æ–∫—É–ø–∫–µ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏</p>
                    <div class="flex items-center gap-4 text-sm">
                        <div class="flex items-center gap-1 text-blue-600">
                            <i class="fas fa-phone text-xs"></i>
                            <span>${managerPhone}</span>
                        </div>
                        <div class="flex items-center gap-1 text-blue-600">
                            <i class="fas fa-envelope text-xs"></i>
                            <span>${managerEmail}</span>
                        </div>
                    </div>
                </div>
                <div class="flex-shrink-0">
                    <button onclick="openApplicationModal()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-medium hover:bg-blue-700 transition">
                        <i class="fas fa-comments mr-1"></i>
                        –°–≤—è–∑–∞—Ç—å—Å—è
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Render paginated properties with manager blocks inserted
    const propertyCards = [];
    paginatedProperties.forEach((property, index) => {
        // Add manager block after every 6th property (every 2 rows in grid view)
        if (index > 0 && index % 6 === 0) {
            propertyCards.push(managerBlock);
        }
        
        // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–∏–¥–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        if (isGridView) {
            // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è —Å–µ—Ç–∫–∏
            propertyCards.push(`
            <div class="property-card bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden cursor-pointer flex flex-col h-full" 
                 data-property-url="/${citySlug}/object/${property.id}"
                 data-type="${property.type}" 
                 data-rooms="${property.rooms}" 
                 data-price="${property.price}" 
                 data-district="${property.district}" 
                 data-developer="${property.developer}"
                 data-complex="${property.complex_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}"
                 data-property-type="${property.property_type || property.type}">
                
                <!-- Image Section -->
                <div class="relative h-48 group">
                    <div class="carousel-container w-full h-full relative overflow-hidden bg-gray-100" data-property-id="${property.id}">
                        ${(property.gallery && property.gallery.length > 0 ? property.gallery : [property.image]).map((image, index) => `
                            <div class="carousel-slide absolute inset-0 transition-opacity duration-300 ${index === 0 ? '' : 'opacity-0'}" data-slide="${index}">
                                <img src="${image}" alt="${property.rooms == 0 ? '–°—Ç—É–¥–∏—è' : property.rooms + '-–∫–æ–º–Ω'} ${property.area} –º¬≤ –≤ –ñ–ö ${property.complex_name || property.residential_complex || ''}, –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä" class="w-full h-full object-cover">
                            </div>
                        `).join('')}
                        
                        ${(property.gallery && property.gallery.length > 1) ? `
                        <button onclick="event.stopPropagation(); event.preventDefault(); prevImageSlide(this, event);" class="absolute left-2 top-1/2 -translate-y-1/2 w-6 h-6 bg-black/50 hover:bg-black/70 text-white rounded-full flex items-center justify-center transition-all opacity-0 group-hover:opacity-100 z-10">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <button onclick="event.stopPropagation(); event.preventDefault(); nextImageSlide(this, event);" class="absolute right-2 top-1/2 -translate-y-1/2 w-6 h-6 bg-black/50 hover:bg-black/70 text-white rounded-full flex items-center justify-center transition-all opacity-0 group-hover:opacity-100 z-10">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </button>
                        ` : ''}
                    </div>
                    
                    <!-- Badges -->
                    <div class="absolute top-2 left-2 bg-blue-600 text-white text-xs font-medium px-2 py-1 rounded z-20">
                        –ö—ç—à–±–µ–∫ –¥–æ ${Math.round(property.cashback || 0).toLocaleString('ru-RU')} ‚ÇΩ
                    </div>
                    
                    <div class="absolute top-2 right-2 w-7 h-7 bg-white/90 hover:bg-white rounded-full flex items-center justify-center shadow-sm cursor-pointer favorite-heart z-20" data-property-id="${property.id}" title="–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ">
                        <i class="fas fa-heart text-gray-400 hover:text-red-500 text-xs transition-colors"></i>
                    </div>
                </div>
                
                <!-- Content -->
                <div class="p-4 flex flex-col flex-1">
                    <h3 class="font-semibold text-gray-900 mb-2 text-sm">
                        ${property.rooms == 0 ? '–°—Ç—É–¥–∏—è' : property.rooms + '-–∫–æ–º–Ω'}, ${property.area} –º¬≤, ${property.floor}/${property.total_floors} —ç—Ç.
                    </h3>
                    
                    <div class="mb-2">
                        <a href="${(property.residential_complex || property.complex_name) ? '/residential-complex/' + (property.residential_complex || property.complex_name) : '#'}" 
                           class="text-blue-600 hover:text-blue-700 hover:underline text-xs" onclick="event.stopPropagation();">
                            ${property.residential_complex || property.complex_name || '–ñ–ö –õ–µ—Ç–Ω–∏–π'}
                        </a>
                        <span class="text-blue-600 text-xs"> ‚Ä¢ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä</span>
                    </div>
                    
                    <div class="text-gray-600 text-xs mb-3">
                        <span class="font-medium">–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫:</span> ${property.developer || property.developer_name || '–ì–ö –ù–µ–æ–º–µ—Ç—Ä–∏—è'}
                    </div>
                    
                    <div class="flex-1"></div>
                    
                    <div class="flex items-center justify-between mt-auto">
                        <div>
                            ${property.price && property.price > 0 ? `
                            <div class="text-lg font-bold text-gray-900">
                                ${property.price.toLocaleString('ru-RU')} ‚ÇΩ
                            </div>
                            <div class="text-xs text-green-600">
                                –æ—Ç ${Math.floor(property.price * 0.05 / 12).toLocaleString('ru-RU')} ‚ÇΩ/–º–µ—Å
                            </div>
                            ` : `
                            <div class="text-lg font-bold text-gray-900">
                                –ü–æ –∑–∞–ø—Ä–æ—Å—É
                            </div>
                            `}
                        </div>
                        <div class="flex gap-1">
                            <a href="/object/${property.id}/pdf" target="_blank" 
                               class="w-8 h-8 bg-white/90 hover:bg-white rounded-full flex items-center justify-center shadow-sm text-gray-600 hover:text-blue-600 transition-all" 
                               title="PDF" onclick="event.stopPropagation();">
                                <i class="fas fa-file-pdf text-xs"></i>
                            </a>
                            <button class="compare-btn w-8 h-8 bg-white/90 hover:bg-white rounded-full flex items-center justify-center shadow-sm text-gray-600 hover:text-blue-600 transition-all" 
                                    data-property-id="${property.id}" title="–°—Ä–∞–≤–Ω–∏—Ç—å">
                                <i class="fas fa-balance-scale text-xs"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>`);
        } else {
            // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è —Å–ø–∏—Å–∫–∞
            propertyCards.push(`
            <div class="property-card bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden w-full flex cursor-pointer min-h-[280px]" 
                 data-property-url="/${citySlug}/object/${property.id}"
                 data-type="${property.type}" 
                 data-rooms="${property.rooms}" 
                 data-price="${property.price}" 
                 data-district="${property.district}" 
                 data-developer="${property.developer}"
                 data-complex="${property.complex_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}"
                 data-property-type="${property.property_type || property.type}">
                
                <!-- Image Section with Slider -->
                <div class="relative w-80 h-60 flex-shrink-0 group">
                    <div class="carousel-container w-full h-60 relative overflow-hidden bg-gray-100 rounded-lg" data-property-id="${property.id}">
                        ${(property.gallery && property.gallery.length > 0 ? property.gallery : [property.image]).map((image, index) => `
                            <div class="carousel-slide absolute inset-0 transition-opacity duration-300 ${index === 0 ? '' : 'opacity-0'}" data-slide="${index}">
                                <img src="${image}" alt="${property.rooms == 0 ? '–°—Ç—É–¥–∏—è' : property.rooms + '-–∫–æ–º–Ω'} ${property.area} –º¬≤ –≤ –ñ–ö ${property.complex_name || property.residential_complex || ''}, –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä - —Ñ–æ—Ç–æ ${index + 1}" class="w-full h-full object-cover">
                            </div>
                        `).join('')}
                        
                        ${(property.gallery && property.gallery.length > 1) ? `
                        <!-- Navigation arrows -->
                        <button onclick="event.stopPropagation(); event.preventDefault(); prevImageSlide(this, event);" class="absolute left-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-black/50 hover:bg-black/70 text-white rounded-full flex items-center justify-center transition-all opacity-0 group-hover:opacity-100 z-10">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <button onclick="event.stopPropagation(); event.preventDefault(); nextImageSlide(this, event);" class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-black/50 hover:bg-black/70 text-white rounded-full flex items-center justify-center transition-all opacity-0 group-hover:opacity-100 z-10">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </button>
                        
                        <!-- Dots indicator -->
                        <div class="absolute bottom-3 left-1/2 -translate-x-1/2 flex gap-1.5 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                            ${(property.gallery && property.gallery.length > 0 ? property.gallery : [property.image]).slice(0, 4).map((_, index) => `
                                <button onclick="event.stopPropagation(); event.preventDefault(); goToImageSlide(this, ${index}, event);" class="w-2.5 h-2.5 rounded-full ${index === 0 ? 'bg-white/80' : 'bg-white/50'} hover:bg-white transition-colors"></button>
                            `).join('')}
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Blue Cashback Badge -->
                    <div class="absolute top-3 left-3 bg-blue-600 text-white text-xs font-medium px-2 py-1 rounded z-20">
                        –ö—ç—à–±–µ–∫ –¥–æ ${Math.round(property.cashback || 0).toLocaleString('ru-RU')} ‚ÇΩ
                    </div>
                    
                    <!-- Favorite Icons Container -->
                    <div class="absolute top-3 right-3 flex gap-2 z-20">
                        <!-- Universal Heart Icon -->
                        <div class="w-8 h-8 bg-white/90 hover:bg-white rounded-full flex items-center justify-center shadow-sm cursor-pointer favorite-heart z-20" data-property-id="${property.id}" title="–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ">
                            <i class="fas fa-heart text-gray-400 hover:text-red-500 text-sm transition-colors"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Content Section -->
                <div class="flex-1 p-6 flex flex-col">
                    <!-- Title -->
                    <h2 class="text-xl font-semibold text-gray-900 mb-3">
                        ${property.rooms == 0 ? '–°—Ç—É–¥–∏—è' : property.rooms + '-–∫–æ–º–Ω'}, ${property.area} –º¬≤, ${property.floor}/${property.total_floors} —ç—Ç.
                    </h2>
                    
                    <!-- Complex and Location -->
                    <div class="mb-2">
                        <a href="${(property.residential_complex || property.complex_name) ? '/residential-complex/' + (property.residential_complex || property.complex_name) : '#'}" 
                           class="text-blue-600 hover:text-blue-700 hover:underline text-sm font-medium" onclick="event.stopPropagation();">
                            ${property.residential_complex || property.complex_name || '–ñ–ö –õ–µ—Ç–Ω–∏–π'}
                        </a>
                        <span class="text-blue-600 text-sm"> ‚Ä¢ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π</span>
                    </div>
                    
                    <!-- Address -->
                    <div class="text-gray-500 text-sm mb-2">
                        ${property.address || '–†–æ—Å—Å–∏—è, –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π, –°–æ—á–∏, –ö—É–¥–µ–ø—Å—Ç–∞ –º-–Ω, –ò—Å–∫—Ä–∞, 88 –ª–∏—Ç7'}
                    </div>
                    
                    <!-- Developer -->
                    <div class="text-gray-700 text-sm mb-4">
                        <span class="font-medium">–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫:</span> ${property.developer || property.developer_name || '–ì–ö –ù–µ–æ–º–µ—Ç—Ä–∏—è'}
                    </div>
                    
                    <!-- Tags -->
                    <div class="flex gap-2 mb-4">
                        <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">${property.floor}-–π —ç—Ç–∞–∂</span>
                        <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">${property.renovation_display_name || '–ë–µ–∑ –æ—Ç–¥–µ–ª–∫–∏'}</span>
                        <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">${property.complex_object_class_display_name || '–ö–æ–º—Ñ–æ—Ä—Ç'}</span>
                    </div>
                    
                    <div class="flex-1"></div>
                    
                    <!-- Action Buttons Row with Price and Mortgage Info -->
                    <div class="flex items-center justify-between">
                        <div class="flex flex-col gap-2">
                            ${property.price && property.price > 0 ? `
                            <div class="text-2xl font-bold text-gray-900">
                                ${property.price.toLocaleString('ru-RU')} ‚ÇΩ
                            </div>
                            <div class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">
                                –æ—Ç ${Math.floor(property.price * 0.05 / 12).toLocaleString('ru-RU')} ‚ÇΩ/–º–µ—Å –∏–ø–æ—Ç–µ–∫–∞
                            </div>
                            ` : `
                            <div class="text-2xl font-bold text-gray-900">
                                –¶–µ–Ω–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É
                            </div>
                            `}
                        </div>
                        <div class="flex gap-2">
                            <a href="/object/${property.id}/pdf" target="_blank" 
                               class="w-10 h-10 bg-white/90 hover:bg-white rounded-full flex items-center justify-center shadow-sm text-gray-600 hover:text-blue-600 hover:scale-105 transition-all duration-200" 
                               title="–°–∫–∞—á–∞—Ç—å PDF" onclick="event.stopPropagation();">
                                <i class="fas fa-file-pdf"></i>
                            </a>
                            <button class="compare-btn w-10 h-10 bg-white/90 hover:bg-white rounded-full flex items-center justify-center shadow-sm text-gray-600 hover:text-blue-600 hover:scale-105 transition-all duration-200" 
                                    data-property-id="${property.id}" title="–î–æ–±–∞–≤–∏—Ç—å –∫ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é">
                                <i class="fas fa-balance-scale"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>`);
        }
    });
    
    // Set the combined content to container
    listContainer.innerHTML = propertyCards.join('');
    
    // ‚úÖ –£–ë–†–ê–õ–ò: –ù–ï –æ–±–Ω–æ–≤–ª—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é –∑–¥–µ—Å—å - —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –≤ filterProperties()
    // updatePaginationControls(totalItems, totalPages);
    
    // Initialize favorites and comparison buttons after rendering
    setTimeout(() => {
        initializeAllButtons();
        
        // –ö–†–ò–¢–ò–ß–ù–û: –ü–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –¥–ª—è –í–°–ï–• –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        if (window.favoritesManager) {
            console.log('üîÑ Updating favorites UI after rendering');
            window.favoritesManager.updateFavoritesUI();
            window.favoritesManager.updateComplexFavoritesUI();
        }
        
        // –ö–†–ò–¢–ò–ß–ù–û: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
        const isManager = document.querySelector('a[href*="manager/dashboard"]') !== null;
        console.log('üîç Checking manager status:', isManager);
        console.log('üîç Property cards found:', document.querySelectorAll('.property-card').length);
        
        if (isManager) {
            let addedButtons = 0;
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä—è–¥–æ–º —Å –∫–Ω–æ–ø–∫–æ–π —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            document.querySelectorAll('.property-card').forEach((card, index) => {
                const existingPresentationBtn = card.querySelector('.presentation-btn');
                const compareBtn = card.querySelector('.compare-btn');
                const propertyId = compareBtn?.getAttribute('data-property-id') || 
                                 card.querySelector('.favorite-heart')?.getAttribute('data-property-id');
                
                console.log(`üîç Card ${index}: compareBtn=${!!compareBtn}, existingBtn=${!!existingPresentationBtn}, propertyId=${propertyId}`);
                
                // –ò—â–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–Ω–æ–ø–∫–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è - –∏–º–µ–Ω–Ω–æ —Ç—É–¥–∞ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏
                if (compareBtn && !existingPresentationBtn && propertyId) {
                    const buttonsContainer = compareBtn.parentElement;
                    console.log(`üîç Found buttons container:`, buttonsContainer?.className);
                    
                    if (buttonsContainer) {
                        const presentationBtn = document.createElement('button');
                        presentationBtn.className = 'presentation-btn w-10 h-10 bg-white border border-[#0088CC] rounded flex items-center justify-center text-[#0088CC] hover:bg-blue-50 hover:border-blue-600 hover:text-blue-700 hover:scale-105 transition-all duration-200';
                        presentationBtn.setAttribute('data-property-id', propertyId);
                        presentationBtn.title = '–î–æ–±–∞–≤–∏—Ç—å –≤ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é';
                        presentationBtn.innerHTML = '<i class="fas fa-plus"></i>';
                        presentationBtn.onclick = function(e) {
                            e.stopPropagation();
                            openPresentationModal(propertyId);
                        };
                        buttonsContainer.appendChild(presentationBtn);
                        addedButtons++;
                    }
                }
            });
            console.log(`üîÑ –ö–Ω–æ–ø–∫–∏ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã: ${addedButtons} –∏–∑ ${document.querySelectorAll('.property-card').length}`);
        }
        
        // –ö–†–ò–¢–ò–ß–ù–û: –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞
        if (typeof ensureCompareButtonIcons === 'function') {
            ensureCompareButtonIcons();
        }
        
        // –ö–†–ò–¢–ò–ß–ù–û: –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –Ω–æ–≤—ã—Ö –∫–Ω–æ–ø–æ–∫
        setTimeout(() => {
            // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –¥–ª—è –í–°–ï–• –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            if (window.favoritesManager) {
                window.favoritesManager.updateFavoritesUI();
                window.favoritesManager.updateComplexFavoritesUI();
            }
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é —Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–Ω–æ–ø–æ–∫ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            if (typeof window.reinitComparisonButtons === 'function') {
                window.reinitComparisonButtons();
            }
        }, 100);
        
        console.log('Property list updated, buttons initialized');
    }, 50);
}

// Advanced Filters System  
let activeFilters = {};
let originalProperties = [...allProperties];

function initializeClearAllButton() {
    // Clear all filters button - –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
    console.log('üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ "–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ"...');
    const clearAllBtn = document.getElementById('clearAllFilters');
    if (clearAllBtn) {
        console.log('‚úÖ –ö–Ω–æ–ø–∫–∞ clearAllFilters –Ω–∞–π–¥–µ–Ω–∞, –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫');
        clearAllBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('üéØ –ö–Ω–æ–ø–∫–∞ "–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ" –Ω–∞–∂–∞—Ç–∞ - –≤—ã–∑—ã–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é');
            try {
                clearAllActiveFilters();
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤:', error);
            }
        });
        console.log('‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ clearAllFilters —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
    } else {
        console.warn('‚ö†Ô∏è –ö–Ω–æ–ø–∫–∞ clearAllFilters –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ DOM');
        console.log('üîç –ü–æ–∏—Å–∫ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ:');
        const allButtons = document.querySelectorAll('button');
        allButtons.forEach((btn, index) => {
            console.log(`–ö–Ω–æ–ø–∫–∞ ${index}: id="${btn.id}", class="${btn.className}", text="${btn.textContent.trim()}"`);
        });
    }
}

// ‚úÖ –£–î–ê–õ–ï–ù–ê: –ü–µ—Ä–≤–∞—è –¥—É–±–ª–∏—Ä—É—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è

// Initialize dropdown filters functionality
function initializeDropdownFilters() {
    console.log('üîß initializeDropdownFilters() CALLED');
    
    // Remove existing listeners to prevent duplicates
    const existingListeners = document.querySelectorAll('[data-dropdown-initialized]');
    existingListeners.forEach(el => el.removeAttribute('data-dropdown-initialized'));
    
    // Get property filter buttons - include quick filters but exclude header dropdowns  
    const searchSection = document.querySelector('section.py-8.bg-gray-50');
    const propertySection = document.querySelector('section.container.mx-auto.px-4.py-6');
    
    console.log('üîç searchSection:', searchSection);
    console.log('üîç propertySection:', propertySection);
    
    if (!searchSection && !propertySection) {
        console.error('‚ùå NO sections found!');
        return;
    }
    
    // Get quick filter buttons from search section and advanced filter buttons from property section
    let filterButtons = [];
    if (searchSection) {
        const quickFilterBtns = Array.from(searchSection.querySelectorAll('.dropdown .dropdown-btn'));
        console.log(`‚úÖ Found ${quickFilterBtns.length} quick filter buttons in searchSection`);
        filterButtons = filterButtons.concat(quickFilterBtns);
    }
    if (propertySection) {
        filterButtons = filterButtons.concat(Array.from(propertySection.querySelectorAll('.filter-dropdown .filter-option-btn, #toggleAllFilters')));
    }
    
    // Also get buttons from advanced filters section
    const advancedSection = document.querySelector('#advancedFiltersSection');
    if (advancedSection) {
        filterButtons = filterButtons.concat(Array.from(advancedSection.querySelectorAll('.filter-dropdown .filter-option-btn')));
    }
    
    filterButtons.forEach(button => {
        // Skip if already initialized
        if (button.hasAttribute('data-dropdown-initialized')) return;
        button.setAttribute('data-dropdown-initialized', 'true');
        
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (this.id === 'toggleAllFilters') {
                // Handle "–í—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã" button specially
                toggleAdvancedFilters();
                return;
            }
            
            const dropdown = this.closest('.filter-dropdown') || this.closest('.dropdown');
            let menu = null;
            
            if (dropdown) {
                menu = dropdown.querySelector('.dropdown-menu');
            }
            
            if (!menu && dropdown) {
                // Also check for filter-dropdown-menu class for advanced filters
                menu = dropdown.querySelector('.filter-dropdown-menu');
            }
            
            if (menu) {
                // Check current menu state BEFORE closing others
                let isCurrentMenuOpen = false;
                if (menu.classList.contains('dropdown-menu')) {
                    isCurrentMenuOpen = menu.classList.contains('open');
                } else if (menu.classList.contains('filter-dropdown-menu')) {
                    isCurrentMenuOpen = !menu.classList.contains('hidden');
                }
                
                // Close all dropdowns including the current one
                document.querySelectorAll('.dropdown-menu.open, .filter-dropdown-menu:not(.hidden)').forEach(openMenu => {
                    openMenu.classList.remove('open');
                    openMenu.classList.add('hidden');
                });
                
                // If the clicked menu was closed, open it
                if (!isCurrentMenuOpen) {
                    if (menu.classList.contains('dropdown-menu')) {
                        menu.classList.add('open');
                        menu.classList.remove('hidden');
                    } else if (menu.classList.contains('filter-dropdown-menu')) {
                        menu.classList.remove('hidden');
                    }
                    console.log('Dropdown opened');
                } else {
                    console.log('Dropdown closed');
                }
            }
        });
    });
    
    // Remove existing document click listener and add fresh one
    if (window.dropdownDocumentListener) {
        document.removeEventListener('click', window.dropdownDocumentListener);
    }
    
    window.dropdownDocumentListener = function(e) {
        // Only close property filter dropdowns, never touch header
        const searchSection = document.querySelector('section.py-8.bg-gray-50');
        const propertySection = document.querySelector('section.container.mx-auto.px-4.py-6');
        
        if (!e.target.closest('.filter-dropdown') && !e.target.closest('.dropdown') && !e.target.closest('#allFiltersPanel') && !e.target.closest('header') && !e.target.closest('nav')) {
            // Close dropdowns within search section (quick filters)
            if (searchSection) {
                searchSection.querySelectorAll('.dropdown-menu.open').forEach(menu => {
                    menu.classList.remove('open');
                });
            }
            
            // Close dropdowns within property section (advanced filters)
            if (propertySection) {
                propertySection.querySelectorAll('.dropdown-menu.open').forEach(menu => {
                    menu.classList.remove('open');
                });
                propertySection.querySelectorAll('.filter-dropdown-menu:not(.hidden)').forEach(menu => {
                    menu.classList.add('hidden');
                });
                propertySection.querySelectorAll('#allFiltersPanel').forEach(panel => {
                    panel.classList.add('hidden');
                });
            }
            
            // Close dropdowns within advanced filters section
            const advancedSection = document.querySelector('#advancedFiltersSection');
            if (advancedSection) {
                advancedSection.querySelectorAll('.dropdown-menu.open').forEach(menu => {
                    menu.classList.remove('open');
                });
                advancedSection.querySelectorAll('.filter-dropdown-menu:not(.hidden)').forEach(menu => {
                    menu.classList.add('hidden');
                });
            }
        }
    };
    
    document.addEventListener('click', window.dropdownDocumentListener);
}

// Handle property type filter changes (–ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞/–í—Ç–æ—Ä–∏—á–∫–∞)
function handlePropertyTypeFilterChange(event) {
    const sourceRadio = event ? event.target : null;
    if (!sourceRadio) return;
    
    const selectedValue = sourceRadio.value;
    
    // Update button text
    let buttonText = '–í—Å–µ —Ç–∏–ø—ã';
    if (selectedValue === 'new') {
        buttonText = '–ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞';
    } else if (selectedValue === 'secondary') {
        buttonText = '–í—Ç–æ—Ä–∏—á–Ω–∞—è';
    }
    
    const textElement = document.getElementById('propertyTypeFilterText');
    if (textElement) {
        textElement.textContent = buttonText;
    }
    
    console.log('Property type filter changed:', selectedValue);
}

// Handle room filter changes
function handleRoomFilterChange() {
    // Add small delay to prevent rapid fire events
    if (window.roomFilterTimeout) {
        clearTimeout(window.roomFilterTimeout);
    }
    
    window.roomFilterTimeout = setTimeout(() => {
        const checkedRooms = Array.from(document.querySelectorAll('input[data-filter-type="rooms"]:checked')).map(cb => cb.value);
        console.log('Room filters changed:', checkedRooms);
        
        // Map numeric values to display labels
        const roomLabels = {
            '0': '–°—Ç—É–¥–∏—è',
            '1': '1-–∫–æ–º–Ω',
            '2': '2-–∫–æ–º–Ω',
            '3': '3-–∫–æ–º–Ω',
            '4': '4-–∫–æ–º–Ω'
        };
        
        // Update button text
        const buttonText = document.getElementById('roomsFilterText');
        if (buttonText) {
            if (checkedRooms.length === 0) {
                buttonText.textContent = '–ö–æ–º–Ω–∞—Ç';
            } else if (checkedRooms.length === 1) {
                buttonText.textContent = roomLabels[checkedRooms[0]] || checkedRooms[0];
            } else {
                buttonText.textContent = `${checkedRooms.length} —Ç–∏–ø–æ–≤`;
            }
        }
        
        // ‚úÖ REMOVED: filterProperties() - only update UI, actual filtering happens via "–ù–∞–π—Ç–∏" button
    }, 100);
}

// Handle region filter changes
function handleRegionFilterChange() {
    if (window.regionFilterTimeout) {
        clearTimeout(window.regionFilterTimeout);
    }
    
    window.regionFilterTimeout = setTimeout(() => {
        const checkedRegions = Array.from(document.querySelectorAll('input[data-filter-type="region"]:checked')).map(cb => cb.value);
        console.log('Region filters changed:', checkedRegions);
        
        // Update button text
        const buttonText = document.getElementById('regionFilterText');
        if (buttonText) {
            if (checkedRegions.length === 0) {
                buttonText.textContent = '–†–µ–≥–∏–æ–Ω';
            } else if (checkedRegions.length === 1) {
                buttonText.textContent = checkedRegions[0];
            } else {
                buttonText.textContent = `${checkedRegions.length} —Ä–µ–≥–∏–æ–Ω–æ–≤`;
            }
        }
        
        // ‚úÖ REMOVED: filterProperties() - only update UI, actual filtering happens via "–ù–∞–π—Ç–∏" button
    }, 100);
}

// Handle city filter changes
function handleCityFilterChange() {
    if (window.cityFilterTimeout) {
        clearTimeout(window.cityFilterTimeout);
    }
    
    window.cityFilterTimeout = setTimeout(() => {
        const checkedCities = Array.from(document.querySelectorAll('input[data-filter-type="city"]:checked')).map(cb => cb.value);
        console.log('City filters changed:', checkedCities);
        
        // Update button text
        const buttonText = document.getElementById('cityFilterText');
        if (buttonText) {
            if (checkedCities.length === 0) {
                buttonText.textContent = '–ì–æ—Ä–æ–¥';
            } else if (checkedCities.length === 1) {
                buttonText.textContent = checkedCities[0];
            } else {
                buttonText.textContent = `${checkedCities.length} –≥–æ—Ä–æ–¥–æ–≤`;
            }
        }
        
        // ‚úÖ REMOVED: filterProperties() - only update UI, actual filtering happens via "–ù–∞–π—Ç–∏" button
    }, 100);
}

// Apply filters with proper function name
function applyFiltersFixed() {
    console.log('Applying filters...');
    filterProperties();
}

// Apply price filter
function applyPriceFilter() {
    const priceFrom = document.getElementById('priceFrom').value;
    const priceTo = document.getElementById('priceTo').value;
    
    console.log('Price filter:', priceFrom, 'to', priceTo);
    
    // Update button text
    const buttonText = document.getElementById('priceFilterText');
    if (priceFrom || priceTo) {
        let text = '–¶–µ–Ω–∞ ';
        if (priceFrom) text += `–æ—Ç ${priceFrom}–º–ª–Ω `;
        if (priceTo) text += `–¥–æ ${priceTo}–º–ª–Ω`;
        buttonText.textContent = text.trim() + ' ‚ÇΩ';
    } else {
        buttonText.textContent = '–¶–µ–Ω–∞ –æ—Ç-–¥–æ, ‚ÇΩ';
    }
    
    // Only update filter state and display active filters, don't trigger search
    displayActiveFilters();
    
    // Close dropdown
    const dropdown = document.querySelector('[data-filter="price"] .dropdown-menu');
    if (dropdown) dropdown.classList.remove('open');
}

// Apply advanced filters from "–ï—â–µ" section
function applyAdvancedFilters() {
    console.log('Applying advanced filters...');
    
    // Collect all advanced filter values
    const advancedFilters = {};
    
    // Area range
    const areaFrom = document.getElementById('areaFrom').value;
    const areaTo = document.getElementById('areaTo').value;
    if (areaFrom) advancedFilters.areaFrom = parseInt(areaFrom);
    if (areaTo) advancedFilters.areaTo = parseInt(areaTo);
    
    // Floor range
    const floorFrom = document.getElementById('floorFrom').value;
    const floorTo = document.getElementById('floorTo').value;
    if (floorFrom) advancedFilters.floorFrom = parseInt(floorFrom);
    if (floorTo) advancedFilters.floorTo = parseInt(floorTo);
    
    // Building type (—ç—Ç–∞–∂–Ω–æ—Å—Ç—å –¥–æ–º–∞)
    const buildingTypes = Array.from(document.querySelectorAll('input[data-filter-type="building_type"]:checked')).map(cb => cb.value);
    if (buildingTypes.length > 0) advancedFilters.buildingTypes = buildingTypes;
    
    // Building status (—Å—Ç–∞—Ç—É—Å —Å–¥–∞—á–∏) - –ò–°–ü–†–ê–í–õ–ï–ù–û  
    const buildingReleased = Array.from(document.querySelectorAll('input[data-filter-type="building_released"]:checked')).map(cb => cb.value);
    if (buildingReleased.length > 0) advancedFilters.buildingReleased = buildingReleased;
    
    // Build year range (–¥–∏–∞–ø–∞–∑–æ–Ω –≥–æ–¥–∞ —Å–¥–∞—á–∏)
    const buildYearFrom = document.getElementById('buildYearFrom')?.value;
    const buildYearTo = document.getElementById('buildYearTo')?.value;
    if (buildYearFrom || buildYearTo) {
        advancedFilters.buildYearRange = {
            from: buildYearFrom ? parseInt(buildYearFrom) : null,
            to: buildYearTo ? parseInt(buildYearTo) : null
        };
    }
    
    // Features (–æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏)
    const features = Array.from(document.querySelectorAll('input[data-filter-type="features"]:checked')).map(cb => cb.value);
    if (features.length > 0) advancedFilters.features = features;
    
    // Object class (–∫–ª–∞—Å—Å –∂–∏–ª—å—è)
    const objectClasses = Array.from(document.querySelectorAll('input[data-filter-type="object_class"]:checked')).map(cb => cb.value);
    if (objectClasses.length > 0) advancedFilters.objectClasses = objectClasses;
    
    // Update activeFilters with advanced filters
    Object.assign(activeFilters, advancedFilters);
    
    console.log('Advanced filters applied:', advancedFilters);
    
    // Update filters counter
    const totalFilters = Object.keys(advancedFilters).length;
    const counter = document.getElementById('allFiltersCounter');
    if (counter) {
        if (totalFilters > 0) {
            counter.textContent = totalFilters;
            counter.classList.remove('hidden');
        } else {
            counter.classList.add('hidden');
        }
    }
    
    // Apply filters
    filterProperties();
    displayActiveFilters();
    
    // Close dropdown
    const dropdown = document.querySelector('[data-filter="advanced"] .dropdown-menu');
    if (dropdown) dropdown.classList.remove('open');
}

// Toggle advanced filters section
function toggleAdvancedFilters() {
    const section = document.getElementById('advancedFiltersSection');
    if (section) {
        section.classList.toggle('hidden');
        console.log('Advanced filters toggled:', !section.classList.contains('hidden'));
    }
}

// Enhanced filter properties function with room filtering
function filterProperties() {
    // Prevent concurrent filtering operations
    if (window.isFiltering) return;
    window.isFiltering = true;
    
    try {
        if (!allProperties || allProperties.length === 0) {
            console.log('No properties to filter');
            return;
        }
        
        // Get room filters
        const selectedRooms = Array.from(document.querySelectorAll('input[data-filter-type="rooms"]:checked')).map(cb => cb.value);
        
        // Get price filters  
        const priceFromEl = document.getElementById('priceFrom');
        const priceToEl = document.getElementById('priceTo');
        const priceFrom = priceFromEl ? parseFloat(priceFromEl.value || 0) : 0;
        const priceTo = priceToEl ? parseFloat(priceToEl.value || 0) : 0;
        
        // Get completion date filters
        const selectedCompletionDates = Array.from(document.querySelectorAll('input[data-filter-type="completion"]:checked')).map(cb => cb.value);
        
        // Get ADVANCED filters from "–ï—â–µ" section
        const areaFromEl = document.getElementById('areaFrom');
        const areaToEl = document.getElementById('areaTo');
        const areaFrom = areaFromEl ? parseFloat(areaFromEl.value || 0) : 0;
        const areaTo = areaToEl ? parseFloat(areaToEl.value || 0) : 0;
        
        const floorFromEl = document.getElementById('floorFrom');
        const floorToEl = document.getElementById('floorTo');
        const floorFrom = floorFromEl ? parseInt(floorFromEl.value || 0) : 0;
        const floorTo = floorToEl ? parseInt(floorToEl.value || 0) : 0;
        
        // Building floors range (—ç—Ç–∞–∂–Ω–æ—Å—Ç—å –¥–æ–º–∞) - –∏—Å–ø–æ–ª—å–∑—É–µ–º —á–∏—Å–ª–æ–≤—ã–µ –ø–æ–ª—è maxFloorFrom/maxFloorTo
        const maxFloorFromEl = document.getElementById('maxFloorFrom');
        const maxFloorToEl = document.getElementById('maxFloorTo');
        const maxFloorFrom = maxFloorFromEl ? parseInt(maxFloorFromEl.value || 0) : 0;
        const maxFloorTo = maxFloorToEl ? parseInt(maxFloorToEl.value || 0) : 0;
        
        // Building types - –∏—Å–ø–æ–ª—å–∑—É–µ–º —á–∏—Å–ª–æ–≤—ã–µ –ø–æ–ª—è –≤–º–µ—Å—Ç–æ —á–µ–∫–±–æ–∫—Å–æ–≤ (—á–µ–∫–±–æ–∫—Å–æ–≤ –Ω–µ—Ç –≤ HTML)
        const selectedBuildingTypes = []; // –ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ - —Ñ–∏–ª—å—Ç—Ä –æ—Ç–∫–ª—é—á–µ–Ω
        const selectedBuildingReleased = Array.from(document.querySelectorAll('input[data-filter-type="building_released"]:checked')).map(cb => cb.value);
        const selectedFeatures = Array.from(document.querySelectorAll('input[data-filter-type="features"]:checked')).map(cb => cb.value);
        const selectedRenovationTypes = Array.from(document.querySelectorAll('input[data-filter-type="renovation"]:checked')).map(cb => cb.value);
        const selectedObjectClasses = Array.from(document.querySelectorAll('input[data-filter-type="object_class"]:checked')).map(cb => cb.value);
        const selectedDevelopers = Array.from(document.querySelectorAll('input[data-filter-type="developer"]:checked')).map(cb => cb.value);
        const selectedDistricts = Array.from(document.querySelectorAll('input[data-filter-type="district"]:checked')).map(cb => cb.value);
        
        // Get regional filters
        const selectedRegions = Array.from(document.querySelectorAll('input[data-filter-type="region"]:checked')).map(cb => cb.value);
        const selectedCities = Array.from(document.querySelectorAll('input[data-filter-type="city"]:checked')).map(cb => cb.value);
        
        console.log('Filtering with:', {
            rooms: selectedRooms,
            priceFrom: priceFrom,
            priceTo: priceTo,
            completion: selectedCompletionDates,
            area: {from: areaFrom, to: areaTo},
            floor: {from: floorFrom, to: floorTo},
            buildingTypes: selectedBuildingTypes,
            buildingFloors: {from: maxFloorFrom, to: maxFloorTo},
            buildingReleased: selectedBuildingReleased,
            features: selectedFeatures,
            renovation: selectedRenovationTypes,
            objectClasses: selectedObjectClasses,
            developers: selectedDevelopers,
            districts: selectedDistricts,
            regions: selectedRegions,
            cities: selectedCities,
            complex: activeFilters.residential_complex || null  // ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Ñ–∏–ª—å—Ç—Ä –ø–æ –ñ–ö
        });
        
        // Debug: Show filter details
        if (floorFrom > 0 || floorTo > 0) {
            console.log(`Floor filter active: from ${floorFrom} to ${floorTo}`);
        }
        if (selectedDevelopers.length > 0) {
            console.log(`Developer filter active:`, selectedDevelopers);
        }
        
        // Debug: show some sample property data
        if (allProperties.length > 0) {
            console.log('Sample property for debugging:', {
                price: allProperties[0].price,
                priceInMillions: allProperties[0].price / 1000000,
                completion_date: allProperties[0].completion_date,
                rooms: allProperties[0].rooms,
                developer_name: allProperties[0].developer_name,
                complex_object_class_display_name: allProperties[0].complex_object_class_display_name,
                renovation_display_name: allProperties[0].renovation_display_name,
                object_min_floor: allProperties[0].object_min_floor,
                object_max_floor: allProperties[0].object_max_floor,
                object_area: allProperties[0].object_area
            });
        }
        
        filteredProperties = allProperties.filter(property => {
            // Room filter (merge quick and advanced filters)
            const allSelectedRooms = [...selectedRooms];
            if (advancedFilters.roomTypes && advancedFilters.roomTypes.length > 0) {
                allSelectedRooms.push(...advancedFilters.roomTypes);
            }
            
            if (allSelectedRooms.length > 0) {
                const match = allSelectedRooms.some(room => {
                    // ‚úÖ Support numeric values from filter checkboxes
                    const roomNum = parseInt(room);
                    
                    // Check if it's a valid numeric value
                    if (!isNaN(roomNum)) {
                        if (roomNum === 4) {
                            return property.rooms >= 4;  // 4+ –∫–æ–º–Ω–∞—Ç–Ω–∞—è
                        }
                        return property.rooms === roomNum;
                    }
                    
                    // ‚úÖ FALLBACK: Support old text formats for backward compatibility
                    const normalizedRoom = room.toLowerCase();
                    
                    if (normalizedRoom === '—Å—Ç—É–¥–∏—è' || normalizedRoom === 'studio') {
                        return property.rooms === 0;  // –°—Ç—É–¥–∏—è = 0 –∫–æ–º–Ω–∞—Ç
                    }
                    if (normalizedRoom === '1-–∫–æ–º–Ω' || normalizedRoom === '1-–∫–æ–º–Ω–∞—Ç–Ω–∞—è' || normalizedRoom === '1 –∫–æ–º–Ω–∞—Ç–Ω–∞—è') {
                        return property.rooms === 1;  // 1-–∫–æ–º–Ω–∞—Ç–Ω–∞—è
                    }
                    if (normalizedRoom === '2-–∫–æ–º–Ω' || normalizedRoom === '2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è' || normalizedRoom === '2 –∫–æ–º–Ω–∞—Ç–Ω–∞—è') {
                        return property.rooms === 2;  // 2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è
                    }
                    if (normalizedRoom === '3-–∫–æ–º–Ω' || normalizedRoom === '3-–∫–æ–º–Ω–∞—Ç–Ω–∞—è' || normalizedRoom === '3 –∫–æ–º–Ω–∞—Ç–Ω–∞—è') {
                        return property.rooms === 3;  // 3-–∫–æ–º–Ω–∞—Ç–Ω–∞—è
                    }
                    if (normalizedRoom === '4+-–∫–æ–º–Ω' || normalizedRoom === '4-–∫–æ–º–Ω–∞—Ç–Ω–∞—è' || normalizedRoom === '4 –∫–æ–º–Ω–∞—Ç–Ω–∞—è' || normalizedRoom.includes('4+')) {
                        return property.rooms >= 4;   // 4+ –∫–æ–º–Ω–∞—Ç–Ω–∞—è
                    }
                    return false;
                });
                if (!match) return false;
            }
            
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: PRICE FILTER (—Ü–µ–Ω–∞) - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –æ—Ç–ª–∞–¥–∫–∞ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
            if (priceFrom > 0 || priceTo > 0) {
                const priceInMillions = parseFloat(property.price) / 1000000;
                
                if (priceFrom > 0 && priceInMillions < priceFrom) {
                    return false;
                }
                if (priceTo > 0 && priceInMillions > priceTo) {
                    return false;
                }
            }
            
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: Completion date filter (—Ñ–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ —Å–¥–∞—á–∏)
            if (selectedCompletionDates.length > 0) {
                console.log(`Completion filter active:`, selectedCompletionDates);
                console.log(`Property completion_date: "${property.completion_date}"`);
                
                const match = selectedCompletionDates.some(date => {
                    // –°–¥–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
                    if (date === '–°–¥–∞–Ω') {
                        return property.completion_date === '–°–¥–∞–Ω' || 
                               property.status === 'ready' || 
                               property.completion_date === '–ì–æ—Ç–æ–≤' ||
                               property.completion_date === '–°–¥–∞–Ω–æ';
                    }
                    
                    // –ì–æ–¥—ã —Å–¥–∞—á–∏ (2024, 2025, 2026, 2028)
                    if (date.match(/^\d{4}$/)) {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ completion_date —Å–æ–¥–µ—Ä–∂–∏—Ç –≥–æ–¥
                        const hasYear = property.completion_date && property.completion_date.includes(date);
                        console.log(`Year ${date} check: "${property.completion_date}" includes "${date}"? ${hasYear}`);
                        return hasYear;
                    }
                    
                    // –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
                    return property.completion_date === date;
                });
                
                if (!match) {
                    console.log(`‚ùå Completion date filter: no match for "${property.completion_date}"`);
                    return false;
                }
                console.log(`‚úÖ Completion date filter: match found!`);
            }
            
            // ADVANCED FILTERS from "–ï—â–µ" section
            
            // Area filter (–ø–ª–æ—â–∞–¥—å)
            if (areaFrom > 0 || areaTo > 0) {
                const area = parseFloat(property.area || 0);
                if (areaFrom > 0 && area < areaFrom) return false;
                if (areaTo > 0 && area > areaTo) return false;
            }
            
            // Floor filter (—ç—Ç–∞–∂) - —Ñ–∏–ª—å—Ç—Ä –ø–æ —ç—Ç–∞–∂—É –ö–í–ê–†–¢–ò–†–´
            if (floorFrom > 0 || floorTo > 0) {
                const minFloor = parseInt(property.object_min_floor || property.floor || 0);
                const maxFloor = parseInt(property.object_max_floor || property.total_floors || minFloor);
                
                // –í–ê–ñ–ù–û: —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —ç—Ç–∞–∂—É –ö–í–ê–†–¢–ò–†–´, –Ω–µ –∑–¥–∞–Ω–∏—è
                // –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ "–¥–æ 3 —ç—Ç–∞–∂–∞" - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–≤–∞—Ä—Ç–∏—Ä—ã –Ω–∞ 1-3 —ç—Ç–∞–∂–∞—Ö
                if (floorFrom > 0 && minFloor < floorFrom) return false;
                if (floorTo > 0 && minFloor > floorTo) return false;
            }
            
            // Building floors filter (—ç—Ç–∞–∂–Ω–æ—Å—Ç—å –¥–æ–º–∞) - –ø–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —ç—Ç–∞–∂–Ω–æ—Å—Ç–∏ –∑–¥–∞–Ω–∏—è
            if (maxFloorFrom > 0 || maxFloorTo > 0) {
                const buildingMaxFloors = parseInt(property.object_max_floor || property.total_floors || 0);
                if (maxFloorFrom > 0 && buildingMaxFloors < maxFloorFrom) return false;
                if (maxFloorTo > 0 && buildingMaxFloors > maxFloorTo) return false;
            }
            
            // Building floors filter (—ç—Ç–∞–∂–Ω–æ—Å—Ç—å –¥–æ–º–∞) - –∏—Å–ø–æ–ª—å–∑—É–µ–º —á–∏—Å–ª–æ–≤—ã–µ –ø–æ–ª—è
            if (maxFloorFrom > 0 || maxFloorTo > 0) {
                const buildingFloors = parseInt(property.object_max_floor || property.total_floors || 0);
                if (maxFloorFrom > 0 && buildingFloors < maxFloorFrom) return false;
                if (maxFloorTo > 0 && buildingFloors > maxFloorTo) return false;
            }
            
            // Building status filter (—Å—Ç–∞—Ç—É—Å —Å–¥–∞–Ω–Ω–æ—Å—Ç–∏) - –ò–°–ü–†–ê–í–õ–ï–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–ª–µ
            if (selectedBuildingReleased.length > 0) {
                const match = selectedBuildingReleased.some(status => {
                    const buildingReleased = property.complex_building_released; // –ü–†–ê–í–ò–õ–¨–ù–û–ï –ü–û–õ–ï!
                    
                    if (status === 'true') {
                        // –°–¥–∞–Ω–Ω—ã–π –¥–æ–º - –ø—Ä–æ–≤–µ—Ä—è–µ–º complex_building_released = True
                        return buildingReleased === true || buildingReleased === 'True' || buildingReleased === 'true';
                    }
                    
                    if (status === 'false') {
                        // –í —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–µ - –ø—Ä–æ–≤–µ—Ä—è–µ–º complex_building_released = False
                        return buildingReleased === false || buildingReleased === 'False' || buildingReleased === 'false';
                    }
                    
                    return false;
                });
                if (!match) return false;
            }
            
            // Build year range filter (–¥–∏–∞–ø–∞–∑–æ–Ω –≥–æ–¥–∞ —Å–¥–∞—á–∏) - –ò–°–ü–†–ê–í–õ–ï–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–ª–µ
            const buildYearFrom = document.getElementById('buildYearFrom')?.value;
            const buildYearTo = document.getElementById('buildYearTo')?.value;
            if (buildYearFrom || buildYearTo) {
                const buildingYear = parseInt(property.complex_building_end_build_year || 0); // –ü–†–ê–í–ò–õ–¨–ù–û–ï –ü–û–õ–ï!
                
                if (buildYearFrom && buildingYear < parseInt(buildYearFrom)) return false;
                if (buildYearTo && buildingYear > parseInt(buildYearTo)) return false;
            }
            
            // Developer filter (–∑–∞—Å—Ç—Ä–æ–π—â–∏–∫) - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–ª–µ –∏–∑ Excel
            if (selectedDevelopers.length > 0) {
                const match = selectedDevelopers.some(developer => {
                    return property.developer_name === developer || 
                           property.developer === developer;
                });
                if (!match) return false;
            }
            
            // Complex filter (–∂–∏–ª–æ–π –∫–æ–º–ø–ª–µ–∫—Å) - –Ω–æ–≤—ã–π —Ñ–∏–ª—å—Ç—Ä –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ complex=
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∏–ª—å—Ç—Ä –∞–∫—Ç–∏–≤–µ–Ω –ò –Ω–µ null/–Ω–µ –ø—É—Å—Ç–æ–π
            if (activeFilters.residential_complex && activeFilters.residential_complex !== null && activeFilters.residential_complex !== '' && activeFilters.residential_complex !== 'null') {
                const complexName = activeFilters.residential_complex;
                
                // Debug: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –∏—â–µ–º –∏ —á—Ç–æ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º
                console.log(`üè† Complex filter: looking for "${complexName}"`);
                console.log(`üîç Property complex_name: "${property.complex_name}"`);
                
                // –ë–æ–ª–µ–µ –≥–∏–±–∫–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ - —É—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
                const match = property.complex_name === complexName || 
                             property.residential_complex === complexName ||
                             property.complex === complexName ||
                             // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–∞–≤—ã—á–µ–∫
                             (property.complex_name && property.complex_name.includes(complexName.replace(/"/g, ''))) ||
                             (complexName.includes(property.complex_name));
                             
                if (!match) {
                    console.log(`‚ùå Complex filter: "${complexName}" not found in "${property.complex_name}"`);
                    return false;
                }
                console.log(`‚úÖ Complex filter: match found!`);
            } else if (activeFilters.residential_complex === null || activeFilters.residential_complex === 'null') {
                // ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–≥–¥–∞ —Ñ–∏–ª—å—Ç—Ä —Å–±—Ä–æ—à–µ–Ω
                console.log('üîÑ Complex filter is NULL/cleared - showing all properties');
            }
            
            // District filter (—Ä–∞–π–æ–Ω)
            if (selectedDistricts.length > 0) {
                const match = selectedDistricts.some(district => {
                    return property.district === district || 
                           property.address_locality_name === district;
                });
                if (!match) return false;
            }
            
            // Region filter (—Ä–µ–≥–∏–æ–Ω)
            if (selectedRegions.length > 0) {
                const match = selectedRegions.some(region => {
                    return property.parsed_region === region || 
                           property.region_name === region || 
                           property.region === region;
                });
                if (!match) return false;
            }
            
            // City filter (–≥–æ—Ä–æ–¥) - –∏—â–µ–º –≤ –ø–æ–ª–Ω–æ–º –∞–¥—Ä–µ—Å–µ
            if (selectedCities.length > 0) {
                const match = selectedCities.some(city => {
                    const fullAddress = (property.address || property.address_display_name || '').toLowerCase();
                    return fullAddress.includes(city.toLowerCase());
                });
                if (!match) return false;
            }
            
            // Features filter (–æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏)
            if (selectedFeatures.length > 0) {
                // –°–ª–æ–≤–∞—Ä—å —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö –∏ —Ä—É—Å—Å–∫–∏—Ö –Ω–∞–∑–≤–∞–Ω–∏–π –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π
                const featureMapping = {
                    'accreditation': '–ê–∫–∫—Ä–µ–¥–∏—Ç–∞—Ü–∏—è',
                    'green_mortgage': '–ó–µ–ª–µ–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞',
                    'ready': '–°–¥–∞–Ω',
                    'under_construction': '–í —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–µ',
                    'no_finish': '–ë–µ–∑ –æ—Ç–¥–µ–ª–∫–∏',
                    'with_finish': '–° –æ—Ç–¥–µ–ª–∫–æ–π'
                };
                
                const match = selectedFeatures.some(feature => {
                    const russianFeature = featureMapping[feature] || feature;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ –ø–æ–ª—è —Å –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—è–º–∏
                    return (property.features && property.features.includes(russianFeature)) ||
                           (property.amenities && property.amenities.includes(russianFeature)) ||
                           (property.description && property.description.includes(russianFeature)) ||
                           // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è –∑–µ–ª–µ–Ω–æ–π –∏–ø–æ—Ç–µ–∫–∏
                           (feature === 'green_mortgage' && (property.has_green_mortgage || property.green_mortgage)) ||
                           // –ü—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è –∞–∫–∫—Ä–µ–¥–∏—Ç–∞—Ü–∏–∏
                           (feature === 'accreditation' && property.building_accreditation);
                });
                if (!match) return false;
            }
            
            // Renovation filter (–æ—Ç–¥–µ–ª–∫–∞)
            if (selectedRenovationTypes.length > 0) {
                const match = selectedRenovationTypes.some(renovationType => {
                    const propertyRenovation = property.renovation_display_name || property.renovation_type || property.renovation || '';
                    return propertyRenovation.toLowerCase().includes(renovationType.toLowerCase()) ||
                           propertyRenovation === renovationType;
                });
                if (!match) return false;
            }
            
            // Object class filter (–∫–ª–∞—Å—Å –∂–∏–ª—å—è)
            if (selectedObjectClasses.length > 0) {
                console.log('Object class filter active with:', selectedObjectClasses);
                const propertyClass = property.complex_object_class_display_name || property.object_class || property.property_class || property.class || '';
                console.log(`Property class field: "${propertyClass}" (property id: ${property.id})`);
                
                const match = selectedObjectClasses.some(objClass => {
                    const matches = propertyClass.toLowerCase().includes(objClass.toLowerCase()) || 
                                  propertyClass === objClass ||
                                  property.object_class === objClass || 
                                  property.property_class === objClass ||
                                  property.class === objClass;
                    return matches;
                });
                
                if (match) {
                    console.log(`‚úÖ Object class MATCH for property ${property.id}: "${propertyClass}"`);
                } else {
                    console.log(`‚ùå Object class NO MATCH for property ${property.id}: "${propertyClass}" vs [${selectedObjectClasses.join(', ')}]`);
                }
                
                if (!match) return false;
            }
            
            // Advanced filters integration
            // District filter (from advanced filters)
            if (advancedFilters.districts && advancedFilters.districts.length > 0) {
                const match = advancedFilters.districts.some(district => {
                    return property.district === district;
                });
                if (!match) return false;
            }
            
            // Developer filter (from advanced filters)
            if (advancedFilters.developers && advancedFilters.developers.length > 0) {
                const match = advancedFilters.developers.some(developer => {
                    return property.developer === developer;
                });
                if (!match) return false;
            }
            
            // Property type filter (from advanced filters)
            if (advancedFilters.propertyTypes && advancedFilters.propertyTypes.length > 0) {
                const match = advancedFilters.propertyTypes.some(type => {
                    return property.type === type || property.property_type === type;
                });
                if (!match) return false;
            }
            
            // Area filter (from advanced filters)
            if (advancedFilters.areas && advancedFilters.areas.length > 0) {
                const match = advancedFilters.areas.some(areaRange => {
                    const area = parseFloat(property.area);
                    if (areaRange === '30-50') return area >= 30 && area <= 50;
                    if (areaRange === '50-70') return area >= 50 && area <= 70;
                    if (areaRange === '70-100') return area >= 70 && area <= 100;
                    if (areaRange === '100+') return area > 100;
                    return false;
                });
                if (!match) return false;
            }
            
            // Area range filter (from advanced filters)
            if (advancedFilters.areaFrom > 0 || advancedFilters.areaTo > 0) {
                const area = parseFloat(property.area);
                if (advancedFilters.areaFrom > 0 && area < advancedFilters.areaFrom) return false;
                if (advancedFilters.areaTo > 0 && area > advancedFilters.areaTo) return false;
            }
            
            // Distance filter (from advanced filters)
            if (advancedFilters.distances && advancedFilters.distances.length > 0) {
                const match = advancedFilters.distances.some(distanceRange => {
                    // Mock distance calculation - in real app would be calculated from coordinates
                    const mockDistance = Math.random() * 20; // 0-20 km
                    if (distanceRange === '0-5') return mockDistance <= 5;
                    if (distanceRange === '5-10') return mockDistance > 5 && mockDistance <= 10;
                    if (distanceRange === '10-15') return mockDistance > 10 && mockDistance <= 15;
                    if (distanceRange === '15+') return mockDistance > 15;
                    return false;
                });
                if (!match) return false;
            }
            
            // Payment methods filter (from advanced filters)
            if (advancedFilters.payments && advancedFilters.payments.length > 0) {
                // Mock payment methods - in real app would check property payment options
                const match = advancedFilters.payments.some(payment => {
                    return true; // All properties support all payment methods for now
                });
                if (!match) return false;
            }
            
            // Direction filter (from advanced filters)
            if (advancedFilters.directions && advancedFilters.directions.length > 0) {
                // Mock direction - in real app would check property orientation
                const directions = ['—Å–µ–≤–µ—Ä', '—é–≥', '–≤–æ—Å—Ç–æ–∫', '–∑–∞–ø–∞–¥', '—é–≥–æ-–≤–æ—Å—Ç–æ–∫', '—é–≥–æ-–∑–∞–ø–∞–¥', '—Å–µ–≤–µ—Ä–æ-–≤–æ—Å—Ç–æ–∫', '—Å–µ–≤–µ—Ä–æ-–∑–∞–ø–∞–¥'];
                const propertyDirection = directions[property.id % directions.length];
                const match = advancedFilters.directions.includes(propertyDirection);
                if (!match) return false;
            }
            

            
            return true;
        });
        
        console.log(`üéØ FILTERING RESULT: ${filteredProperties.length} properties from ${allProperties.length} total`);
        
        // Store globally for other functions
        window.filteredProperties = filteredProperties;
        
        // ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –°–†–ê–ó–£ –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        console.log(`üîÑ Calling updateResultsCount with: ${filteredProperties.length}`);
        updateResultsCount(filteredProperties.length);
        
        // ‚úÖ –ù–ï –í–´–ó–´–í–ê–ï–ú updatePropertiesList –∑–¥–µ—Å—å - —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –Ω–∏–∂–µ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
        currentPage = 1; // Reset to first page when filtering
        
        // ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–ò –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü–∞–≥–∏–Ω–∞—Ü–∏—è - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¢–û–õ–¨–ö–û —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
        const totalPages = Math.ceil(filteredProperties.length / window.itemsPerPage);
        
        // –í–ê–ñ–ù–û: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–±—ä–µ–∫—Ç—ã —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        const startIndex = (currentPage - 1) * window.itemsPerPage;
        const endIndex = startIndex + window.itemsPerPage;
        const pageProperties = filteredProperties.slice(startIndex, endIndex);
        
        console.log(`üìÑ –ü–∞–≥–∏–Ω–∞—Ü–∏—è: —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage}/${totalPages}, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º ${pageProperties.length} –æ–±—ä–µ–∫—Ç–æ–≤ (${startIndex+1}-${Math.min(endIndex, filteredProperties.length)} –∏–∑ ${filteredProperties.length})`);
        
        // –ö–†–ò–¢–ò–ß–ù–û: –ü–µ—Ä–µ–¥–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–±—ä–µ–∫—Ç—ã —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –ù–ï –≤—Å–µ filtered
        updatePropertiesList(pageProperties);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±–æ–ª—å—à–µ 1 —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        if (totalPages > 1) {
            updatePaginationControls(filteredProperties.length, totalPages);
        } else {
            // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é –µ—Å–ª–∏ —Ç–æ–ª—å–∫–æ 1 —Å—Ç—Ä–∞–Ω–∏—Ü–∞
            const paginationContainer = document.getElementById('pagination-container');
            if (paginationContainer) paginationContainer.innerHTML = '';
        }
        
        // ‚úÖ –î–û–ë–ê–í–õ–ï–ù–û: Update active filters display
        displayActiveFilters();
        
        // Initialize buttons after filtering
        setTimeout(() => {
            initializeAllButtons();
            console.log('Buttons reinitialized after filtering');
        }, 50);
        
    } finally {
        window.isFiltering = false;
    }
}

// ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–ò –ò–°–ü–†–ê–í–õ–ï–ù–û: Update results counter - –ù–ê–•–û–î–ò–ú –õ–Æ–ë–û–ô H3 —Å "–ù–∞–π–¥–µ–Ω–æ"
function updateResultsCount(count) {
    // ‚úÖ SERVER-SIDE MODE: Use server's total count
    if (window.serverSidePagination && window.totalProperties !== undefined) {
        count = window.totalProperties;
        console.log(`üåê Using server-side count: ${count}`);
    } else {
        console.log(`üîÑ updateResultsCount called with count: ${count}`);
    }
    
    // üî• –ù–û–í–û–ï: –¢—Ä–µ–∫–∞–µ–º –ø–æ–∏—Å–∫ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    if (window.currentSearchQuery) {
        console.log(`üìä Tracking search: "${window.currentSearchQuery}" with ${count} results`);
        saveToSearchHistory(window.currentSearchQuery, count);
        // –û—á–∏—â–∞–µ–º –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        window.currentSearchQuery = null;
    }
    
    // –§—É–Ω–∫—Ü–∏—è —Å–∫–ª–æ–Ω–µ–Ω–∏—è —Å–ª–æ–≤–∞ "–æ–±—ä–µ–∫—Ç"  
    function getObjectWord(count) {
        if (count % 100 >= 11 && count % 100 <= 14) return "–æ–±—ä–µ–∫—Ç–æ–≤";
        switch (count % 10) {
            case 1: return "–æ–±—ä–µ–∫—Ç";
            case 2: case 3: case 4: return "–æ–±—ä–µ–∫—Ç–∞";
            default: return "–æ–±—ä–µ–∫—Ç–æ–≤";
        }
    }
    
    // –°–¢–†–ê–¢–ï–ì–ò–Ø 1: –ò—â–µ–º –ª—é–±–æ–π H3 –∫–æ—Ç–æ—Ä—ã–π —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç "–ù–∞–π–¥–µ–Ω–æ"
    const h3Elements = document.querySelectorAll('h3');
    let targetH3 = null;
    
    for (let h3 of h3Elements) {
        if (h3.textContent && h3.textContent.includes('–ù–∞–π–¥–µ–Ω–æ')) {
            targetH3 = h3;
            break;
        }
    }
    
    if (targetH3) {
        // –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ H3
        targetH3.innerHTML = `–ù–∞–π–¥–µ–Ω–æ <span id="results-count">${count}</span> ${getObjectWord(count)}`;
        console.log(`‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω H3 —Å "–ù–∞–π–¥–µ–Ω–æ": ${count} ${getObjectWord(count)}`);
        return;
    }
    
    // –°–¢–†–ê–¢–ï–ì–ò–Ø 2: –ï—Å–ª–∏ H3 –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—â–µ–º span results-count
    const resultsCount = document.getElementById('results-count');
    if (resultsCount) {
        resultsCount.textContent = count;
        console.log(`‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω span results-count: ${count}`);
        return;
    }
    
    // –°–¢–†–ê–¢–ï–ì–ò–Ø 3: –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç
    console.error(`‚ùå –ù–ï –ù–ê–ô–î–ï–ù —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞! –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π...`);
    
    // –ò—â–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    const resultsSection = document.querySelector('.bg-white.rounded-xl.shadow-sm.border.border-gray-200.p-4');
    if (resultsSection) {
        const newH3 = document.createElement('h3');
        newH3.className = 'text-xl font-bold text-gray-900';
        newH3.innerHTML = `–ù–∞–π–¥–µ–Ω–æ <span id="results-count">${count}</span> ${getObjectWord(count)}`;
        resultsSection.insertBefore(newH3, resultsSection.firstChild);
        console.log(`‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π H3: ${count} ${getObjectWord(count)}`);
        return;
    }
    
    console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç —Å—á–µ—Ç—á–∏–∫–∞!');
}

// –û–¢–ö–õ–Æ–ß–ï–ù–û: JavaScript –ø–∞–≥–∏–Ω–∞—Ü–∏—è (—Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–Ω–∞—è –ø–∞–≥–∏–Ω–∞—Ü–∏—è)
function updatePaginationControls(totalItems, totalPages) {
    // –ü—É—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è - JavaScript –ø–∞–≥–∏–Ω–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–Ω–∞—è
    console.log('‚ö†Ô∏è JavaScript pagination disabled - using server-side pagination');
    return;
}

// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: Go to specific page - –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–∞–≥–∏–Ω–∞—Ü–∏—è
function goToPage(page) {
    const dataToUse = window.filteredProperties && window.filteredProperties.length > 0 ? window.filteredProperties : allProperties;
    const totalPages = Math.ceil(dataToUse.length / window.itemsPerPage);
    
    if (page < 1 || page > totalPages) {
        console.log(`‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: ${page}, –¥–æ—Å—Ç—É–ø–Ω–æ: 1-${totalPages}`);
        return;
    }
    
    console.log(`üìÑ –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É ${page} –∏–∑ ${totalPages}`);
    
    currentPage = page;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–±—ä–µ–∫—Ç—ã —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    const startIndex = (currentPage - 1) * window.itemsPerPage;
    const endIndex = startIndex + window.itemsPerPage;
    const pageProperties = dataToUse.slice(startIndex, endIndex);
    
    console.log(`üìÑ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ä–µ–∫—Ç—ã ${startIndex+1}-${Math.min(endIndex, dataToUse.length)} –∏–∑ ${dataToUse.length}`);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å –æ–±—ä–µ–∫—Ç–∞–º–∏ –¢–û–õ–¨–ö–û —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    updatePropertiesList(pageProperties);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    updatePaginationControls(dataToUse.length, totalPages);
    
    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –Ω–∞—á–∞–ª—É —Å–ø–∏—Å–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤
    const propertiesContainer = document.getElementById('properties-container');
    if (propertiesContainer) {
        propertiesContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

// Advanced Filters Functions
// advancedFilters already declared above

function applyAdvancedFilters() {
    console.log('Applying advanced filters...');
    
    // Collect all advanced filter values
    advancedFilters.districts = Array.from(document.querySelectorAll('input[data-filter="district"]:checked')).map(cb => cb.value);
    advancedFilters.developers = Array.from(document.querySelectorAll('input[data-filter="developer"]:checked')).map(cb => cb.value);
    advancedFilters.propertyTypes = Array.from(document.querySelectorAll('input[data-filter="propertyType"]:checked')).map(cb => cb.value);
    advancedFilters.roomTypes = Array.from(document.querySelectorAll('#advancedFiltersSection input[data-filter="rooms"]:checked')).map(cb => cb.value);
    
    // Update the quick filters to match advanced filters
    if (advancedFilters.districts.length > 0) {
        // Update district dropdown if exists
        const districtSelect = document.querySelector('select[name="district"]');
        if (districtSelect) {
            districtSelect.value = advancedFilters.districts[0];
        }
    }
    
    // Apply the unified filter logic
    filterProperties();
    
    // Update results count in advanced filters
    updateAdvancedFiltersResultsCount();
    
    // Hide advanced filters panel
    toggleAdvancedFilters();
}

function clearAllAdvancedFilters() {
    console.log('Clearing all advanced filters...');
    
    // Clear all checkboxes in advanced filters
    document.querySelectorAll('#advancedFiltersSection input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    
    // Reset advanced filters object
    advancedFilters = {
        districts: [],
        developers: [],
        propertyTypes: [],
        priceMin: 0,
        priceMax: 0,
        roomTypes: [],
        distances: [],
        areas: [],
        directions: [],
        payments: [],
        areaFrom: 0,
        areaTo: 0
    };
    
    // Clear main filter checkboxes too
    document.querySelectorAll('input[data-filter-type="rooms"]:checked').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Update results display
    filterProperties();
    
    // Update results count in advanced filters
    updateAdvancedFiltersResultsCount();
}

function updateAdvancedFiltersResultsCount() {
    const resultCountElement = document.getElementById('advancedResultsCount');
    if (resultCountElement) {
        const count = filteredProperties.length || allProperties.length;
        resultCountElement.textContent = `${count} –∫–≤–∞—Ä—Ç–∏—Ä –Ω–∞–π–¥–µ–Ω–æ`;
    }
}

// Save current filters function
function saveCurrentFilters() {
    console.log('Saving current filters state...');
    toggleAdvancedFilters(); // Just close the panel for now
}

// Initialize advanced filters dropdowns
function initializeAdvancedFilters() {
    // Handle dropdown toggle for advanced filters
    document.querySelectorAll('#advancedFiltersSection .filter-option-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const dropdown = this.closest('.filter-dropdown');
            if (!dropdown) return;
            
            const menu = dropdown.querySelector('.dropdown-menu');
            if (!menu) return;
            
            // Close other dropdowns
            document.querySelectorAll('#advancedFiltersSection .dropdown-menu').forEach(otherMenu => {
                if (otherMenu !== menu) {
                    otherMenu.classList.add('hidden');
                }
            });
            
            // Toggle current dropdown
            menu.classList.toggle('hidden');
            console.log('Advanced dropdown toggled');
        });
    });
    
    // Handle checkbox changes in advanced filters - AJAX MODE
    document.querySelectorAll('#advancedFiltersSection input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            console.log('‚úÖ Advanced filter checkbox changed (AJAX MODE):', this.value, this.checked);
            
            // ‚úÖ –ù–û–í–û–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º AJAX —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –≤–º–µ—Å—Ç–æ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π
            if (typeof window.applyFilters === 'function') {
                window.applyFilters();
            } else {
                console.warn('‚ö†Ô∏è window.applyFilters not available yet, using fallback');
            }
            
            // Update active filters display
            if (typeof window.displayActiveFilters === 'function') {
                window.displayActiveFilters();
            }
            
            // Real-time update of filter count
            updateAdvancedFiltersResultsCount();
            
            // Initialize buttons after filtering
            setTimeout(() => {
                initializeAllButtons();
                console.log('Buttons reinitialized after advanced filtering');
            }, 50);
        });
    });
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#advancedFiltersSection .filter-dropdown')) {
            document.querySelectorAll('#advancedFiltersSection .dropdown-menu').forEach(menu => {
                menu.classList.add('hidden');
            });
        }
    });
}

// Display active filters

// Remove individual filter
function removeFilter(type, value) {
    if (type === 'rooms') {
        const checkbox = document.querySelector(`input[data-filter-type="rooms"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
        handleRoomFilterChange();
    } else if (type === 'price') {
        document.getElementById('priceFrom').value = '';
        document.getElementById('priceTo').value = '';
        document.getElementById('priceFilterText').textContent = '–¶–µ–Ω–∞ –æ—Ç-–¥–æ, ‚ÇΩ';
    } else if (type === 'completion') {
        const checkbox = document.querySelector(`input[data-filter-type="completion"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'distance') {
        const checkbox = document.querySelector(`input[data-filter="distance"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'area') {
        const checkbox = document.querySelector(`input[data-filter="area"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'areaRange') {
        const areaFrom = document.getElementById('areaFrom');
        const areaTo = document.getElementById('areaTo');
        if (areaFrom) areaFrom.value = '';
        if (areaTo) areaTo.value = '';
    } else if (type === 'direction') {
        const checkbox = document.querySelector(`input[data-filter="direction"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'payment') {
        const checkbox = document.querySelector(`input[data-filter="payment"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'district') {
        const checkbox = document.querySelector(`input[data-filter="district"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'developer') {
        const checkbox = document.querySelector(`input[data-filter="developer"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'propertyType') {
        const checkbox = document.querySelector(`input[data-filter="propertyType"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'advancedRooms') {
        const checkbox = document.querySelector(`#advancedFiltersSection input[data-filter="rooms"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'propertyClass') {
        const checkbox = document.querySelector(`input[data-filter="property_class"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'wallMaterial') {
        const checkbox = document.querySelector(`input[data-filter="wall_material"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'floorsTotal') {
        const checkbox = document.querySelector(`input[data-filter="floors_total"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'propertyType2') {
        const checkbox = document.querySelector(`input[data-filter="property_type"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'salesStart') {
        const checkbox = document.querySelector(`input[data-filter="sales_start"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'parking') {
        const checkbox = document.querySelector(`input[data-filter="parking"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'elevator') {
        const checkbox = document.querySelector(`input[data-filter="elevator"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'registration') {
        const checkbox = document.querySelector(`input[data-filter="registration"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'nearbyPlaces') {
        const checkbox = document.querySelector(`input[data-filter="nearby_places"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'windowView') {
        const checkbox = document.querySelector(`input[data-filter="window_view"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'specialApartments') {
        const checkbox = document.querySelector(`input[data-filter="special_apartments"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'dropdownDeveloper') {
        const dropdown = document.getElementById('developer-filter');
        if (dropdown) dropdown.value = '';
    } else if (type === 'dropdownDistrict') {
        const dropdown = document.getElementById('district-filter');
        if (dropdown) dropdown.value = '';
    } else if (type === 'worldSides') {
        const checkbox = document.querySelector(`input[data-filter="world_sides"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
    } else if (type === 'region') {
        const checkbox = document.querySelector(`input[data-filter-type="region"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
        handleRegionFilterChange();
    } else if (type === 'city') {
        const checkbox = document.querySelector(`input[data-filter-type="city"][value="${value}"]`);
        if (checkbox) checkbox.checked = false;
        handleCityFilterChange();
    }
    
    // Update advanced filters object (excluding duplicates from quick filters)
    advancedFilters.developers = Array.from(document.querySelectorAll('input[data-filter="developer"]:checked')).map(cb => cb.value);
    advancedFilters.propertyTypes = Array.from(document.querySelectorAll('input[data-filter="propertyType"]:checked')).map(cb => cb.value);
    advancedFilters.distances = Array.from(document.querySelectorAll('input[data-filter="distance"]:checked')).map(cb => cb.value);
    advancedFilters.areas = Array.from(document.querySelectorAll('input[data-filter="area"]:checked')).map(cb => cb.value);
    advancedFilters.directions = Array.from(document.querySelectorAll('input[data-filter="direction"]:checked')).map(cb => cb.value);
    
    // New advanced filters - add to activeFilters too
    advancedFilters.propertyClass = Array.from(document.querySelectorAll('input[data-filter="property_class"]:checked')).map(cb => cb.value);
    advancedFilters.wallMaterial = Array.from(document.querySelectorAll('input[data-filter="wall_material"]:checked')).map(cb => cb.value);
    advancedFilters.floorsTotal = Array.from(document.querySelectorAll('input[data-filter="floors_total"]:checked')).map(cb => cb.value);
    advancedFilters.propertyType = Array.from(document.querySelectorAll('input[data-filter="property_type"]:checked')).map(cb => cb.value);
    advancedFilters.salesStart = Array.from(document.querySelectorAll('input[data-filter="sales_start"]:checked')).map(cb => cb.value);
    advancedFilters.parking = Array.from(document.querySelectorAll('input[data-filter="parking"]:checked')).map(cb => cb.value);
    advancedFilters.elevator = Array.from(document.querySelectorAll('input[data-filter="elevator"]:checked')).map(cb => cb.value);
    advancedFilters.registration = Array.from(document.querySelectorAll('input[data-filter="registration"]:checked')).map(cb => cb.value);
    advancedFilters.nearbyPlaces = Array.from(document.querySelectorAll('input[data-filter="nearby_places"]:checked')).map(cb => cb.value);
    advancedFilters.windowView = Array.from(document.querySelectorAll('input[data-filter="window_view"]:checked')).map(cb => cb.value);
    advancedFilters.specialApartments = Array.from(document.querySelectorAll('input[data-filter="special_apartments"]:checked')).map(cb => cb.value);
    advancedFilters.worldSides = Array.from(document.querySelectorAll('input[data-filter="world_sides"]:checked')).map(cb => cb.value);
    
    // Update activeFilters with all new advanced filters
    activeFilters.propertyClass = advancedFilters.propertyClass;
    activeFilters.wallMaterial = advancedFilters.wallMaterial;
    activeFilters.floorsTotal = advancedFilters.floorsTotal;
    activeFilters.propertyType = advancedFilters.propertyType;
    activeFilters.salesStart = advancedFilters.salesStart;
    activeFilters.parking = advancedFilters.parking;
    activeFilters.elevator = advancedFilters.elevator;
    activeFilters.registration = advancedFilters.registration;
    activeFilters.nearbyPlaces = advancedFilters.nearbyPlaces;
    activeFilters.windowView = advancedFilters.windowView;
    activeFilters.specialApartments = advancedFilters.specialApartments;
    activeFilters.worldSides = advancedFilters.worldSides;
    advancedFilters.payments = Array.from(document.querySelectorAll('input[data-filter="payment"]:checked')).map(cb => cb.value);
    
    // Update area range
    const areaFromValue = document.getElementById('areaFrom')?.value;
    const areaToValue = document.getElementById('areaTo')?.value;
    advancedFilters.areaFrom = parseFloat(areaFromValue) || 0;
    advancedFilters.areaTo = parseFloat(areaToValue) || 0;
    
    filterProperties();
    displayActiveFilters();
}

// View switching functions
function switchToListView() {
    document.getElementById('listViewBtn').classList.add('bg-[#0088CC]', 'text-white');
    document.getElementById('gridViewBtn').classList.remove('bg-[#0088CC]', 'text-white');
    
    const container = document.getElementById('propertiesList');
    if (container) {
        container.className = 'space-y-6';
        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
        const dataToUse = window.filteredProperties && window.filteredProperties.length > 0 ? window.filteredProperties : allProperties;
        
        const startIndex = (currentPage - 1) * window.itemsPerPage;
        const pageProperties = dataToUse.slice(startIndex, startIndex + window.itemsPerPage);
        updatePropertiesList(pageProperties);
    }
}

function switchToGridView() {
    document.getElementById('gridViewBtn').classList.add('bg-[#0088CC]', 'text-white');
    document.getElementById('listViewBtn').classList.remove('bg-[#0088CC]', 'text-white');
    
    const container = document.getElementById('propertiesList');
    if (container) {
        container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
        const dataToUse = window.filteredProperties && window.filteredProperties.length > 0 ? window.filteredProperties : allProperties;
        
        const startIndex = (currentPage - 1) * window.itemsPerPage;
        const pageProperties = dataToUse.slice(startIndex, startIndex + window.itemsPerPage);
        updatePropertiesList(pageProperties);
    }
}

function switchToMapView() {
    alert('–ö–∞—Ä—Ç–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
}

// ‚úÖ –£–î–ê–õ–ï–ù–ê: –í—Ç–æ—Ä–∞—è –¥—É–±–ª–∏—Ä—É—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è

// Initialize everything on page load
document.addEventListener('DOMContentLoaded', function() {
    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –í—ã–∑—ã–≤–∞–µ–º –º–æ—é –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
    initializeClearAllButton();
    initializeAdvancedFilters();
    initializeDropdownFilters();
    
    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ carousel
    if (typeof window.initializeImageCarousels === 'function') {
        window.initializeImageCarousels();
    }
    
    // Add event listeners for main filter dropdowns to show active filters
    const developerFilter = document.getElementById('developer-filter');
    if (developerFilter) {
        developerFilter.addEventListener('change', function() {
            filterProperties();
            displayActiveFilters();
        });
    }
    
    const districtFilter = document.getElementById('district-filter');
    if (districtFilter) {
        districtFilter.addEventListener('change', function() {
            filterProperties();
            displayActiveFilters();
        });
    }
    
    // Initialize NEW filter dropdowns (registration, nearby places, etc.)
    const filterDropdowns = document.querySelectorAll('.filter-dropdown');
    console.log('Found filter dropdowns:', filterDropdowns.length, filterDropdowns);
    filterDropdowns.forEach(dropdown => {
        const btn = dropdown.querySelector('.dropdown-btn');
        const menu = dropdown.querySelector('.dropdown-menu');
        const arrow = dropdown.querySelector('.dropdown-arrow');
        
        if (btn && menu) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Close other filter dropdowns
                filterDropdowns.forEach(otherDropdown => {
                    if (otherDropdown !== dropdown) {
                        const otherMenu = otherDropdown.querySelector('.dropdown-menu');
                        const otherArrow = otherDropdown.querySelector('.dropdown-arrow');
                        if (otherMenu) {
                            otherMenu.classList.remove('open');
                            otherMenu.classList.add('hidden');
                        }
                        if (otherArrow) otherArrow.style.transform = 'rotate(0deg)';
                    }
                });
                
                // Toggle current dropdown
                const isOpen = menu.classList.contains('open');
                if (isOpen) {
                    menu.classList.remove('open');
                    menu.classList.add('hidden');
                    if (arrow) arrow.style.transform = 'rotate(0deg)';
                } else {
                    menu.classList.add('open');
                    menu.classList.remove('hidden');
                    if (arrow) arrow.style.transform = 'rotate(180deg)';
                }
                
                console.log('Filter dropdown toggled:', dropdown);
                
                // Show dropdown options when opened  
                if (!isOpen) {
                    console.log('Dropdown opened');
                    // Determine filter type from existing checkboxes or button text
                    let filterType = menu.querySelector('input[data-filter]')?.getAttribute('data-filter');
                    
                    if (!filterType) {
                        // If no existing checkboxes, determine from button text
                        const buttonText = btn.textContent.trim();
                        if (buttonText.includes('–ü—Ä–æ–ø–∏—Å–∫–∞')) filterType = 'registration';
                        else if (buttonText.includes('–ú–µ—Å—Ç–∞ —Ä—è–¥–æ–º')) filterType = 'nearby_places';
                        else if (buttonText.includes('–í–∏–¥ –∏–∑ –æ–∫–æ–Ω')) filterType = 'window_view';
                        else if (buttonText.includes('–í–∏–¥–æ–≤—ã–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã')) filterType = 'special_apartments';
                        else if (buttonText.includes('–°—Ç–æ—Ä–æ–Ω—ã —Å–≤–µ—Ç–∞')) filterType = 'world_sides';
                    }
                    
                    if (filterType) {
                        console.log('Filter type detected:', filterType);
                        showDropdownOptions(menu, filterType);
                    }
                } else {
                    console.log('Dropdown closed');
                }
            });
        }
    });
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.filter-dropdown')) {
            filterDropdowns.forEach(dropdown => {
                const menu = dropdown.querySelector('.dropdown-menu');
                const arrow = dropdown.querySelector('.dropdown-arrow');
                if (menu) {
                    menu.classList.remove('open');
                    menu.classList.add('hidden');
                }
                if (arrow) arrow.style.transform = 'rotate(0deg)';
            });
        }
    });
    
    // Initialize favorite and comparison buttons
    setTimeout(() => {
        initializeAllButtons();
        // Initialize ComparisonManager (loads from database for managers)
        if (window.ComparisonManager && window.ComparisonManager.init) {
            window.ComparisonManager.init();
        }
        // Favorites counter now handled by FavoritesManager
        console.log('Initial page setup complete with favorites and comparison');
    }, 100);
    
    // Initialize view mode to list by default
    const container = document.getElementById('properties-container');
    if (container && !container.getAttribute('data-view-mode')) {
        container.setAttribute('data-view-mode', 'list');
    }
    
    console.log('Dropdown filters initialized, including', filterDropdowns.length, 'new filter dropdowns');
    
    // Function to show dropdown options for new filters
    function showDropdownOptions(menu, filterType) {
        console.log('Showing options for filter:', filterType);
        const existingOptions = menu.querySelectorAll('input[type="checkbox"]');
        
        // If options already exist, don't duplicate
        if (existingOptions.length > 0) {
            console.log('Options already exist for', filterType);
            return;
        }
        
        let options = [];
        
        // Define options for each filter type
        switch(filterType) {
            case 'registration':
                options = ['–í–æ–∑–º–æ–∂–Ω–∞', '–ù–µ–≤–æ–∑–º–æ–∂–Ω–∞', '–í—Ä–µ–º–µ–Ω–Ω–∞—è'];
                break;
            case 'nearby_places':
                options = ['–®–∫–æ–ª–∞', '–î–µ—Ç—Å–∫–∏–π —Å–∞–¥', '–ë–æ–ª—å–Ω–∏—Ü–∞', '–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç', '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç', '–ü–∞—Ä–∫'];
                break;
            case 'window_view':
                options = ['–ù–∞ –¥–≤–æ—Ä', '–ù–∞ —É–ª–∏—Ü—É', '–ù–∞ –º–æ—Ä–µ', '–ù–∞ –≥–æ—Ä—ã'];
                break;
            case 'special_apartments':
                options = ['–£–≥–ª–æ–≤–∞—è', '–ü–µ–Ω—Ç—Ö–∞—É—Å', '–î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è', '–° —Ç–µ—Ä—Ä–∞—Å–æ–π'];
                break;
            case 'world_sides':
                options = ['–°–µ–≤–µ—Ä', '–Æ–≥', '–í–æ—Å—Ç–æ–∫', '–ó–∞–ø–∞–¥'];
                break;
            default:
                console.log('Unknown filter type:', filterType);
                return;
        }
        
        // Create container for options if it doesn't exist
        let container = menu.querySelector('.p-3.space-y-2');
        if (!container) {
            container = document.createElement('div');
            container.className = 'p-3 space-y-2';
            menu.appendChild(container);
        }
        
        // Clear existing content
        container.innerHTML = '';
        
        // Add options
        options.forEach(option => {
            const label = document.createElement('label');
            label.className = 'flex items-center text-sm hover:bg-gray-50 p-1 rounded cursor-pointer';
            label.innerHTML = `
                <input type="checkbox" class="mr-2 text-[#0088CC]" data-filter="${filterType}" value="${option}" onchange="updateAdvancedFilters()"> ${option}
            `;
            container.appendChild(label);
        });
        
        console.log('Added', options.length, 'options for', filterType);
    }
});

// Check if a specific filter has active values
function checkIfFilterIsActive(dropdown) {
    const filterType = dropdown.getAttribute('data-filter');
    
    switch(filterType) {
        case 'rooms':
            // Check if any room checkboxes are checked
            return dropdown.querySelectorAll('input[type="checkbox"]:checked').length > 0;
            
        case 'price':
            // Check if price inputs have values
            const priceFrom = dropdown.querySelector('#priceFrom');
            const priceTo = dropdown.querySelector('#priceTo');
            return (priceFrom && priceFrom.value) || (priceTo && priceTo.value);
            
        case 'completion':
            // Check if any completion checkboxes are checked
            return dropdown.querySelectorAll('input[type="checkbox"]:checked').length > 0;
            
        default:
            // Generic check for any input with value
            const inputs = dropdown.querySelectorAll('input');
            return Array.from(inputs).some(input => {
                if (input.type === 'checkbox') return input.checked;
                if (input.type === 'text' || input.type === 'number') return input.value;
                return false;
            });
    }
}

// Clear specific filter values via double-click (add separate function)
function clearFilterByDoubleClick(button) {
    const dropdown = button.closest('.filter-dropdown') || button.closest('.dropdown');
    if (!dropdown) return;
    
    const filterType = dropdown.getAttribute('data-filter');
    
    switch(filterType) {
        case 'rooms':
            // Uncheck all room checkboxes
            dropdown.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => cb.checked = false);
            button.textContent = '–¢–∏–ø –∫–≤–∞—Ä—Ç–∏—Ä—ã';
            break;
            
        case 'price':
            // Clear price inputs
            const priceFrom = dropdown.querySelector('#priceFrom');
            const priceTo = dropdown.querySelector('#priceTo');
            if (priceFrom) priceFrom.value = '';
            if (priceTo) priceTo.value = '';
            button.textContent = '–¶–µ–Ω–∞ –æ—Ç-–¥–æ, ‚ÇΩ';
            break;
            
        case 'completion':
            // Uncheck all completion checkboxes
            dropdown.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => cb.checked = false);
            button.textContent = '–°—Ä–æ–∫ —Å–¥–∞—á–∏';
            break;
    }
    
    // Reapply filters after clearing
    filterProperties();
    console.log('Filter cleared by double-click:', filterType);
}

// Clear specific filter values
function clearSpecificFilter(dropdown) {
    const filterType = dropdown.getAttribute('data-filter');
    
    switch(filterType) {
        case 'rooms':
            // Uncheck all room checkboxes
            dropdown.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => cb.checked = false);
            // Update button text
            const roomsBtn = dropdown.querySelector('.filter-option-btn, .dropdown-btn');
            if (roomsBtn) roomsBtn.textContent = '–¢–∏–ø –∫–≤–∞—Ä—Ç–∏—Ä—ã';
            break;
            
        case 'price':
            // Clear price inputs
            const priceFrom = dropdown.querySelector('#priceFrom');
            const priceTo = dropdown.querySelector('#priceTo');
            if (priceFrom) priceFrom.value = '';
            if (priceTo) priceTo.value = '';
            // Update button text
            const priceBtn = dropdown.querySelector('.filter-option-btn, .dropdown-btn');
            if (priceBtn) priceBtn.textContent = '–¶–µ–Ω–∞ –æ—Ç-–¥–æ, ‚ÇΩ';
            break;
            
        case 'completion':
            // Uncheck all completion checkboxes
            dropdown.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => cb.checked = false);
            // Update button text
            const completionBtn = dropdown.querySelector('.filter-option-btn, .dropdown-btn');
            if (completionBtn) completionBtn.textContent = '–°—Ä–æ–∫ —Å–¥–∞—á–∏';
            break;
            
        default:
            // Generic clear for all inputs
            dropdown.querySelectorAll('input').forEach(input => {
                if (input.type === 'checkbox') input.checked = false;
                else input.value = '';
            });
            break;
    }
    
    // Reapply filters after clearing
    filterProperties();
}

// Legacy function for backward compatibility 
function initializeFavoriteButtons() {
    initializeAllButtons();
}

// handleFavoriteClick function removed - now handled by FavoritesManager

// Initialize comparison and recommendation buttons only
function initializeAllButtons() {
    // Favorites are now handled by FavoritesManager class
    
    // Clear previous initialization for comparison and recommendation buttons
    document.querySelectorAll('.compare-btn').forEach(btn => {
        if (btn.hasAttribute('data-compare-initialized')) {
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.removeAttribute('data-compare-initialized');
        }
    });
    document.querySelectorAll('.recommend-btn').forEach(btn => {
        if (btn.hasAttribute('data-recommend-initialized')) {
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.removeAttribute('data-recommend-initialized');
        }
    });
    
    // Favorite buttons are now initialized by FavoritesManager
    // Removed duplicate initialization to prevent conflicts
    
    // Initialize comparison buttons with NEW unified system
    document.querySelectorAll('.compare-btn').forEach(btn => {
        const propertyId = parseInt(btn.getAttribute('data-property-id'));
        
        // Update button state using new system
        if (window.ComparisonManager) {
            window.ComparisonManager.updateButton(propertyId);
        }
        
        // Add event listener if not already added
        if (!btn.hasAttribute('data-compare-initialized')) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                addToCompare(propertyId);
            });
            btn.setAttribute('data-compare-initialized', 'true');
        }
    });
    
    // Initialize recommendation buttons for managers using the new function
    if (window.manager_authenticated) {
        initializeRecommendButtons();
    }
    
    // Clean up old comparison systems and initialize new one
    localStorage.removeItem('propertyComparison'); // Remove old system
    localStorage.removeItem('complexComparison'); // Remove old system
    
    // Initialize comparison counter on page load
    if (window.ComparisonManager) {
        window.ComparisonManager.updateCounters();
    }
    
    console.log('Initialized buttons for', document.querySelectorAll('.property-card').length, 'properties');
}

// Legacy function for backward compatibility
function initializeComparisonButtons() {
    initializeAllButtons();
}

// Legacy toggleFavorite function - now delegates to FavoritesManager
function toggleFavorite(propertyId) {
    if (window.favoritesManager) {
        const heartElement = document.querySelector(`.favorite-heart[data-property-id="${propertyId}"]`);
        window.favoritesManager.toggleFavorite(propertyId, heartElement);
    } else {
        console.error('FavoritesManager not initialized');
    }
}

// NEW UNIFIED COMPARISON SYSTEM
window.ComparisonManager = {
    initialized: false,
    
    // Initialize - load from database for managers
    init: async function() {
        if (this.initialized) return;
        this.initialized = true;
        
        const isManager = Boolean(window.manager_authenticated);
        if (isManager) {
            console.log('üîç Manager detected - loading comparison from database...');
            await this.loadFromDatabase();
        }
        this.updateCounters();
        this.updateAllButtons();
    },
    
    // Load comparison data from PostgreSQL (managers only)
    loadFromDatabase: async function() {
        const isManager = Boolean(window.manager_authenticated);
        if (!isManager) return;
        
        try {
            const response = await fetch('/api/manager/comparison/load');
            if (response.ok) {
                const result = await response.json();
                console.log('üì¶ Database comparison data:', result);
                
                if (result.success) {
                    const data = {
                        properties: result.properties || [],
                        complexes: result.complexes || []
                    };
                    localStorage.setItem('comparison-data', JSON.stringify(data));
                    console.log('‚úÖ Loaded from database:', data);
                    this.updateCounters();
                    this.updateAllButtons();
                }
            }
        } catch (error) {
            console.error('‚ùå Error loading comparison from database:', error);
        }
    },
    
    // Sync to database (managers only)
    syncToDatabase: async function(action, type, id) {
        const isManager = Boolean(window.manager_authenticated);
        if (!isManager) return;
        
        try {
            const endpoint = `/api/manager/comparison/${type}/${action}`;
            const body = type === 'property' ? { property_id: id } : { complex_id: id };
            
            console.log(`üì° Syncing to database: ${action} ${type} ${id}`);
            
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            
            const result = await response.json();
            if (result.success) {
                console.log(`‚úÖ Synced to database: ${action} ${type} ${id}`);
            }
        } catch (error) {
            console.error('‚ùå Error syncing to database:', error);
        }
    },
    
    // Get current comparison data
    getData: function() {
        return JSON.parse(localStorage.getItem('comparison-data') || '{"properties": [], "complexes": []}');
    },
    
    // Save comparison data
    saveData: function(data) {
        localStorage.setItem('comparison-data', JSON.stringify(data));
        this.updateCounters();
    },
    
    // Add property to comparison
    addProperty: async function(propertyId) {
        const data = this.getData();
        const idStr = propertyId.toString();
        
        if (!data.properties.includes(idStr)) {
            if (data.properties.length >= 4) {
                this.showMessage('–ú–æ–∂–Ω–æ —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å –º–∞–∫—Å–∏–º—É–º 4 –∫–≤–∞—Ä—Ç–∏—Ä—ã', 'warning');
                return false;
            }
            data.properties.push(idStr);
            this.saveData(data);
            this.showMessage('–ö–≤–∞—Ä—Ç–∏—Ä–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ', 'success');
            console.log('Property added to comparison:', propertyId);
            
            // Sync to database for managers
            await this.syncToDatabase('add', 'property', propertyId);
            
            return true;
        }
        return false;
    },
    
    // Remove property from comparison
    removeProperty: async function(propertyId) {
        const data = this.getData();
        const idStr = propertyId.toString();
        
        if (data.properties.includes(idStr)) {
            data.properties = data.properties.filter(id => id !== idStr);
            this.saveData(data);
            this.showMessage('–ö–≤–∞—Ä—Ç–∏—Ä–∞ —É–¥–∞–ª–µ–Ω–∞ –∏–∑ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è', 'info');
            console.log('Property removed from comparison:', propertyId);
            
            // Sync to database for managers
            await this.syncToDatabase('remove', 'property', propertyId);
            
            return true;
        }
        return false;
    },
    
    // Check if property is in comparison
    hasProperty: function(propertyId) {
        const data = this.getData();
        return data.properties.includes(propertyId.toString());
    },
    
    // Update all counters
    updateCounters: function() {
        const data = this.getData();
        const totalCount = data.properties.length + data.complexes.length;
        
        // Update global comparison counter in header
        const globalCounter = document.getElementById('comparison-count');
        if (globalCounter) {
            globalCounter.textContent = totalCount;
            globalCounter.style.display = totalCount > 0 ? 'flex' : 'none';
        }
        
        // Update dashboard counters if available
        const propertiesCount = document.getElementById('properties-tab-count');
        if (propertiesCount) {
            propertiesCount.textContent = data.properties.length;
        }
        
        const complexesCount = document.getElementById('complexes-tab-count');
        if (complexesCount) {
            complexesCount.textContent = data.complexes.length;
        }
    },
    
    // Show notification message
    showMessage: function(message, type = 'info') {
        if (typeof showNotification === 'function') {
            showNotification(message, type);
        } else {
            console.log(`[${type}] ${message}`);
        }
    },
    
    // Update button state
    updateButton: function(propertyId) {
        const button = document.querySelector(`[data-property-id="${propertyId}"] .compare-btn, .compare-btn[data-property-id="${propertyId}"]`);
        if (!button) return;
        
        const isInComparison = this.hasProperty(propertyId);
        
        if (isInComparison) {
            button.classList.add('added', 'bg-blue-600', 'text-white');
            button.classList.remove('border-gray-300', 'hover:bg-gray-50', 'text-gray-700');
            button.innerHTML = '<i class="fas fa-check text-xs"></i>';
            button.title = '–£–±—Ä–∞—Ç—å –∏–∑ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è';
        } else {
            button.classList.remove('added', 'bg-blue-600', 'text-white');
            button.classList.add('border-gray-300', 'hover:bg-gray-50', 'text-gray-700');
            button.innerHTML = '<i class="fas fa-balance-scale text-xs text-gray-600"></i>';
            button.title = '–î–æ–±–∞–≤–∏—Ç—å –∫ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é';
        }
    },
    
    // Update all comparison buttons on the page
    updateAllButtons: function() {
        const data = this.getData();
        document.querySelectorAll('.compare-btn[data-property-id]').forEach(btn => {
            const propertyId = btn.dataset.propertyId;
            if (propertyId) {
                this.updateButton(propertyId);
            }
        });
        console.log('üîÑ Updated all comparison buttons');
    }
};

// Main comparison function
function addToCompare(propertyId) {
    // Prevent rapid clicks
    const button = document.querySelector(`[data-property-id="${propertyId}"] .compare-btn, .compare-btn[data-property-id="${propertyId}"]`);
    if (button && button.disabled) return;
    
    // Temporarily disable button
    if (button) {
        button.disabled = true;
        setTimeout(() => button.disabled = false, 500);
    }
    
    // Toggle comparison state
    if (window.ComparisonManager.hasProperty(propertyId)) {
        window.ComparisonManager.removeProperty(propertyId);
    } else {
        window.ComparisonManager.addProperty(propertyId);
    }
    
    // Update button appearance
    window.ComparisonManager.updateButton(propertyId);
}

// View Mode Toggle Functions
function switchToListView() {
    const container = document.getElementById('properties-container');
    const listBtn = document.querySelector('[data-view="list"]');
    const gridBtn = document.querySelector('[data-view="grid"]');
    
    if (!container || !listBtn || !gridBtn) {
        console.warn('View switching elements not found - list view toggle may not be available');
        return;
    }
    
    // Update container view mode
    container.setAttribute('data-view-mode', 'list');
    
    // Update button styles
    listBtn.className = 'flex items-center gap-1 px-3 py-2 rounded-md text-sm transition-all bg-white shadow-sm text-[#0088CC]';
    gridBtn.className = 'flex items-center gap-1 px-3 py-2 rounded-md text-sm transition-all text-gray-600 hover:text-gray-800';
    
    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: Re-render properties with list view - —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
    const dataToUse = filteredProperties.length > 0 ? filteredProperties : allProperties;
    
    const startIndex = (currentPage - 1) * window.itemsPerPage;
    const pageProperties = dataToUse.slice(startIndex, startIndex + window.itemsPerPage);
    updatePropertiesList(pageProperties);
    console.log('Switched to list view');
}

function switchToGridView() {
    const container = document.getElementById('properties-container');
    const listBtn = document.querySelector('[data-view="list"]');
    const gridBtn = document.querySelector('[data-view="grid"]');
    
    if (!container || !listBtn || !gridBtn) {
        console.warn('View switching elements not found - grid view toggle may not be available');
        return;
    }
    
    // Update container view mode
    container.setAttribute('data-view-mode', 'grid');
    
    // Update button styles
    gridBtn.className = 'flex items-center gap-1 px-3 py-2 rounded-md text-sm transition-all bg-white shadow-sm text-[#0088CC]';
    listBtn.className = 'flex items-center gap-1 px-3 py-2 rounded-md text-sm transition-all text-gray-600 hover:text-gray-800';
    
    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: Re-render properties with grid view - —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞  
    const dataToUse = filteredProperties.length > 0 ? filteredProperties : allProperties;
    
    const startIndex = (currentPage - 1) * window.itemsPerPage;
    const pageProperties = dataToUse.slice(startIndex, startIndex + window.itemsPerPage);
    updatePropertiesList(pageProperties);
    console.log('Switched to grid view');
}

</script>

<!-- Favorites system is loaded globally in base.html to prevent duplicates -->

<!-- Presentation Functions - Versioned for cache busting -->
<script src="{{ url_for('static', filename='js/presentation.js') }}?v={{ range(1000, 9999) | random }}"></script>
{% endblock %}

{% block extra_js %}
<!-- ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –î–û –∑–∞–≥—Ä—É–∑–∫–∏ property-filters.js -->
<script>
// Server-side pagination flags - MUST be set before property-filters.js loads
window.serverSidePagination = true;
window.totalProperties = {{ total_properties|default(0) }};
window.totalPages = {{ total_pages|default(1) }};
window.currentServerPage = {{ page|default(1) }};

// ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º currentCityId –î–û –∑–∞–≥—Ä—É–∑–∫–∏ property-filters.js
// –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–¥—Å—á–µ—Ç–∞ –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –∫–Ω–æ–ø–∫–µ "–ù–∞–π—Ç–∏"
window.currentCityId = {{ current_city.id if current_city else 1 }};
console.log('üèôÔ∏è Current city ID:', window.currentCityId);

// Developers mapping: ID ‚Üí Name (–¥–ª—è displayActiveFilters)
// –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–∫–æ–≤—ã–µ –∫–ª—é—á–∏, —Ç.–∫. URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤—Å–µ–≥–¥–∞ —Å—Ç—Ä–æ–∫–∏
// NOTE: This is refreshed by loadDevelopers() AJAX call when city changes
window.developersMap = {
    {% if developers %}
    {% for developer in developers %}
    "{{ developer.id }}": "{{ developer.name|replace('"', '\\"') }}"{% if not loop.last %},{% endif %}
    {% endfor %}
    {% endif %}
};

console.log('‚úÖ Filter variables initialized (before property-filters.js):', {
    serverSidePagination: window.serverSidePagination,
    totalProperties: window.totalProperties,
    totalPages: window.totalPages,
    page: window.currentServerPage,
    currentCityId: window.currentCityId,
    developersCount: Object.keys(window.developersMap).length
});

// ‚úÖ View mode switching with localStorage persistence
// Initialize from localStorage or default to 'list'
window.currentViewMode = localStorage.getItem('propertiesViewMode') || 'list';

function switchToListView() {
    window.currentViewMode = 'list';
    localStorage.setItem('propertiesViewMode', 'list');
    const container = document.getElementById('properties-container');
    const listBtn = document.getElementById('list-view-btn');
    const gridBtn = document.getElementById('grid-view-btn');
    
    if (!container) {
        console.error('‚ùå Container #properties-container not found');
        return;
    }
    
    // Update container classes - LIST MODE
    container.className = 'space-y-6 w-full';
    
    // Update all cards to horizontal layout (flex)
    const cards = container.querySelectorAll('.property-card');
    cards.forEach(card => {
        card.className = 'property-card bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden w-full flex cursor-pointer min-h-[280px]';
        
        // Make image section fixed width - find by carousel container
        const imageSection = card.querySelector('.carousel-container')?.parentElement;
        if (imageSection) {
            imageSection.className = 'relative w-80 h-60 flex-shrink-0 group';
        }
        
        // Content section flex-1 - find by searching for child elements
        const contentSection = card.querySelector('h2')?.closest('div');
        if (contentSection) {
            contentSection.className = 'flex-1 p-6 flex flex-col';
        }
    });
    
    // Update button states
    if (listBtn) {
        listBtn.className = 'flex items-center gap-1 px-3 py-2 rounded-md text-sm font-medium transition-colors bg-white text-gray-900 shadow-sm';
    }
    if (gridBtn) {
        gridBtn.className = 'flex items-center gap-1 px-3 py-2 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-900';
    }
    
    console.log('‚úÖ Switched to list view');
}

function switchToGridView() {
    window.currentViewMode = 'grid';
    localStorage.setItem('propertiesViewMode', 'grid');
    const container = document.getElementById('properties-container');
    const listBtn = document.getElementById('list-view-btn');
    const gridBtn = document.getElementById('grid-view-btn');
    
    if (!container) {
        console.error('‚ùå Container #properties-container not found');
        return;
    }
    
    // Update container classes - GRID MODE
    container.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 w-full';
    
    // Update all cards to vertical layout (flex-col)
    const cards = container.querySelectorAll('.property-card');
    cards.forEach(card => {
        card.className = 'property-card bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden w-full flex flex-col cursor-pointer';
        
        // Make image section full width - find by carousel container
        const imageSection = card.querySelector('.carousel-container')?.parentElement;
        if (imageSection) {
            imageSection.className = 'relative w-full h-48 flex-shrink-0 group';
        }
        
        // Content section normal padding - find by h2
        const contentSection = card.querySelector('h2')?.closest('div');
        if (contentSection) {
            contentSection.className = 'p-4 flex flex-col flex-1';
        }
    });
    
    // Update button states
    if (gridBtn) {
        gridBtn.className = 'flex items-center gap-1 px-3 py-2 rounded-md text-sm font-medium transition-colors bg-white text-gray-900 shadow-sm';
    }
    if (listBtn) {
        listBtn.className = 'flex items-center gap-1 px-3 py-2 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-900';
    }
    
    console.log('‚úÖ Switched to grid view');
}

// Make functions globally accessible
window.switchToListView = switchToListView;
window.switchToGridView = switchToGridView;

console.log('‚úÖ View switching functions loaded');

// Initialize view on page load from localStorage or default
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîß Initializing properties page view...');
    console.log('üìã Current view mode:', window.currentViewMode);
    
    // Apply saved view mode or default to list
    if (window.currentViewMode === 'grid') {
        switchToGridView();
    } else {
        switchToListView();
    }
});
</script>
<!-- ‚úÖ CACHE BUSTER -->
<script>console.log('üî• –ù–û–í–ê–Ø –í–ï–†–°–ò–Ø HTML –ó–ê–ì–†–£–ñ–ï–ù–ê - v1761859100');</script>
<!-- ‚úÖ MOBILE SEARCH REDIRECT: Smart room query detection (MUST LOAD FIRST) -->
<script src="{{ url_for('static', filename='js/mobile-search-redirect.js') }}?v=1761859100"></script>
<!-- ‚úÖ –ü–†–ò–û–†–ò–¢–ï–¢–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê: –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –¥–æ–ª–∂–Ω–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è –ü–ï–†–í–û–ô -->
<script src="{{ url_for('static', filename='js/properties-sorting.js') }}?v=1761507235"></script>
<!-- ‚úÖ AJAX LIST UPDATER: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ -->
<script src="{{ url_for('static', filename='js/properties-list-updater.js') }}?v=1761509300"></script>
<!-- ‚úÖ INFINITE SCROLL: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–¥–≥—Ä—É–∑–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤ -->
<script src="{{ url_for('static', filename='js/infinite-scroll.js') }}?v=1761507444"></script>

<script src="{{ url_for('static', filename='js/property-filters.js') }}?v={{ range(1000, 9999) | random }}"></script>
<script src="{{ url_for('static', filename='js/expandable-search.js') }}"></script>
<script src="{{ url_for('static', filename='js/smart_autocomplete.js') }}"></script>
<script src="{{ url_for('static', filename='js/favorites.js') }}"></script>
<script src="{{ url_for('static', filename='js/properties-comparison-fix.js') }}"></script>
<script src="{{ url_for('static', filename='js/properties_mini_map.js') }}"></script>
<script src="{{ url_for('static', filename='js/saved_searches.js') }}?v=1761577011"></script>
<script src="{{ url_for('static', filename='js/property-card-click.js') }}"></script>
<script>
// Initialize SmartAutocomplete for properties search
document.addEventListener('DOMContentLoaded', function() {
    if (typeof SmartAutocomplete !== 'undefined') {
        initializePropertiesSmartSearch();
        console.log('‚úÖ SmartAutocomplete initialized for properties page');
    }
});

// Initialize SavedSearchesManager after the script is loaded
document.addEventListener('DOMContentLoaded', function() {
    if (typeof SavedSearchesManager !== 'undefined') {
        window.savedSearchesManager = new SavedSearchesManager();
        console.log('‚úÖ SavedSearchesManager initialized');
    }
});

// ====================================
// LIVE FILTER COUNT UPDATE HANDLERS
// ====================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('üîß Initializing live filter count update handlers...');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    if (typeof window.updateFilteredCount === 'function') {
        setTimeout(() => window.updateFilteredCount(), 500);
    }
    
    // ===== –ß–ï–ö–ë–û–ö–°–´ –§–ò–õ–¨–¢–†–û–í =====
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—Å–µ—Ö —á–µ–∫–±–æ–∫—Å–æ–≤ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    const filterCheckboxes = document.querySelectorAll(
        'input[data-filter-type="rooms"], ' +
        'input[data-filter-type="developer"], ' +
        'input[data-filter-type="district"], ' +
        'input[data-filter-type="completion"], ' +
        'input[data-filter-type="object_class"], ' +
        'input[data-filter-type="renovation"], ' +
        'input[data-filter-type="floor_options"], ' +
        'input[data-filter-type="features"], ' +
        'input[data-filter-type="building_released"]'
    );
    
    filterCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            console.log('‚úÖ Filter checkbox changed:', this.getAttribute('data-filter-type'));
            if (typeof window.updateFilteredCount === 'function') {
                window.updateFilteredCount();
            }
        });
    });
    
    console.log(`‚úÖ Added listeners to ${filterCheckboxes.length} filter checkboxes`);
    
    // ===== –ò–ù–ü–£–¢–´ –§–ò–õ–¨–¢–†–û–í =====
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö/—á–∏—Å–ª–æ–≤—ã—Ö –∏–Ω–ø—É—Ç–æ–≤
    const filterInputs = document.querySelectorAll(
        '#priceFrom, #priceTo, #priceFromModal, #priceToModal, ' +
        '#areaFrom, #areaTo, ' +
        '#floorFrom, #floorTo, ' +
        '#maxFloorFrom, #maxFloorTo, ' +
        '#buildYearFrom, #buildYearTo'
    );
    
    filterInputs.forEach(input => {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º 'input' event –¥–ª—è —Ä–µ–∞–ª—Ç–∞–π–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –≤–≤–æ–¥–µ
        input.addEventListener('input', function() {
            console.log('‚úÖ Filter input changed:', this.id);
            if (typeof window.updateFilteredCount === 'function') {
                window.updateFilteredCount();
            }
        });
    });
    
    console.log(`‚úÖ Added listeners to ${filterInputs.length} filter inputs`);
    
    // ===== –ö–ù–û–ü–ö–ê "–ü–û–ö–ê–ó–ê–¢–¨" –í –†–ê–°–®–ò–†–ï–ù–ù–´–• –§–ò–õ–¨–¢–†–ê–• =====
    
    // –£–±–µ–¥–∏–º—Å—è —á—Ç–æ –∫–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–∞–Ω–µ–ª—å –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
    const applyAdvancedButton = document.getElementById('applyAdvancedFilters');
    if (applyAdvancedButton) {
        applyAdvancedButton.addEventListener('click', function() {
            console.log('‚úÖ Apply advanced filters button clicked');
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
            if (typeof window.applyFilters === 'function') {
                window.applyFilters();
            }
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
            const panel = document.getElementById('advancedFiltersPanel');
            if (panel) {
                panel.classList.add('hidden');
                // –£–±–∏—Ä–∞–µ–º –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º –Ω–∞ –º–æ–±–∞–π–ª–µ
                if (window.innerWidth <= 640) {
                    panel.classList.remove('mobile-fullscreen');
                    document.body.style.overflow = '';
                }
                console.log('‚úÖ Advanced filters panel closed');
            }
        });
        console.log('‚úÖ Apply advanced filters button handler registered');
    }
    
    console.log('‚úÖ Live filter count update initialized');
});

// ====================================
// DROPDOWN MANAGEMENT (Avito/Cian-style)
// ====================================

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è dropdown'–∞–º–∏ - –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ –∫—Ä–æ–º–µ —Ç–µ–∫—É—â–µ–≥–æ
function toggleDropdown(event, currentDropdown) {
    event.stopPropagation();
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –¥—Ä—É–≥–∏–µ dropdown'—ã
    document.querySelectorAll('.dropdown-menu.open').forEach(menu => {
        // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ç–µ–∫—É—â–∏–π dropdown - –∑–∞–∫—Ä—ã–≤–∞–µ–º
        if (menu !== currentDropdown) {
            menu.classList.remove('open');
        }
    });
    
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ç–µ–∫—É—â–∏–π dropdown
    if (currentDropdown) {
        currentDropdown.classList.toggle('open');
    }
}

// ====================================
// MOBILE BOTTOM SHEET PANEL HANDLERS
// ====================================

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–∞–Ω–µ–ª–∏ –ö–æ–º–Ω–∞—Ç –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º
function toggleRoomsPanel(event) {
    const isMobile = window.innerWidth < 640;
    
    if (isMobile) {
        // –ù–∞ –º–æ–±–∏–ª—å–Ω–æ–º –æ—Ç–∫—Ä—ã–≤–∞–µ–º bottom sheet –ø–∞–Ω–µ–ª—å
        event.preventDefault();
        event.stopPropagation();
        
        const panel = document.getElementById('roomsFilterPanel');
        if (panel) {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º dropdown –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç
            const dropdown = event.currentTarget.parentElement.querySelector('.dropdown-menu');
            if (dropdown) {
                dropdown.classList.remove('open');
            }
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
            panel.classList.remove('hidden');
            
            // –î–æ–±–∞–≤–ª—è–µ–º mobile-fullscreen –∫–ª–∞—Å—Å
            if (isMobile) {
                panel.classList.add('mobile-fullscreen');
                document.body.style.overflow = 'hidden';
            }
            
            console.log('‚úÖ Rooms panel opened on mobile');
        }
    }
    // –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π dropdown (–Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º)
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–∞–Ω–µ–ª–∏ –¶–µ–Ω—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º
function togglePricePanel(event) {
    const isMobile = window.innerWidth < 640;
    
    if (isMobile) {
        // –ù–∞ –º–æ–±–∏–ª—å–Ω–æ–º –æ—Ç–∫—Ä—ã–≤–∞–µ–º bottom sheet –ø–∞–Ω–µ–ª—å
        event.preventDefault();
        event.stopPropagation();
        
        const panel = document.getElementById('priceFilterPanel');
        if (panel) {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º dropdown –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç
            const dropdown = event.currentTarget.parentElement.querySelector('.dropdown-menu');
            if (dropdown) {
                dropdown.classList.remove('open');
            }
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
            panel.classList.remove('hidden');
            
            // –î–æ–±–∞–≤–ª—è–µ–º mobile-fullscreen –∫–ª–∞—Å—Å
            if (isMobile) {
                panel.classList.add('mobile-fullscreen');
                document.body.style.overflow = 'hidden';
            }
            
            console.log('‚úÖ Price panel opened on mobile');
        }
    }
    // –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π dropdown (–Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º)
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º (Avito-style)
function openMobileFilters() {
    console.log('üîß openMobileFilters() called');
    
    const panel = document.getElementById('advancedFiltersPanel');
    if (panel) {
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
        panel.classList.remove('hidden');
        
        // –ù–∞ –º–æ–±–∞–π–ª–µ –¥–µ–ª–∞–µ–º fullscreen
        const isMobile = window.innerWidth < 640;
        if (isMobile) {
            panel.classList.add('mobile-fullscreen');
            document.body.style.overflow = 'hidden';
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
        if (typeof window.updateFilteredCount === 'function') {
            window.updateFilteredCount();
        }
        
        console.log('‚úÖ Advanced filters panel opened on mobile');
    } else {
        console.warn('‚ö†Ô∏è advancedFiltersPanel not found');
    }
}

// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –∏ –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
// –¢–µ–ø–µ—Ä—å property-search –≤ –º–æ–±–∏–ª—å–Ω–æ–º sticky bar, property-search-desktop –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ
document.addEventListener('DOMContentLoaded', function() {
    const mobileSearch = document.getElementById('property-search'); // –í mobile sticky bar
    const desktopSearch = document.getElementById('property-search-desktop'); // –í desktop section
    
    if (mobileSearch && desktopSearch) {
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –≤–≤–æ–¥–µ –≤ –º–æ–±–∏–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ (—Ç–µ–ø–µ—Ä—å —ç—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π property-search)
        mobileSearch.addEventListener('input', function() {
            desktopSearch.value = this.value;
        });
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –≤–≤–æ–¥–µ –≤ –¥–µ—Å–∫—Ç–æ–ø–Ω—ã–π –ø–æ–∏—Å–∫
        desktopSearch.addEventListener('input', function() {
            mobileSearch.value = this.value;
            // Trigger autocomplete on mobile search too
            if (typeof SmartAutocomplete !== 'undefined' && mobileSearch.dispatchEvent) {
                mobileSearch.dispatchEvent(new Event('input', { bubbles: true }));
            }
        });
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Enter –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º
        mobileSearch.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (typeof window.applyFilters === 'function') {
                    window.applyFilters();
                }
            }
        });
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Enter –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–º
        desktopSearch.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (typeof window.applyFilters === 'function') {
                    window.applyFilters();
                }
            }
        });
        
        console.log('‚úÖ Mobile (property-search) and desktop (property-search-desktop) search synchronized');
    }
});

console.log('‚úÖ Mobile bottom sheet handlers initialized');

// Handle card clicks for navigation while preserving button functionality
function handleCardClick(event, url) {
    // Check if click was on a button or interactive element
    const target = event.target;
    const isButton = target.tagName === 'BUTTON' || target.closest('button');
    const isLink = target.tagName === 'A' || target.closest('a');
    const isInteractive = target.closest('.favorite-heart') || target.closest('.comparison-btn');
    
    // If click was on interactive element, don't navigate
    if (isButton || isLink || isInteractive) {
        console.log('‚è∏Ô∏è handleCardClick: Ignoring click on interactive element');
        return;
    }
    
    // Navigate to property detail page
    console.log('üîó handleCardClick: Navigating to:', url);
    window.location.href = url;
}
</script>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–ë–ï–ó –¢–ê–ë–û–í - –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π layout) -->
<div id="filters-modal" class="hidden fixed inset-0 z-[9999] overflow-y-auto">
    <!-- Overlay -->
    <div class="fixed inset-0 bg-gray-900 bg-opacity-50 transition-opacity" onclick="closeFiltersModal()"></div>
    
    <!-- Modal Container -->
    <div class="relative min-h-screen flex items-start justify-center p-0 md:p-4">
        <div class="relative bg-white w-full md:max-w-2xl md:my-8 md:rounded-2xl shadow-xl flex flex-col" style="max-height: 100vh;">
            
            <!-- Sticky Header -->
            <div class="sticky top-0 bg-white z-10 px-4 md:px-6 py-4 border-b border-gray-200 md:rounded-t-2xl">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-900">–§–∏–ª—å—Ç—Ä—ã</h2>
                    <div class="flex items-center gap-3">
                        <button onclick="if(typeof window.resetModalFilters === 'function') window.resetModalFilters();" class="text-[#0088CC] hover:text-[#006699] font-medium text-sm transition-colors">
                            –°–±—Ä–æ—Å–∏—Ç—å
                        </button>
                        <button onclick="closeFiltersModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Scrollable Content - –í–°–ï —Ñ–∏–ª—å—Ç—Ä—ã –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ -->
            <div class="flex-1 overflow-y-auto p-4 md:p-6" id="filters-modal-content">
                <div class="space-y-8">
                    
                    <!-- ========== –°–ï–ö–¶–ò–Ø: –ö–í–ê–†–¢–ò–†–ê ========== -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-900 pb-2 border-b-2 border-[#0088CC]">–ö–≤–∞—Ä—Ç–∏—Ä–∞</h3>
                        
                        <!-- –ü–ª–æ—â–∞–¥—å -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">–ü–ª–æ—â–∞–¥—å, –º¬≤</label>
                            <div class="flex gap-2">
                                <input type="number" id="areaFromModal" placeholder="–æ—Ç" class="flex-1 px-3 py-2 border border-[#D1D5DB] rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent">
                                <input type="number" id="areaToModal" placeholder="–¥–æ" class="flex-1 px-3 py-2 border border-[#D1D5DB] rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent">
                            </div>
                        </div>
                        
                        <!-- –≠—Ç–∞–∂ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">–≠—Ç–∞–∂</label>
                            <div class="flex gap-2 mb-2">
                                <input type="number" id="floorFromModal" placeholder="–æ—Ç" class="flex-1 px-3 py-2 border border-[#D1D5DB] rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent">
                                <input type="number" id="floorToModal" placeholder="–¥–æ" class="flex-1 px-3 py-2 border border-[#D1D5DB] rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent">
                            </div>
                            <div class="flex flex-wrap gap-2">
                                <label class="flex items-center px-3 py-1.5 bg-[#F3F4F6] hover:bg-[#E5E7EB] rounded-lg cursor-pointer transition-colors text-sm">
                                    <input type="checkbox" value="not_first" data-filter-type="floor_options" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded mr-2" onchange="updateModalFilterCount();">
                                    <span class="text-[#111827]">–ù–µ –ø–µ—Ä–≤—ã–π</span>
                                </label>
                                <label class="flex items-center px-3 py-1.5 bg-[#F3F4F6] hover:bg-[#E5E7EB] rounded-lg cursor-pointer transition-colors text-sm">
                                    <input type="checkbox" value="not_last" data-filter-type="floor_options" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded mr-2" onchange="updateModalFilterCount();">
                                    <span class="text-[#111827]">–ù–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π</span>
                                </label>
                                <label class="flex items-center px-3 py-1.5 bg-[#F3F4F6] hover:bg-[#E5E7EB] rounded-lg cursor-pointer transition-colors text-sm">
                                    <input type="checkbox" value="last" data-filter-type="floor_options" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded mr-2" onchange="updateModalFilterCount();">
                                    <span class="text-[#111827]">–ü–æ—Å–ª–µ–¥–Ω–∏–π</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- –û—Ç–¥–µ–ª–∫–∞ (—Å–µ—Ä—ã–µ –∫–Ω–æ–ø–∫–∏) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">–û—Ç–¥–µ–ª–∫–∞</label>
                            <div class="flex flex-wrap gap-2">
                                <label class="flex items-center px-3 py-1.5 bg-[#F3F4F6] hover:bg-[#E5E7EB] rounded-lg cursor-pointer transition-colors text-sm">
                                    <input type="checkbox" value="no_renovation" data-filter-type="renovation" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded mr-2" onchange="updateModalFilterCount();">
                                    <span class="text-[#111827]">–ë–µ–∑ –æ—Ç–¥–µ–ª–∫–∏</span>
                                </label>
                                <label class="flex items-center px-3 py-1.5 bg-[#F3F4F6] hover:bg-[#E5E7EB] rounded-lg cursor-pointer transition-colors text-sm">
                                    <input type="checkbox" value="fine_finish" data-filter-type="renovation" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded mr-2" onchange="updateModalFilterCount();">
                                    <span class="text-[#111827]">–ß–∏—Å—Ç–æ–≤–∞—è</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- –ü—Ä–æ–≥—Ä–∞–º–º—ã –∏ —Å–∫–∏–¥–∫–∏ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">–°–∫–∏–¥–∫–∏ –∏ –∞–∫—Ü–∏–∏</label>
                            <div class="space-y-2">
                                <label class="flex items-center px-3 py-2 hover:bg-gray-50 rounded-lg cursor-pointer transition-colors">
                                    <input type="checkbox" value="accreditation" data-filter-type="features" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded mr-2" onchange="updateModalFilterCount();">
                                    <span class="text-sm text-gray-700">–ê–∫–∫—Ä–µ–¥–∏—Ç–∞—Ü–∏—è –±–∞–Ω–∫–æ–≤</span>
                                </label>
                                <label class="flex items-center px-3 py-2 hover:bg-gray-50 rounded-lg cursor-pointer transition-colors">
                                    <input type="checkbox" value="green_mortgage" data-filter-type="features" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded mr-2" onchange="updateModalFilterCount();">
                                    <span class="text-sm text-gray-700">–õ—å–≥–æ—Ç–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    
                    <!-- ========== –°–ï–ö–¶–ò–Ø: –î–û–ú ========== -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-900 pb-2 border-b-2 border-[#0088CC]">–î–æ–º</h3>
                        
                        <!-- –°—Ä–æ–∫ —Å–¥–∞—á–∏ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">–°—Ä–æ–∫ —Å–¥–∞—á–∏</label>
                            <div class="flex flex-wrap gap-2">
                                <label class="flex items-center px-3 py-1.5 bg-[#F3F4F6] hover:bg-[#E5E7EB] rounded-lg cursor-pointer transition-colors text-sm">
                                    <input type="checkbox" value="2024" data-filter-type="completion" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded mr-2" onchange="updateModalFilterCount();">
                                    <span class="text-[#111827]">2024</span>
                                </label>
                                <label class="flex items-center px-3 py-1.5 bg-[#F3F4F6] hover:bg-[#E5E7EB] rounded-lg cursor-pointer transition-colors text-sm">
                                    <input type="checkbox" value="2025" data-filter-type="completion" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded mr-2" onchange="updateModalFilterCount();">
                                    <span class="text-[#111827]">2025</span>
                                </label>
                                <label class="flex items-center px-3 py-1.5 bg-[#F3F4F6] hover:bg-[#E5E7EB] rounded-lg cursor-pointer transition-colors text-sm">
                                    <input type="checkbox" value="2026" data-filter-type="completion" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded mr-2" onchange="updateModalFilterCount();">
                                    <span class="text-[#111827]">2026</span>
                                </label>
                                <label class="flex items-center px-3 py-1.5 bg-[#F3F4F6] hover:bg-[#E5E7EB] rounded-lg cursor-pointer transition-colors text-sm">
                                    <input type="checkbox" value="2028" data-filter-type="completion" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded mr-2" onchange="updateModalFilterCount();">
                                    <span class="text-[#111827]">2028</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- –°—Ç–∞—Ç—É—Å —Å–¥–∞—á–∏ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">–°—Ç–∞—Ç—É—Å</label>
                            <div class="flex flex-wrap gap-2">
                                <label class="flex items-center px-3 py-1.5 bg-[#F3F4F6] hover:bg-[#E5E7EB] rounded-lg cursor-pointer transition-colors text-sm">
                                    <input type="checkbox" value="true" data-filter-type="building_released" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded mr-2" onchange="updateModalFilterCount();">
                                    <span class="text-[#111827]">–°–¥–∞–Ω–Ω—ã–π –¥–æ–º</span>
                                </label>
                                <label class="flex items-center px-3 py-1.5 bg-[#F3F4F6] hover:bg-[#E5E7EB] rounded-lg cursor-pointer transition-colors text-sm">
                                    <input type="checkbox" value="false" data-filter-type="building_released" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded mr-2" onchange="updateModalFilterCount();">
                                    <span class="text-[#111827]">–í —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–µ</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- –≠—Ç–∞–∂–Ω–æ—Å—Ç—å –¥–æ–º–∞ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">–≠—Ç–∞–∂–Ω–æ—Å—Ç—å –¥–æ–º–∞</label>
                            <div class="flex gap-2">
                                <input type="number" id="maxFloorFromModal" placeholder="–æ—Ç" class="flex-1 px-3 py-2 border border-[#D1D5DB] rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent">
                                <input type="number" id="maxFloorToModal" placeholder="–¥–æ" class="flex-1 px-3 py-2 border border-[#D1D5DB] rounded-lg text-sm focus:ring-2 focus:ring-[#0088CC] focus:border-transparent">
                            </div>
                        </div>
                        
                        <!-- –ö–ª–∞—Å—Å –∂–∏–ª—å—è -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">–ö–ª–∞—Å—Å –∂–∏–ª—å—è</label>
                            <div class="flex flex-wrap gap-2">
                                <label class="flex items-center px-3 py-1.5 bg-[#F3F4F6] hover:bg-[#E5E7EB] rounded-lg cursor-pointer transition-colors text-sm">
                                    <input type="checkbox" value="–ö–æ–º—Ñ–æ—Ä—Ç" data-filter-type="object_class" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded mr-2" onchange="updateModalFilterCount();">
                                    <span class="text-[#111827]">–ö–æ–º—Ñ–æ—Ä—Ç</span>
                                </label>
                                <label class="flex items-center px-3 py-1.5 bg-[#F3F4F6] hover:bg-[#E5E7EB] rounded-lg cursor-pointer transition-colors text-sm">
                                    <input type="checkbox" value="–ë–∏–∑–Ω–µ—Å" data-filter-type="object_class" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded mr-2" onchange="updateModalFilterCount();">
                                    <span class="text-[#111827]">–ë–∏–∑–Ω–µ—Å</span>
                                </label>
                                <label class="flex items-center px-3 py-1.5 bg-[#F3F4F6] hover:bg-[#E5E7EB] rounded-lg cursor-pointer transition-colors text-sm">
                                    <input type="checkbox" value="–ü—Ä–µ–º–∏—É–º" data-filter-type="object_class" class="text-[#0088CC] focus:ring-[#0088CC] border-gray-300 rounded mr-2" onchange="updateModalFilterCount();">
                                    <span class="text-[#111827]">–ü—Ä–µ–º–∏—É–º</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- –ó–∞—Å—Ç—Ä–æ–π—â–∏–∫ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫</label>
                            <div class="space-y-1 border border-gray-200 rounded-lg p-2" id="developers-mobile-modal">
                                <!-- Will be populated dynamically by loadDevelopers() -->
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
            
            <!-- Sticky Footer -->
            <div class="sticky bottom-0 bg-white border-t border-gray-200 p-4 md:rounded-b-2xl">
                <button id="modal-apply-filters" onclick="applyModalFilters()" class="w-full py-3 md:py-4 bg-[#0088CC] hover:bg-[#006699] text-white rounded-lg font-semibold transition-all text-base md:text-lg shadow-lg">
                    –ü–æ–∫–∞–∑–∞—Ç—å <span id="modal-filtered-count">0</span> <span id="modal-filtered-word">–æ–±—ä–µ–∫—Ç–æ–≤</span>
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

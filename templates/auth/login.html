{% extends "base.html" %}

{% block title %}Вход в личный кабинет | inback{% endblock %}

{% block content %}
<style>
    .gradient-bg {
        background: linear-gradient(135deg, #0088cc 0%, #32a4fb 100%);
    }
    
    .btn-ton {
        background: linear-gradient(135deg, #0088cc 0%, #32a4fb 100%);
        transition: all 0.3s ease;
    }
    
    .btn-ton:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 136, 204, 0.3);
    }
    
    .input-ton {
        border: 1px solid #e5e7eb;
        transition: all 0.3s ease;
    }
    
    .input-ton:focus {
        border-color: #0088cc;
        box-shadow: 0 0 0 3px rgba(0, 136, 204, 0.1);
    }
    
    .floating-card {
        animation: float 6s ease-in-out infinite;
    }
    
    @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
    }
</style>

<div class="relative overflow-hidden min-h-screen bg-gray-50">
    <!-- Decorative elements -->
    <div class="absolute top-0 left-0 w-full h-1 gradient-bg"></div>
    <div class="absolute top-20 -left-20 w-40 h-40 rounded-full bg-blue-500 opacity-10"></div>
    <div class="absolute bottom-20 -right-20 w-60 h-60 rounded-full bg-[#0088CC] opacity-10"></div>
    
    <div class="container mx-auto px-4 py-12">
        <div class="flex flex-col lg:flex-row items-center justify-center min-h-screen">
            <!-- Left side - Illustration and info -->
            <div class="hidden lg:block lg:w-1/2 lg:pr-12 mb-12 lg:mb-0 relative">
                <div class="max-w-md mx-auto">
                    <div class="flex items-center mb-8">
                        <div class="w-12 h-12 bg-gradient-to-r from-[#0088CC] to-[#006699] rounded-lg flex items-center justify-center text-white font-bold text-lg mr-4">In</div>
                        <h1 class="text-3xl font-bold bg-gradient-to-r from-[#0088CC] to-[#006699] bg-clip-text text-transparent">InBack</h1>
                    </div>
                    
                    <h2 class="text-4xl font-bold text-gray-800 mb-6 leading-tight">
                        Получайте кешбэк <span class="text-[#0088CC]">до 5%</span> при покупке новостроек
                    </h2>
                    
                    <p class="text-gray-600 mb-8 text-lg">
                        Зарегистрируйтесь и получайте возврат денег с каждой покупки недвижимости. Просто, надежно и выгодно.
                    </p>
                    
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-8 floating-card">
                        <div class="flex items-start">
                            <div class="bg-gray-100 p-3 rounded-lg mr-4">
                                <i class="fas fa-coins text-[#0088CC] text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-800 mb-2">Как это работает?</h3>
                                <p class="text-gray-600 text-sm">
                                    1. Зарегистрируйтесь в сервисе<br/>
                                    2. Получите подборку квартир и ЖК<br/>
                                    3. Посмотрите ЖК с менеджером сервиса<br/>
                                    4. Определитесь с квартирой<br/>
                                    5. Получите кешбэк за пользование сервисом
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap gap-4">
                        <div class="flex items-center bg-white px-4 py-2 rounded-lg shadow-sm">
                            <i class="fas fa-check-circle text-[#0088CC] mr-2"></i>
                            <span class="text-sm">Без скрытых условий</span>
                        </div>
                        <div class="flex items-center bg-white px-4 py-2 rounded-lg shadow-sm">
                            <i class="fas fa-shield-alt text-[#0088CC] mr-2"></i>
                            <span class="text-sm">Защита данных</span>
                        </div>
                        <div class="flex items-center bg-white px-4 py-2 rounded-lg shadow-sm">
                            <i class="fas fa-bolt text-[#0088CC] mr-2"></i>
                            <span class="text-sm">Мгновенные выплаты</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right side - Login form -->
            <div class="lg:w-1/2">
                <div class="bg-white rounded-2xl shadow-xl overflow-hidden max-w-md w-full mx-auto">
                    <div class="p-8">
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">Вход в личный кабинет</h3>
                        <p class="text-gray-500 mb-6">Введите номер телефона для продолжения</p>
                        
                        {% with messages = get_flashed_messages(with_categories=true) %}
                            {% if messages %}
                                {% for category, message in messages %}
                                    <div class="mb-4 p-4 rounded-lg {% if category == 'error' %}bg-red-50 text-red-700 border border-red-200{% else %}bg-green-50 text-green-700 border border-green-200{% endif %}">
                                        {{ message }}
                                    </div>
                                {% endfor %}
                            {% endif %}
                        {% endwith %}
                        
                        <!-- Login Form -->
                        <form id="login-form" method="POST" action="{{ url_for('login') }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            
                            <!-- Phone Input (Always visible) -->
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-medium mb-2" for="phone">
                                    Номер телефона
                                </label>
                                <div class="relative">
                                    <i class="fas fa-phone absolute left-3 top-3 text-gray-400"></i>
                                    <input 
                                        class="input-ton w-full pl-10 pr-4 py-3 rounded-lg border focus:outline-none" 
                                        id="phone" 
                                        name="phone" 
                                        placeholder="+7 (___) ___-__-__" 
                                        type="tel" 
                                        required
                                        autocomplete="tel"
                                    />
                                </div>
                            </div>
                            
                            <!-- Password Input (Hidden initially) -->
                            <div id="password-section" class="mb-4 hidden">
                                <label class="block text-gray-700 text-sm font-medium mb-2" for="password">
                                    Пароль
                                </label>
                                <div class="relative">
                                    <i class="fas fa-lock absolute left-3 top-3 text-gray-400"></i>
                                    <input 
                                        class="input-ton w-full pl-10 pr-4 py-3 rounded-lg border focus:outline-none" 
                                        id="password" 
                                        name="password" 
                                        placeholder="Введите пароль" 
                                        type="password" 
                                        autocomplete="current-password"
                                    />
                                </div>
                                <div class="mt-2 text-right">
                                    <a href="{{ url_for('forgot_password') }}" class="text-sm text-[#0088CC] hover:underline">
                                        Забыли пароль?
                                    </a>
                                </div>
                            </div>
                            
                            <!-- Not Registered Message (Hidden initially) -->
                            <div id="not-registered-section" class="hidden mb-4 p-4 rounded-lg bg-yellow-50 border border-yellow-200">
                                <p class="text-sm text-yellow-800">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    Номер не зарегистрирован. Создайте аккаунт, чтобы продолжить.
                                </p>
                            </div>
                            
                            <!-- Continue/Login Button -->
                            <button 
                                type="button" 
                                id="continue-btn"
                                class="btn-ton w-full py-3 px-4 rounded-lg text-white font-medium mb-4"
                            >
                                Продолжить
                            </button>
                            
                            <!-- Login Button (Hidden initially) -->
                            <button 
                                type="submit" 
                                id="login-btn"
                                class="btn-ton w-full py-3 px-4 rounded-lg text-white font-medium mb-4 hidden"
                            >
                                Войти
                            </button>
                            
                            <!-- Register Button (Hidden initially) -->
                            <button 
                                type="button" 
                                id="register-btn"
                                onclick="window.location.href='{{ url_for('register') }}'"
                                class="btn-ton w-full py-3 px-4 rounded-lg text-white font-medium mb-4 hidden"
                            >
                                Зарегистрироваться
                            </button>
                            
                            <!-- Change Phone Link (Hidden initially) -->
                            <button 
                                type="button" 
                                id="change-phone-btn"
                                class="w-full py-2 text-sm text-gray-500 hover:text-[#0088CC] hidden"
                            >
                                Изменить номер телефона
                            </button>
                        </form>
                        
                        <div class="mt-6 text-center">
                            <p class="text-sm text-gray-600">
                                Нет аккаунта? 
                                <a href="{{ url_for('register') }}" class="text-[#0088CC] hover:text-[#006699] font-medium">
                                    Зарегистрируйтесь
                                </a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Manager Login Link -->
        <div class="text-center mt-6">
            <a href="{{ url_for('manager_login') }}" class="text-sm text-gray-500 hover:text-[#0088cc] font-medium">
                <i class="fas fa-user-tie mr-1"></i>
                Вход для менеджеров
            </a>
        </div>
    </div>
</div>

<script>
// Login Form Handlers
document.addEventListener('DOMContentLoaded', function() {
    const phoneInput = document.getElementById('phone');
    const passwordSection = document.getElementById('password-section');
    const passwordInput = document.getElementById('password');
    const notRegisteredSection = document.getElementById('not-registered-section');
    const continueBtn = document.getElementById('continue-btn');
    const loginBtn = document.getElementById('login-btn');
    const registerBtn = document.getElementById('register-btn');
    const changePhoneBtn = document.getElementById('change-phone-btn');
    const loginForm = document.getElementById('login-form');
    
    let phoneChecked = false;
    let userExists = false;
    
    // Format phone number
    phoneInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.startsWith('8')) value = '7' + value.slice(1);
        if (!value.startsWith('7')) value = '7' + value;
        
        const parts = [];
        if (value.length > 0) parts.push('+7');
        if (value.length > 1) parts.push(` (${value.slice(1, 4)}`);
        if (value.length >= 4) parts.push(`) ${value.slice(4, 7)}`);
        if (value.length >= 7) parts.push(`-${value.slice(7, 9)}`);
        if (value.length >= 9) parts.push(`-${value.slice(9, 11)}`);
        
        e.target.value = parts.join('');
        
        // Reset state when phone changes
        if (phoneChecked) {
            resetForm();
        }
    });
    
    // Reset form to initial state
    function resetForm() {
        phoneChecked = false;
        userExists = false;
        passwordSection.classList.add('hidden');
        notRegisteredSection.classList.add('hidden');
        continueBtn.classList.remove('hidden');
        loginBtn.classList.add('hidden');
        registerBtn.classList.add('hidden');
        changePhoneBtn.classList.add('hidden');
        phoneInput.disabled = false;
        passwordInput.value = '';
    }
    
    // Check phone existence
    continueBtn.addEventListener('click', async function() {
        const phone = phoneInput.value.replace(/\D/g, '');
        
        if (phone.length !== 11 || !phone.startsWith('7')) {
            alert('Введите корректный номер телефона');
            return;
        }
        
        const normalizedPhone = '+' + phone;
        continueBtn.disabled = true;
        continueBtn.textContent = 'Проверка...';
        
        try {
            const csrfToken = document.querySelector('[name="csrf_token"]').value;
            const response = await fetch('/api/check-phone', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ phone: normalizedPhone, csrf_token: csrfToken })
            });
            
            const data = await response.json();
            
            if (data.status === 200) {
                phoneChecked = true;
                userExists = data.exists;
                phoneInput.disabled = true;
                continueBtn.classList.add('hidden');
                changePhoneBtn.classList.remove('hidden');
                
                if (userExists) {
                    // Show password field and login button
                    passwordSection.classList.remove('hidden');
                    loginBtn.classList.remove('hidden');
                    passwordInput.focus();
                } else {
                    // Show not registered message and register button
                    notRegisteredSection.classList.remove('hidden');
                    registerBtn.classList.remove('hidden');
                }
            } else {
                alert(data.error || 'Ошибка проверки номера');
                continueBtn.disabled = false;
                continueBtn.textContent = 'Продолжить';
            }
        } catch (error) {
            console.error('Error checking phone:', error);
            alert('Ошибка соединения. Попробуйте позже.');
            continueBtn.disabled = false;
            continueBtn.textContent = 'Продолжить';
        }
    });
    
    // Change phone button
    changePhoneBtn.addEventListener('click', function() {
        resetForm();
        phoneInput.focus();
    });
    
    // Form submission
    loginForm.addEventListener('submit', function(e) {
        if (!userExists || !phoneChecked) {
            e.preventDefault();
            alert('Сначала проверьте номер телефона');
        }
    });
});
</script>

{% endblock %}
